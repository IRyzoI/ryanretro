<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Compatibility | Ryan Retro</title>

  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://unpkg.com/aos@2.3.1/dist/aos.css" rel="stylesheet"/>
  <script src="https://unpkg.com/aos@2.3.1/dist/aos.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/feather-icons/dist/feather.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>

  <link rel="preconnect" href="https://i.ytimg.com" crossorigin>
  <link rel="preconnect" href="https://www.googleapis.com" crossorigin>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link rel="preconnect" href="https://huggingface.co" crossorigin>
  <link rel="dns-prefetch" href="//huggingface.co">
  <link rel="icon" href="data:,">

  <style>
    @import url('https://fonts.googleapis.com/css2?family=Press+Start+2P&family=Roboto:wght@400;700&display=swap');

    /* --- NEW HEADER & MENU STYLES --- */
    :root {
      /* GAMEBOY COLORS */
      --gb-grey: #e0e0e0;
      --gb-dark-grey: #c4c4c4;
    }
    
    body.dark-mode {
      --gb-grey: #4b5563;
      --gb-dark-grey: #111827;
    }
    
    /* Dark Mode Overrides for Header */
    body.dark-mode header {
        background-color: var(--gb-grey) !important;
        border-color: var(--gb-dark-grey) !important;
    }
    body.dark-mode .nav-item:hover {
        background-color: #dc2626 !important; /* Red-600 */
        color: white !important;
    }

    .retro-font { font-family: 'Press Start 2P', cursive; }
    
    /* Shared Retro Styles */
    .pixel-border { border: 4px solid #000; box-shadow: 8px 8px 0 rgba(0,0,0,0.2); }
    .pixel-btn { transition: all 0.1s ease; }
    .pixel-btn:active { transform: translate(2px, 2px); box-shadow: 2px 2px 0 rgba(0,0,0,0.2); }

    /* Performance Colors */
    .perf-perfect, .status-perfect { color: #4ade80; }
    .perf-great, .status-great { color: #38bdf8; }
    .perf-playable, .status-playable { color: #fb923c; }
    .perf-unplayable, .status-unplayable { color: #f87171; }

    /* Table & Form */
    #compatibility-table thead th { position: sticky; top: 0; z-index: 10; }

    .form-input {
      background-color: #374151; border: 2px solid #1f2937; border-radius: .25rem;
      padding: .5rem .75rem; color: #d1d5db; width: 100%; transition: border-color .2s;
    }
    .form-input:focus { outline: none; border-color: #facc15; }

    .custom-scrollbar::-webkit-scrollbar { height: 8px; }
    .custom-scrollbar::-webkit-scrollbar-track { background: #1f2937; border-radius: 10px; }
    .custom-scrollbar::-webkit-scrollbar-thumb { background: #4b5563; border-radius: 10px; }
    .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: #6b7280; }

    select.form-input.perf-perfect    { background-color: rgba(74, 222, 128, .10); }
    select.form-input.perf-great      { background-color: rgba(56, 189, 248, .10); }
    select.form-input.perf-playable   { background-color: rgba(251, 146, 60, .10); }
    select.form-input.perf-unplayable { background-color: rgba(248, 113, 113, .10); }

    .island { content-visibility: auto; contain-intrinsic-size: 800px; }

    /* Active filter state */
    .filter-active { outline: 2px solid white; box-shadow: 0 0 10px rgba(255,255,255,0.5); }

    /* Header Responsive Fixes */
    @media (max-width: 768px) {
      .header-container { flex-direction: column; gap: 0.25rem; }
    }
  </style>
</head>

<body class="bg-gray-900 text-white font-sans overflow-x-hidden dark-mode">

  <div id="navOverlay" class="fixed inset-0 z-[100] hidden bg-black/80 backdrop-blur-sm flex items-start justify-start p-4">
      <div class="absolute inset-0" onclick="toggleNav()"></div>
      
      <div class="bg-gray-200 border-4 border-gray-400 rounded-lg p-1 w-64 max-w-full shadow-2xl relative mt-16 ml-0 md:ml-4 transform transition-all duration-200 scale-95 opacity-0 flex flex-col gap-1" id="navBox">
          
          <div class="bg-gray-800 text-white p-2 mb-1 flex justify-between items-center border-b-2 border-black">
              <span class="retro-font text-xs">PAUSE MENU</span>
              <button onclick="toggleNav()" class="text-white hover:text-red-400">
                  <i data-feather="x" class="w-4 h-4"></i>
              </button>
          </div>

          <div class="flex flex-col gap-1" id="navLinksList">
              <a href="benchmarks.html" class="nav-item flex items-center justify-between px-4 py-3 bg-white border-2 border-transparent hover:border-black hover:bg-red-600 hover:text-white cursor-pointer group transition-colors">
                  <span class="retro-font text-[10px] text-gray-800 group-hover:text-white">BENCHMARKS</span>
                  <i data-feather="cpu" class="w-4 h-4 text-gray-400 group-hover:text-white"></i>
              </a>

              <a href="handheld.html" class="nav-item flex items-center justify-between px-4 py-3 bg-white border-2 border-transparent hover:border-black hover:bg-red-600 hover:text-white cursor-pointer group transition-colors">
                  <span class="retro-font text-[10px] text-gray-800 group-hover:text-white">HANDHELDS</span>
                  <i data-feather="smartphone" class="w-4 h-4 text-gray-400 group-hover:text-white"></i>
              </a>

              <a href="index.html" class="nav-item flex items-center justify-between px-4 py-3 bg-white border-2 border-transparent hover:border-black hover:bg-red-600 hover:text-white cursor-pointer group transition-colors">
                  <span class="retro-font text-[10px] text-gray-800 group-hover:text-white">HOME</span>
                  <i data-feather="home" class="w-4 h-4 text-gray-400 group-hover:text-white"></i>
              </a>

              <a href="patrons.html" class="nav-item flex items-center justify-between px-4 py-3 bg-white border-2 border-transparent hover:border-black hover:bg-red-600 hover:text-white cursor-pointer group transition-colors">
                  <span class="retro-font text-[10px] text-gray-800 group-hover:text-white">PATRONS</span>
                  <i data-feather="users" class="w-4 h-4 text-gray-400 group-hover:text-white"></i>
              </a>

              <a href="shop.html" class="nav-item flex items-center justify-between px-4 py-3 bg-white border-2 border-transparent hover:border-black hover:bg-red-600 hover:text-white cursor-pointer group transition-colors">
                  <span class="retro-font text-[10px] text-gray-800 group-hover:text-white">STORE</span>
                  <i data-feather="shopping-cart" class="w-4 h-4 text-gray-400 group-hover:text-white"></i>
              </a>
          </div>
          
          <div class="h-0.5 bg-gray-400 my-1"></div>

          <div id="darkModeToggle" class="nav-item flex items-center justify-between px-4 py-3 bg-white border-2 border-transparent hover:border-black hover:bg-gray-800 hover:text-white cursor-pointer group transition-colors">
               <span class="retro-font text-[10px] text-gray-800 group-hover:text-white">SWITCH THEME</span>
               <i data-feather="sun" class="w-4 h-4 text-gray-400 group-hover:text-white" id="themeIcon"></i>
          </div>

          <div class="mt-1 text-center pb-1">
              <span class="text-[8px] retro-font text-gray-500">SELECT OPTION</span>
          </div>
      </div>
  </div>

  <header class="bg-gray-100 py-3 md:py-6 border-b-4 border-gray-400 shadow-md transition-colors duration-300 relative z-50">
  <div class="container mx-auto px-4 flex flex-col md:flex-row items-center justify-between header-container gap-4">
    
    <div class="flex items-center gap-4 w-full md:w-auto justify-between md:justify-start">
        
        <button id="navToggle" class="p-3 bg-gray-800 text-white hover:bg-gray-700 rounded pixel-btn border-2 border-black shadow-[2px_2px_0_0_rgba(0,0,0,0.2)] flex items-center justify-center gap-2 group">
            <i data-feather="menu" class="w-5 h-5 group-hover:scale-110 transition-transform"></i>
            <span class="retro-font text-[10px] hidden md:block">MENU</span>
        </button>

        <a href="index.html" class="flex items-center gap-3 md:gap-4">
            <img src="https://huggingface.co/spaces/IRyzoI/RyanRetro/resolve/main/images/ryan%20retro%20logo.png"
                class="w-10 h-10 md:w-16 md:h-16 rounded-full border-4 border-gray-400 bg-gray-200" alt="Ryan Retro Logo">
            <div class="flex flex-col">
                <h1 class="retro-font text-sm md:text-xl text-gray-800 leading-tight">RYAN'S STORE</h1>
                <span class="retro-font text-[8px] text-gray-500 uppercase">Affiliate Links</span>
            </div>
        </a>
    </div>

    <div class="flex flex-col md:flex-row items-center gap-4 w-full md:w-auto order-3 md:order-3 mt-2 md:mt-0">
      
      <button id="openFlashDealsBtn"
              class="px-3 py-2 md:py-4 md:px-4 bg-yellow-400 hover:bg-yellow-300 text-black rounded pixel-btn retro-font text-[10px] md:text-xs uppercase border-2 border-black flex items-center justify-center gap-2 shadow-[2px_2px_0_0_rgba(0,0,0,0.2)] w-full md:w-auto hidden">
          <i data-feather="zap" class="w-4 h-4 md:w-5 md:h-5"></i>
          <span>DEALS</span>
      </button>

      <div class="border-2 border-gray-400 rounded p-2 pt-4 relative group bg-white w-full md:w-auto flex justify-center">
        <span class="absolute -top-2.5 left-1/2 -translate-x-1/2 bg-gray-100 px-2 text-[8px] text-gray-500 retro-font uppercase tracking-widest rounded border border-gray-300 whitespace-nowrap z-10">
          FIND ME
        </span>
        <div class="flex items-center justify-center gap-2 md:gap-3 flex-wrap">
           <a href="https://www.youtube.com/@RyanRetro" target="_blank" class="w-8 h-8 md:w-10 md:h-10 bg-[#FF0000] text-white rounded pixel-btn border-2 border-black flex items-center justify-center hover:-translate-y-1 transition-transform shadow-[2px_2px_0_0_rgba(0,0,0,0.2)]" title="YouTube">
             <i data-feather="youtube" class="w-4 h-4 md:w-5 md:h-5"></i>
           </a>
           <a href="https://www.instagram.com/ryanretroyoutube/" target="_blank" class="w-8 h-8 md:w-10 md:h-10 bg-gradient-to-tr from-yellow-400 via-red-500 to-purple-500 text-white rounded pixel-btn border-2 border-black flex items-center justify-center hover:-translate-y-1 transition-transform shadow-[2px_2px_0_0_rgba(0,0,0,0.2)]" title="Instagram">
             <i data-feather="instagram" class="w-4 h-4 md:w-5 md:h-5"></i>
           </a>
           <a href="https://www.tiktok.com/@ryanretroyoutube" target="_blank" class="w-8 h-8 md:w-10 md:h-10 bg-black text-white rounded pixel-btn border-2 border-black flex items-center justify-center hover:-translate-y-1 transition-transform shadow-[2px_2px_0_0_rgba(0,0,0,0.2)]" title="TikTok">
             <svg class="w-4 h-4 md:w-5 md:h-5 fill-current" viewBox="0 0 24 24"><path d="M19.59 6.69a4.83 4.83 0 0 1-3.77-4.25V2h-3.45v13.67a2.89 2.89 0 0 1-5.2 1.74 2.89 2.89 0 0 1 2.31-4.64 2.93 2.93 0 0 1 .88.13V9.4a6.84 6.84 0 0 0-1-.05A6.33 6.33 0 0 0 5 20.1a6.34 6.34 0 0 0 10.86-4.43v-7a8.16 8.16 0 0 0 4.77 1.52v-3.4a4.85 4.85 0 0 1-1-.1z"/></svg>
           </a>
           <a href="https://discord.gg/RAenS43UV9" target="_blank" class="w-8 h-8 md:w-10 md:h-10 bg-[#5865F2] text-white rounded pixel-btn border-2 border-black flex items-center justify-center hover:-translate-y-1 transition-transform shadow-[2px_2px_0_0_rgba(0,0,0,0.2)]" title="Discord">
             <svg class="w-4 h-4 md:w-5 md:h-5 fill-current" viewBox="0 0 24 24"><path d="M20.317 4.37a19.791 19.791 0 0 0-4.885-1.515.074.074 0 0 0-.079.037 13.56 13.56 0 0 0-1.04 2.135 18.237 18.237 0 0 0-4.613 0 13.562 13.562 0 0 0-1.04-2.135.071.071 0 0 0-.079-.037A19.736 19.736 0 0 0 3.67 4.37a.069.069 0 0 0-.032.027C.533 9.046-.32 13.58.099 18.057a.082.082 0 0 0 .031.057 19.9 19.9 0 0 0 5.993 3.03.078.078 0 0 0 .084-.028 14.09 14.09 0 0 0 1.226-1.994.076.076 0 0 0-.041-.106 13.107 13.107 0 0 1-1.872-.892.077.077 0 0 1-.008-.128 10.2 10.2 0 0 0 .372-.292.074.074 0 0 1 .077-.01c3.928 1.793 8.18 1.793 12.062 0a.074.074 0 0 1 .078.01c.12.098.246.198.373.292a.077.077 0 0 1-.006.127 12.299 12.299 0 0 1-1.873.892.077.077 0 0 0-.041.107c.36.698.772 1.362 1.225 1.993a.076.076 0 0 0 .084.028 19.839 19.839 0 0 0 6.002-3.03.077.077 0 0 0 .032-.054c.5-5.177-.838-9.674-3.549-13.66a.061.061 0 0 0-.031-.03zM8.02 15.33c-1.183 0-2.157-1.085-2.157-2.419 0-1.333.956-2.419 2.157-2.419 1.21 0 2.176 1.096 2.157 2.42 0 1.333-.956 2.418-2.157 2.418zm7.975 0c-1.183 0-2.157-1.085-2.157-2.419 0-1.333.955-2.419 2.157-2.419 1.21 0 2.176 1.096 2.157 2.42 0 1.333-.946 2.418-2.157 2.418z"/></svg>
           </a>
           <a href="https://www.threads.com/@ryanretroyoutube" target="_blank" class="w-8 h-8 md:w-10 md:h-10 bg-black text-white rounded pixel-btn border-2 border-black flex items-center justify-center hover:-translate-y-1 transition-transform shadow-[2px_2px_0_0_rgba(0,0,0,0.2)]" title="Threads">
             <svg class="w-4 h-4 md:w-5 md:h-5 fill-current" viewBox="0 0 24 24"><path d="M12.673 13.929C13.22 13.784 13.6 13.313 13.6 12.383C13.6 11.233 12.793 10.237 11.411 10.237C10.026 10.237 9.173 11.196 9.173 12.376C9.173 13.504 9.947 14.542 11.455 14.542C12.062 14.542 12.592 14.364 13.064 14.074L13.805 15.65C13.085 16.037 12.222 16.223 11.366 16.223C8.619 16.223 6.9 14.475 6.9 12.285C6.9 9.808 8.922 7.788 11.751 7.788C14.717 7.788 16.275 9.778 16.275 12.441C16.275 12.695 16.262 12.98 16.241 13.235H18.455C18.486 12.964 18.503 12.69 18.503 12.412C18.503 8.356 15.789 5.6 11.751 5.6C8.016 5.6 5.093 8.441 5.093 12.424C5.093 16.19 7.973 18.995 11.666 18.995C13.565 18.995 15.304 18.366 16.804 17.214L18.156 18.941C16.326 20.404 14.025 21.183 11.621 21.183C6.732 21.183 2.8 17.29 2.8 12.424C2.8 7.378 6.945 3.4 11.751 3.4C17.078 3.4 20.73 7.03 20.73 12.412C20.73 18.81 16.355 20.45 14.546 20.45C13.513 20.45 12.69 20.089 12.33 19.347H12.274L11.838 20.795H9.727L10.96 16.666C10.741 15.862 10.638 15.008 10.638 14.288H12.75C12.75 14.162 12.695 14.053 12.673 13.929Z"/></svg>
           </a>
           <a href="https://x.com/RyanRetroYT" target="_blank" class="w-8 h-8 md:w-10 md:h-10 bg-black text-white rounded pixel-btn border-2 border-black flex items-center justify-center hover:-translate-y-1 transition-transform shadow-[2px_2px_0_0_rgba(0,0,0,0.2)]" title="X (Twitter)">
             <svg class="w-4 h-4 md:w-5 md:h-5 fill-current" viewBox="0 0 24 24"><path d="M18.244 2.25h3.308l-7.227 8.26 8.502 11.24H16.17l-5.214-6.817L4.99 21.75H1.68l7.73-8.835L1.254 2.25H8.08l4.713 6.231zm-1.161 17.52h1.833L7.084 4.126H5.117z"/></svg>
           </a>
        </div>
      </div>

      <div class="border-2 border-gray-400 rounded p-2 pt-4 relative group bg-white w-full md:w-auto flex justify-center mt-2 md:mt-0">
        <span class="absolute -top-2.5 left-1/2 -translate-x-1/2 bg-gray-100 px-2 text-[8px] text-gray-500 retro-font uppercase tracking-widest flex items-center gap-1 rounded border border-gray-300 whitespace-nowrap z-10">
          SUPPORT ME <i data-feather="heart" class="w-3 h-3 text-red-500 fill-red-500 animate-pulse"></i>
        </span>
        <a href="https://patreon.com/ryanretro" target="_blank" rel="noopener noreferrer"
           class="px-4 py-1.5 md:py-2 bg-[#f96854] hover:bg-[#ff8e7d] text-white rounded pixel-btn retro-font text-[10px] md:text-xs uppercase border-2 border-black flex items-center justify-center gap-2 w-full transition-transform hover:scale-105 shadow-[2px_2px_0_0_rgba(0,0,0,0.2)]">
          <svg class="w-4 h-4 md:w-5 md:h-5 fill-current" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
            <path d="M0 .48v23.04h4.22V.48zm15.385 0c-4.764 0-8.641 3.88-8.641 8.65 0 4.755 3.877 8.623 8.641 8.623 4.75 0 8.615-3.868 8.615-8.623C24 4.36 20.136.48 15.385.48z"/>
          </svg>
          <span class="tracking-tight">JOIN PATREON</span>
        </a>
      </div>
    </div>
  </div>
</header>

  <main class="py-12">
    <div class="mx-auto w-full max-w-[1900px] px-2 sm:px-4">
      <div class="max-w-full mx-auto">
        <div class="flex items-center mb-8">
          <span class="bg-red-500 text-black text-xs px-2 py-1 rounded retro-font mr-4">HANDHELD</span>
          <h1 id="device-heading" class="retro-font text-3xl md:text-4xl">Device</h1>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-3 gap-8 mb-12">
          <div class="md:col-span-2" data-aos="fade-right">
            <div class="bg-gray-800 rounded-lg overflow-hidden pixel-border h-full p-4 relative group hover:border-gray-500 transition-colors duration-300">
               <a id="hero-link" href="#" target="_blank" class="flex w-full h-full items-center justify-center">
                  <img id="hero-img" src="" alt="Device" class="w-full h-auto object-contain transition-transform duration-300 group-hover:scale-105" decoding="async" fetchpriority="high">
               </a>
            </div>
          </div>

          <div id="sidebar-panel"
               class="md:col-span-1 bg-gray-800 p-8 rounded-lg pixel-border flex flex-col" data-aos="fade-left">
            <div id="cta-buttons" class="flex flex-col gap-4 h-full">
              <a id="affiliate-link" href="#" target="_blank"
                 class="group flex-grow bg-green-600 hover:bg-green-700 text-white px-4 rounded pixel-btn retro-font text-sm md:text-base
                        flex items-center justify-center transition-transform hover:scale-105 hover:-translate-y-1">
                <i data-feather="shopping-cart" class="mr-2 w-5 h-5 transition-transform group-hover:scale-110"></i>
                <span class="btn-label">PURCHASE</span>
              </a>

              <a id="videos-link" href="#" target="_blank"
                 class="group flex-grow bg-red-600 hover:bg-red-700 text-white px-4 rounded pixel-btn retro-font text-sm md:text-base flex items-center justify-center transition-transform hover:scale-105 hover:-translate-y-1">
                <i data-feather="youtube" class="mr-2 w-5 h-5 transition-transform group-hover:scale-110"></i> VIDEOS
              </a>
              <a id="review-or-compat-link"
                 href="#compatibility"
                 class="group flex-grow bg-blue-600 hover:bg-blue-700 text-white px-4 rounded pixel-btn retro-font text-sm md:text-base flex items-center justify-center transition-transform hover:scale-105 hover:-translate-y-1">
                <i data-feather="list" class="mr-2 w-5 h-5 transition-transform group-hover:scale-110"></i>
                <span id="review-or-compat-label">PLAY GAMES</span>
              </a>

              <a href="/benchmarks"
                 class="group flex-grow bg-purple-600 hover:bg-purple-700 text-white px-4 rounded pixel-btn retro-font text-sm md:text-base flex items-center justify-center transition-transform hover:scale-105 hover:-translate-y-1">
                <i data-feather="bar-chart-2" class="mr-2 w-5 h-5 transition-transform group-hover:scale-110"></i> BENCHMARKS
              </a>
            </div>
          </div>
        </div>

        <section id="videos-section" class="mb-12 island">
          <h2 class="retro-font text-2xl mb-6">Videos</h2>
          <div id="videos-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8">
            <p class="md:col-span-3">Loading videos...</p>
          </div>
        </section>

        <div id="compatibility" class="bg-gray-800 p-8 rounded-lg pixel-border mb-12 island">
          <h2 class="retro-font text-2xl mb-6">Game Compatibility</h2>

          <div id="variant-tabs" class="mb-4 hidden">
            <div class="inline-flex flex-wrap gap-2"></div>
          </div>

          <div id="system-buttons" class="mb-4 flex flex-wrap gap-2">
            <button data-system="switch"    class="system-btn bg-yellow-400 text-black px-4 py-2 rounded-md retro-font text-xs">Switch</button>
            <button data-system="ps2"       class="system-btn bg-gray-600 hover:bg-gray-500 text-white px-4 py-2 rounded-md retro-font text-xs">PS2</button>
            <button data-system="ps3"       class="system-btn bg-gray-600 hover:bg-gray-500 text-white px-4 py-2 rounded-md retro-font text-xs">PS3</button>
            <button data-system="psvita"    class="system-btn bg-gray-600 hover:bg-gray-500 text-white px-4 py-2 rounded-md retro-font text-xs">PS Vita</button>
            <button data-system="winlator" class="system-btn bg-gray-600 hover:bg-gray-500 text-white px-4 py-2 rounded-md retro-font text-xs">Winlator</button>
            <button data-system="gamehub"  class="system-btn bg-gray-600 hover:bg-gray-500 text-white px-4 py-2 rounded-md retro-font text-xs">GameHub</button>
            <button data-system="wiiu"     class="system-btn bg-gray-600 hover:bg-gray-500 text-white px-4 py-2 rounded-md retro-font text-xs">Wii U</button>
          </div>

          <div id="perf-filters" class="mb-3 flex flex-wrap gap-2 text-xs">
            <button data-perf=""            class="px-2 py-1 rounded bg-gray-700 hover:bg-gray-600 border border-transparent filter-active">All</button>
            <button data-perf="Perfect"     class="px-2 py-1 rounded bg-gray-700 hover:bg-gray-600 perf-perfect font-bold border border-transparent">Perfect</button>
            <button data-perf="Great"       class="px-2 py-1 rounded bg-gray-700 hover:bg-gray-600 perf-great font-bold border border-transparent">Great</button>
            <button data-perf="Playable"    class="px-2 py-1 rounded bg-gray-700 hover:bg-gray-600 perf-playable font-bold border border-transparent">Playable</button>
            <button data-perf="Unplayable" class="px-2 py-1 rounded bg-gray-700 hover:bg-gray-600 perf-unplayable font-bold border border-transparent">Unplayable</button>
          </div>

          <div class="mb-6 flex flex-col md:flex-row gap-4">
            <div class="flex-grow">
              <input type="text" id="game-search-box" class="form-input" placeholder="Search for a game...">
            </div>
            <div class="flex items-center justify-end gap-2">
              <label for="rows-per-page" class="text-sm font-bold text-gray-400">Rows:</label>
              <select id="rows-per-page" class="bg-gray-700 text-white border border-gray-600 rounded px-2 py-2 text-sm focus:outline-none focus:border-yellow-400">
                <option value="10" selected>10</option>
                <option value="20">20</option>
                <option value="50">50</option>
                <option value="100">100</option>
              </select>
            </div>
          </div>

          <div class="overflow-x-auto custom-scrollbar">
            <table id="compatibility-table" class="min-w-full text-sm text-left text-gray-300">
              <thead class="bg-gray-700 text-gray-100 retro-font text-xs uppercase tracking-wider cursor-pointer"></thead>
              <tbody class="divide-y divide-gray-700 align-baseline"></tbody>
            </table>
          </div>
        </div>

        <div id="pagination-controls" class="mt-6 flex items-center justify-center gap-4">
          <button id="prev-btn" class="bg-gray-600 hover:bg-gray-500 text-white px-4 py-2 rounded-md retro-font text-xs disabled:opacity-50" disabled>Previous</button>
          <span id="page-info" class="retro-font text-sm text-yellow-400">Page 1 of 1</span>
          <button id="next-btn" class="bg-gray-600 hover:bg-gray-500 text-white px-4 py-2 rounded-md retro-font text-xs disabled:opacity-50" disabled>Next</button>
        </div>

        <div class="text-center mt-6">
          <button id="add-entry-btn" class="bg-yellow-400 hover:bg-yellow-500 text-black px-6 py-3 rounded retro-font">
            ADD YOUR ENTRY
          </button>
        </div>

        <div id="add-entry-form-container" class="bg-gray-800 p-8 rounded-lg pixel-border mb-12 hidden mt-8" data-aos="fade-up">
          <h2 class="retro-font text-2xl mb-6 text-yellow-400">Add New Compatibility Entry</h2>

          <form id="compatibility-form">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
              <div>
                <label for="form-system-select" class="block mb-2 font-bold">System *</label>
                <select id="form-system-select" class="form-input" required>
                  <option value="switch">Nintendo Switch</option>
                  <option value="ps2">PlayStation 2</option>
                  <option value="ps3">PlayStation 3</option>
                  <option value="psvita">PlayStation Vita</option>
                  <option value="winlator">Winlator</option>
                  <option value="gamehub">GameHub</option>
                  <option value="wiiu">Wii U</option>
                </select>
              </div>
            </div>

            <div id="dynamic-fields" class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6"></div>

            <div class="mb-6">
              <label for="notes" class="block mb-2 font-bold">Notes (optional)</label>
              <textarea id="notes" name="notes" rows="3" class="form-input" placeholder="Extra context, settings, caveats..."></textarea>
            </div>

            <input type="hidden" id="hidden-device" name="device" value="">
            <input type="hidden" id="hidden-system" name="system" value="switch">

            <div class="flex items-center justify-end gap-4">
              <button type="button" id="cancel-btn" class="bg-gray-600 hover:bg-gray-500 text-white px-6 py-3 rounded retro-font">CANCEL</button>
              <button type="submit" class="bg-green-500 hover:bg-green-600 text-black px-6 py-3 rounded retro-font">SUBMIT</button>
            </div>
          </form>
        </div>

      </div>
    </div>
  </main>

  <footer class="bg-black py-8 mt-20 border-t-4 border-gray-800">
    <div class="container mx-auto px-4 text-center text-gray-500 text-xs retro-font">
      <p>Links may be affiliate links. I earn a small commission at no extra cost to you.</p>
      <p class="mt-2">Â© 2025 Ryan Retro</p>
    </div>
  </footer>

<script>
// --- NAVIGATION & DARK MODE LOGIC ---
const navToggle = document.getElementById('navToggle');
const navOverlay = document.getElementById('navOverlay');
const navBox = document.getElementById('navBox');
const body = document.body;
const darkModeToggle = document.getElementById('darkModeToggle');
const themeIcon = document.getElementById('themeIcon');

// Navigation Toggle
window.toggleNav = () => {
    const isHidden = navOverlay.classList.contains('hidden');
    if (isHidden) {
        navOverlay.classList.remove('hidden');
        setTimeout(() => {
            navBox.classList.remove('scale-95', 'opacity-0');
            navBox.classList.add('scale-100', 'opacity-100');
        }, 10);
    } else {
        navBox.classList.remove('scale-100', 'opacity-100');
        navBox.classList.add('scale-95', 'opacity-0');
        setTimeout(() => {
            navOverlay.classList.add('hidden');
        }, 200);
    }
};

navToggle.addEventListener('click', toggleNav);

// Auto-Highlight Active Page
const currentPath = window.location.pathname.split('/').pop() || 'index.html';
document.querySelectorAll('.nav-item').forEach(link => {
    const href = link.getAttribute('href');
    if (href === currentPath) {
        // Highlight style: Red background + White Text
        link.classList.add('bg-red-600', 'border-black', 'text-white');
        link.classList.remove('border-transparent', 'bg-white');
        link.querySelector('span').classList.add('text-white', 'text-gray-800');
        link.querySelector('i').classList.add('text-white');
        link.querySelector('i').classList.remove('text-gray-400');
    }
});

// Dark Mode Toggle Logic
// Default is set to DARK via HTML class.
if (localStorage.getItem('theme') === 'light') {
    body.classList.remove('dark-mode');
    themeIcon.setAttribute('data-feather', 'moon');
} else {
    body.classList.add('dark-mode');
    themeIcon.setAttribute('data-feather', 'sun');
}

darkModeToggle.addEventListener('click', () => {
    body.classList.toggle('dark-mode');
    if (body.classList.contains('dark-mode')) {
        localStorage.setItem('theme', 'dark');
        themeIcon.setAttribute('data-feather', 'sun');
    } else {
        localStorage.setItem('theme', 'light');
        themeIcon.setAttribute('data-feather', 'moon');
    }
    feather.replace();
});

/* --------------------------- Device config --------------------------- */
const DEVICE_CONFIG = {
  "Retroid Pocket 5": {
    label: "Retroid Pocket 5",
    heroImg: "https://huggingface.co/spaces/IRyzoI/RyanRetro/resolve/main/images/rp5.png",
    affiliateHref: "https://www.goretroid.com/products/retroid-pocket-5-handheld?sca_ref=7339476.fIz7oKv7oKv7uT",
    affiliateText: "PURCHASE",
    youtubeChannelId: "UCh9GxjM-FNuSWv7xqn3UKVw",
    youtubeQuery: "retroid pocket 5",
    videosLinkHref: "https://www.youtube.com/@RyanRetro/search?query=retroid%20pocket%205",
    aliases: ["Retroid Pocket5","RP5"],
    variants: [{ id: "sd865", label: "Snapdragon 865" }]
  },

  "Retroid Pocket 6": {
    label: "Retroid Pocket 6",
    heroImg: "https://huggingface.co/spaces/IRyzoI/RyanRetro/resolve/main/images/rp6.png",
    affiliateHref: "https://www.goretroid.com/collections/retro-game-system/products/retroid-pocket-6-handheld?sca_ref=7339476.fIz7oKv7uT",
    affiliateText: "PURCHASE",
    youtubeChannelId: "UCh9GxjM-FNuSWv7xqn3UKVw",
    youtubeQuery: "retroid pocket 6",
    videosLinkHref: "https://www.youtube.com/@RyanRetro/search?query=retroid%20pocket%206",
    aliases: ["Retroid 6","RP6","Retroid Pocket6"],
    variants: [{ id: "sd8g2", label: "Snapdragon 8 Gen 2", pullsFrom: ["Odin 2 Portal", "Odin 2", "Odin 2 Mini", "AYN Thor"] }]
  },

  "Retroid Pocket G2": {
    label: "Retroid Pocket G2",
    heroImg: "https://huggingface.co/spaces/IRyzoI/RyanRetro/resolve/main/images/device_retroid-pocket-g2-01.png",
    affiliateHref: "https://www.goretroid.com/products/retroid-pocket-g2-handheld?sca_ref=7339476.fIz7oKv7uT",
    affiliateText: "PURCHASE",
    youtubeChannelId: "UCh9GxjM-FNuSWv7xqn3UKVw",
    youtubeQuery: "retroid pocket g2",
    videosLinkHref: "https://www.youtube.com/@RyanRetro/search?query=retroid%20pocket%20g2",
    aliases: ["Retroid G2", "RP G2", "Retroid Pocket G2"],
    variants: [{ id: "g2g2", label: "Snapdragon G2 Gen 2" }],
    reviewHref: "/static/rpg2review.html",
    reviewText: "REVIEW"
  },

  "Odin 2 Portal": {
    label: "Odin 2 Portal",
    heroImg: "https://huggingface.co/spaces/IRyzoI/RyanRetro/resolve/main/images/portal.png",
    affiliateHref: "https://www.ayntec.com/products/odin2-portal?sca_ref=8254425.fM33Fgl5td",
    affiliateText: "PURCHASE",
    youtubeChannelId: "UCh9GxjM-FNuSWv7xqn3UKVw",
    youtubeQuery: "odin 2 portal",
    videosLinkHref: "https://www.youtube.com/@RyanRetro/search?query=odin%202%20portal",
    aliases: ["Odin2 Portal","Odin 2"],
    variants: [{ id: "sd8g2", label: "Snapdragon 8 Gen 2" }]
  },

  "Odin 2": {
    label: "Odin 2",
    heroImg: "https://huggingface.co/spaces/IRyzoI/RyanRetro/resolve/main/images/odin2-portal.png",
    affiliateHref: "https://www.ayntec.com/collections/all",
    affiliateText: "PURCHASE",
    youtubeChannelId: "UCh9GxjM-FNuSWv7xqn3UKVw",
    youtubeQuery: "odin 2",
    videosLinkHref: "https://www.youtube.com/@RyanRetro/search?query=odin%202",
    aliases: ["AYN Odin 2"],
    variants: [{ id: "sd8g2", label: "Snapdragon 8 Gen 2" }]
  },

  "Odin 2 Mini": {
    label: "Odin 2 Mini",
    heroImg: "https://huggingface.co/spaces/IRyzoI/RyanRetro/resolve/main/images/odin2-portal.png",
    affiliateHref: "https://www.ayntec.com/collections/all",
    affiliateText: "PURCHASE",
    youtubeChannelId: "UCh9GxjM-FNuSWv7xqn3UKVw",
    youtubeQuery: "odin 2 mini",
    videosLinkHref: "https://www.youtube.com/@RyanRetro/search?query=odin%202%20mini",
    aliases: ["Odin2 Mini"],
    variants: [{ id: "sd8g2", label: "Snapdragon 8 Gen 2" }]
  },

  "AYN Thor": {
    label: "AYN Thor",
    heroImg: "https://huggingface.co/spaces/IRyzoI/RyanRetro/resolve/main/images/thor.png",
    affiliateHref: "https://www.ayntec.com/products/ayn-thor?sca_ref=8254425.fM33Fgl5td",
    affiliateText: "PURCHASE",
    youtubeChannelId: "UCh9GxjM-FNuSWv7xqn3UKVw",
    youtubeQuery: "ayn thor",
    videosLinkHref: "https://www.youtube.com/@RyanRetro/search?query=ayn%20thor",
    aliases: ["Thor","AYN THOR","AynThor"],
    variants: [
      { id: "sd865", label: "Snapdragon 865", pullsFrom: ["Retroid Pocket 5", "Retroid Pocket5", "RP5"] },
      { id: "sd8g2", label: "Snapdragon 8 Gen 2", pullsFrom: ["Odin 2 Portal", "Odin2 Portal", "Odin 2", "Odin 2 Mini", "AYN Thor"] }
    ],
    hasVideos: false,
    noVideosMessage: "Ryan hasn't made any videos on the AYN Thor yet. Get to work, Ryan!"
  },

  "Ayaneo Konkr Pocket Fit": {
    label: "Ayaneo Konkr Pocket Fit",
    heroImg: "https://huggingface.co/spaces/IRyzoI/RyanRetro/resolve/main/images/konkr-pocket-fit-3.jpg",
    affiliateHref: "https://www.indiegogo.com/projects/pocket-fit-premier-hi-performance-android-handheld/x/38203815#/",
    affiliateText: "PURCHASE",
    youtubeChannelId: "UCh9GxjM-FNuSWv7xqn3UKVw",
    youtubeQuery: "Ayaneo Konkr Pocket Fit",
    videosLinkHref: "https://www.youtube.com/@RyanRetro/search?query=Ayaneo%20Konkr%20Pocket%20Fit",
    aliases: ["Konkr Pocket Fit","Ayaneo Konkr","Konkr Fit"],
    hasVideos: false,
    noVideosMessage: "Ryan hasn't made any videos on the Konkr Pocket Fit yet. Get to work, Ryan!",
    variants: [
      { id: "g3g3", label: "Snapdragon G3 Gen 3", pullsFrom: ["Ayaneo Konkr Pocket Fit"] },
      { id: "sd8elite", label: "Snapdragon 8 Elite", pullsFrom: ["Odin 3", "AYN Odin 3", "Odin3", "Odin III", "Ayaneo Konkr Pocket Fit"] }
    ]
  },

  "Retroid Pocket Flip 2": {
    label: "Retroid Pocket Flip 2",
    heroImg: "https://huggingface.co/spaces/IRyzoI/RyanRetro/resolve/main/images/flip%20hero.png",
    affiliateHref: "https://www.goretroid.com/products/retroid-pocket-flip-2?sca_ref=7339476.fIz7oKv7uT",
    affiliateText: "PURCHASE",
    youtubeChannelId: "UCh9GxjM-FNuSWv7xqn3UKVw",
    youtubeQuery: "retroid pocket flip 2",
    aliases: ["RP Flip 2", "Flip 2"],
    variants: [{ id: "sd865", label: "Snapdragon 865", pullsFrom: ["Retroid Pocket Flip 2", "Retroid Pocket 5", "Retroid Pocket5", "RP5"] }]
  },

  "Odin 3": {
    label: "Odin 3",
    heroImg: "https://huggingface.co/spaces/IRyzoI/RyanRetro/resolve/main/images/odin3hero.png",
    affiliateHref: "https://www.ayntec.com/products/ayn-odin-3?sca_ref=8254425.fM33Fgl5td",
    affiliateText: "PURCHASE",
    youtubeChannelId: "UCh9GxjM-FNuSWv7xqn3UKVw",
    youtubeQuery: "odin 3",
    videosLinkHref: "https://www.youtube.com/@RyanRetro/search?query=odin 3",
    aliases: ["AYN Odin 3","Odin3","Odin III"],
    hasVideos: false,
    noVideosMessage: "Ryan hasn't made any videos on the Odin 3 yet. Get to work, Ryan!",
    variants: [{ id: "sd8elite", label: "Snapdragon 8 Elite", pullsFrom: ["Odin 3", "Ayaneo Konkr Pocket Fit"] }]
  },

  "Retroid Pocket Classic": {
    label: "Retroid Pocket Classic",
    heroImg: "https://huggingface.co/spaces/IRyzoI/RyanRetro/resolve/main/images/classic%20colors.png",
    affiliateHref: "https://www.goretroid.com/products/retroid-pocket-classic?sca_ref=7339476.fIz7oKv7uT",
    affiliateText: "PURCHASE",
    youtubeChannelId: "UCh9GxjM-FNuSWv7xqn3UKVw",
    youtubeQuery: "retroid pocket classic",
    videosLinkHref: "https://www.youtube.com/@RyanRetro/search?query=retroid%20pocket%20classic",
    aliases: ["Retroid Classic","RP Classic","RPClassic","Retroid Pocket Classic"],
    variants: [{ id: "g1g2", label: "Snapdragon G1 Gen 2" }]
  },
};


/* ---------- URL/device resolution ---------- */
const urlParams = new URLSearchParams(location.search);
function resolveDeviceFromUrl() {
  const param = (urlParams.get("device") || "").trim().toLowerCase();
  if (!param) return "Retroid Pocket 5";
  for (const key of Object.keys(DEVICE_CONFIG)) {
    const dev = DEVICE_CONFIG[key];
    const names = [key, dev.label, ...(dev.aliases || [])].map(s => s.trim().toLowerCase());
    if (names.includes(param)) return key;
  }
  return "Retroid Pocket 5";
}
const CURRENT_DEVICE = resolveDeviceFromUrl();
const DEVICE = DEVICE_CONFIG[CURRENT_DEVICE];

/* active chipset variant (if any) */
let currentVariant = (DEVICE.variants && DEVICE.variants[0]) || null;

/* ---------- Helpers ---------- */
const norm = s => (s || '').trim().toLowerCase();

const esc = s => (s == null ? '' : String(s)
  .replace(/&/g,'&amp;')
  .replace(/</g,'&lt;')
  .replace(/>/g,'&gt;'));

function ymdKey(s){
  const m = (s || '').trim().match(/^(\d{4})[-\/.](\d{1,2})[-\/.](\d{1,2})$/);
  if (!m) return -Infinity;
  const y = +m[1], mo = +m[2], d = +m[3];
  return y * 10000 + mo * 100 + d;
}

function normalizeDateDisplay(s){
  const m = (s || '').trim().match(/^(\d{4})[-\/.](\d{1,2})[-\/.](\d{1,2})$/);
  if (!m) return s || '';
  const y = m[1], mo = String(+m[2]).padStart(2,'0'), d = String(+m[3]).padStart(2,'0');
  return `${y}/${mo}/${d}`;
}

const normSystemId = s => (s || '').toString().trim().toLowerCase().replace(/[\s_-]+/g, '');
const ALLOWED_PERF = ['Perfect','Great','Playable','Unplayable'];
const PERFORMANCE_ORDER = { 'Perfect':0, 'Great':1, 'Playable':2, 'Unplayable':3 };
function getSortValue(row, colKey){
  const raw = (row[colKey] ?? '').toString();
  if (colKey === 'performance') return (raw in PERFORMANCE_ORDER ? PERFORMANCE_ORDER[raw] : 999);
  if (colKey === 'date added' || colKey === 'date') return ymdKey(raw);
  return raw.toLowerCase();
}

const PERF_CLASS = { 'Perfect':'perf-perfect', 'Great':'perf-great', 'Playable':'perf-playable', 'Unplayable':'perf-unplayable' };
function colorizePerformanceSelects(container=document){
  const selects = container.querySelectorAll('select[name="performance"]');
  selects.forEach(sel=>{
    const apply=()=>{
      sel.classList.remove(...Object.values(PERF_CLASS),'font-bold');
      const cls = PERF_CLASS[sel.value] || '';
      if (cls) sel.classList.add(cls,'font-bold');
    };
    sel.addEventListener('change', apply);
    apply();
  });
}
function debounce(fn, delay=200){ let t; return (...a)=>{ clearTimeout(t); t=setTimeout(()=>fn(...a), delay); }; }

function ensureChipsetField() {
  const form = document.getElementById('compatibility-form');
  if (!form) return;
  const old = form.querySelector('#chipset-field-wrap');
  if (old) old.remove();
  if (!DEVICE.variants || DEVICE.variants.length <= 1) return;
  const wrap = document.createElement('div');
  wrap.id = 'chipset-field-wrap';
  wrap.className = 'grid grid-cols-1 md:grid-cols-2 gap-6 mb-6';
  const inner = document.createElement('div');
  inner.innerHTML = `
    <label for="form-chipset-select" class="block mb-2 font-bold">Chipset *</label>
    <select id="form-chipset-select" name="chipset" class="form-input" required>
      ${DEVICE.variants.map(v => `<option value="${v.id || v.label}">${v.label}</option>`).join('')}
    </select>
  `;
  wrap.appendChild(inner);
  const dyn = document.getElementById('dynamic-fields');
  dyn?.parentNode?.insertBefore(wrap, dyn);
  const sel = document.getElementById('form-chipset-select');
  if (sel && currentVariant) sel.value = currentVariant.id || currentVariant.label;
}

document.addEventListener('DOMContentLoaded', function () {
  AOS?.init({
    once: true,
    duration: 300,
    easing: 'ease-out',
    disable: () => window.matchMedia('(prefers-reduced-motion: reduce)').matches
  });

  (function initVariantTabs(){
    const wrap = document.getElementById('variant-tabs');
    if (!DEVICE.variants || DEVICE.variants.length <= 1 || !wrap) return;
    wrap.classList.remove('hidden');
    const row = wrap.querySelector('div');
    row.innerHTML = '';
    DEVICE.variants.forEach((v, i) => {
      const btn = document.createElement('button');
      btn.type = 'button';
      btn.className = [
        'px-3','py-1.5','rounded-md','retro-font','text-xs',
        i === 0 ? 'bg-yellow-400 text-black' : 'bg-gray-700 hover:bg-gray-600 text-white'
      ].join(' ');
      btn.textContent = v.label;
      btn.dataset.variantId = v.id || v.label;
      row.appendChild(btn);
    });
    row.addEventListener('click', (e) => {
      const btn = e.target.closest('button[data-variant-id]');
      if (!btn) return;
      const id = btn.dataset.variantId;
      const next = DEVICE.variants.find(v => (v.id || v.label) === id);
      if (!next || (currentVariant && (next.id || next.label) === (currentVariant.id || currentVariant.label))) return;
      [...row.children].forEach(b => b.classList.remove('bg-yellow-400','text-black'));
      [...row.children].forEach(b => b.classList.add('bg-gray-700','text-white'));
      btn.classList.remove('bg-gray-700','text-white');
      btn.classList.add('bg-yellow-400','text-black');
      currentVariant = next;
      loadSystemData(currentSystemId);
      const chipSel = document.getElementById('form-chipset-select');
      if (chipSel) chipSel.value = currentVariant.id || currentVariant.label;
    });
  })();

  document.title = `${DEVICE.label} Compatibility | Ryan Retro`;
  document.getElementById('device-heading').textContent = DEVICE.label;
  const hero = document.getElementById('hero-img');
  hero.src = DEVICE.heroImg;
  hero.alt = DEVICE.label;
  const heroLink = document.getElementById('hero-link');
  if (heroLink) heroLink.href = DEVICE.affiliateHref;
  const buyBtn = document.getElementById('affiliate-link');
  buyBtn.href = DEVICE.affiliateHref;
  buyBtn.querySelector('.btn-label').textContent = DEVICE.affiliateText;
  const videosLink = document.getElementById('videos-link');
  videosLink.href = DEVICE.videosLinkHref;
  document.getElementById('hidden-device').value = DEVICE.label;

  const reviewBtn   = document.getElementById('review-or-compat-link');
  const reviewLabel = document.getElementById('review-or-compat-label');
  const reviewIcon  = reviewBtn ? reviewBtn.querySelector('[data-feather]') : null;

  if (reviewBtn && reviewLabel && reviewIcon) {
    if (DEVICE.reviewHref) {
      reviewBtn.href = DEVICE.reviewHref;
      reviewBtn.target = "_blank";
      reviewLabel.textContent = DEVICE.reviewText || "REVIEW";
      reviewIcon.setAttribute('data-feather', 'file-text');
      reviewBtn.classList.remove('bg-blue-600','hover:bg-blue-700','text-white');
      reviewBtn.classList.add('bg-yellow-400','hover:bg-yellow-500','text-black');
    } else {
      reviewBtn.href = "#compatibility";
      reviewBtn.removeAttribute('target');
      reviewLabel.textContent = "PLAY GAMES";
      reviewIcon.setAttribute('data-feather', 'list');
      reviewBtn.classList.remove('bg-yellow-400','hover:bg-yellow-500','text-black');
      reviewBtn.classList.add('bg-blue-600','hover:bg-blue-700','text-white');
    }
  }
  feather.replace();

/* --------------------------- Videos --------------------------- */
async function fetchYouTubeVideos() {
  const videosContainer = document.getElementById('videos-container');
  if (!videosContainer) return;
  if (DEVICE.hasVideos === false) {
    videosContainer.className = 'grid grid-cols-1';
    videosContainer.innerHTML = `<p class="text-gray-300">${DEVICE.noVideosMessage}</p>`;
    return;
  }
  const channelId  = DEVICE.youtubeChannelId;
  const query      = (DEVICE.youtubeQuery || '').toLowerCase();
  const maxResults = 18;
  const aliases    = (DEVICE.aliases || []).join(',');
  try {
    const res = await fetch(`/api/youtube/latest?channel_id=${encodeURIComponent(channelId)}&q=${encodeURIComponent(query)}&aliases=${encodeURIComponent(aliases)}&limit=${maxResults}`);
    if (!res.ok) throw new Error(`HTTP ${res.status}`);
    const items = await res.json();
    if (!Array.isArray(items) || items.length === 0) {
      videosContainer.className = 'grid grid-cols-1';
      videosContainer.innerHTML = `
        <div class="text-gray-300 space-y-3">
          <p>No videos found.</p>
          <p class="text-sm opacity-75">
            You can still browse on YouTube:
            <a class="underline text-yellow-400" target="_blank" rel="noopener" href="${DEVICE.videosLinkHref}">Open device videos</a>
          </p>
        </div>`;
      return;
    }
    videosContainer.className = 'flex overflow-x-auto space-x-8 py-4 custom-scrollbar';
    videosContainer.innerHTML = '';
    items.forEach(item => {
      const id = item.videoId;
      const title = item.title || '';
      const card = document.createElement('div');
      card.setAttribute('data-aos','fade-up');
      card.className = 'flex-shrink-0 w-80 md:w-96 bg-gray-800 rounded-lg overflow-hidden pixel-border relative cursor-pointer';
      card.dataset.videoId = id;
      card.innerHTML = `
        <div class="aspect-video relative group video-thumbnail-container">
          <img src="https://i.ytimg.com/vi/${id}/mqdefault.jpg" alt="${title}" loading="lazy" class="w-full h-full object-cover">
          <div class="absolute inset-0 flex items-center justify-center group-hover:bg-black/40 transition-all">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-16 h-16 text-white opacity-0 group-hover:opacity-100 transition-opacity">
              <path fill-rule="evenodd" d="M2.25 12c0-5.385 4.365-9.75 9.75-9.75s9.75 4.365 9.75 9.75-4.365 9.75-9.75 9.75S2.25 17.385 2.25 12zm14.024-.983a1.125 1.125 0 010 1.966l-5.603 3.113A1.125 1.125 0 019 15.113V8.887c0-.857.921-1.4 1.671-.983l5.603 3.113z" clip-rule="evenodd" />
            </svg>
          </div>
        </div>
        <div class="p-4">
          <h3 class="font-bold text-sm leading-tight text-gray-200 truncate" title="${title}">${title}</h3>
        </div>`;
      videosContainer.appendChild(card);
    });
    if (window.requestIdleCallback) { requestIdleCallback(() => AOS && AOS.refresh()); } 
    else { setTimeout(() => AOS && AOS.refresh(), 0); }
    videosContainer.addEventListener('click', (e) => {
      const card = e.target.closest('[data-video-id]'); if (!card) return;
      const container = card.querySelector('.video-thumbnail-container');
      const id = card.dataset.videoId;
      container.innerHTML = `
        <div class="aspect-video">
          <iframe src="https://www.youtube.com/embed/${id}?autoplay=1" title="YouTube video player" frameborder="0"
            allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share"
            allowfullscreen class="w-full h-full"></iframe>
        </div>`;
    });
  } catch (e) {
    videosContainer.className = 'grid grid-cols-1';
    videosContainer.innerHTML = `<div class="text-gray-300"><p>Error loading videos.</p></div>`;
  }
}

const videosSection = document.getElementById('videos-section');
if (videosSection) {
  if ('IntersectionObserver' in window) {
    const io = new IntersectionObserver((entries) => {
      if (entries.some(e => e.isIntersecting)) {
        fetchYouTubeVideos();
        io.disconnect();
      }
    }, { rootMargin: '200px' });
    io.observe(videosSection);
  } else { fetchYouTubeVideos(); }
}


  /* --------------------------- Compatibility table --------------------------- */
  let rowsPerPage = 10;
  const DATA_BASE = '/data/';

  const SYSTEM_CONFIG = {
    switch:{ path: `${DATA_BASE}switch.csv`, columns:[
      {key:'game',label:'Game'},{key:'performance',label:'Performance',isStatus:true},
      {key:'driver',label:'Driver'},{key:'emulator',label:'Emulator'},
      {key:'notes',label:'Notes',minWidth:'300px'},{key:'date added',label:'Date'}
    ]},
    ps2:{ path: `${DATA_BASE}ps2.csv`, columns:[
      {key:'game',label:'Game'},{key:'performance',label:'Performance',isStatus:true},
      {key:'emulator',label:'Emulator'},{key:'resolution',label:'Resolution'},
      {key:'rom region',label:'ROM Region'},{key:'notes',label:'Notes',minWidth:'300px'},
      {key:'date added',label:'Date'}
    ]},
    winlator:{ path: `${DATA_BASE}winlator.csv`, columns:[
      {key:'game',label:'Game'},{key:'performance',label:'Performance',isStatus:true},
      {key:'winlator version',label:'Winlator Version'},{key:'driver',label:'Driver'},
      {key:'dx wrapper',label:'DX Wrapper'},{key:'notes',label:'Notes',minWidth:'300px'},
      {key:'date added',label:'Date'}
    ]},
    gamehub:{ path: `${DATA_BASE}gamehub.csv`, columns:[
      {key:'game',label:'Game'},{key:'performance',label:'Performance',isStatus:true},
      {key:'game resolution',label:'Game Resolution'},{key:'driver',label:'Driver'},
      {key:'dxvk version',label:'DXVK Version'},{key:'vkd3d version',label:'VKD3D Version'},
      {key:'notes',label:'Notes',minWidth:'300px'},{key:'date added',label:'Date'}
    ]},
    ps3:{ path: `${DATA_BASE}ps3.csv`, columns:[
      {key:'game',label:'Game'},{key:'performance',label:'Performance',isStatus:true},
      {key:'emulator',label:'Emulator'},{key:'resolution',label:'Resolution'},
      {key:'driver',label:'Driver'},{key:'notes',label:'Notes',minWidth:'300px'},
      {key:'date added',label:'Date'}
    ]},
    psvita:{ path: `${DATA_BASE}psvita.csv`, columns:[
      {key:'game',label:'Game'},{key:'performance',label:'Performance',isStatus:true},
      {key:'driver',label:'Driver'},{key:'game title id',label:'Game Title ID'},
      {key:'notes',label:'Notes',minWidth:'300px'},{key:'date added',label:'Date'}
    ]},
    wiiu:{ path: `${DATA_BASE}wiiu.csv`, columns:[
      {key:'game',label:'Game'},{key:'performance',label:'Performance',isStatus:true},
      {key:'driver',label:'Driver'},{key:'pre-compiled shaders',label:'Pre-compiled Shaders'},
      {key:'notes',label:'Notes',minWidth:'300px'},{key:'date added',label:'Date'}
    ]}
  };

  const FORM_CONFIG = {
    switch: [
      { key: 'game', label: 'Game', required: true },
      { key: 'performance', label: 'Performance', required: true, type: 'select', suggestions: ['Perfect','Great','Playable','Unplayable'] },
      { key: 'driver', label: 'Driver', required: true },
      { key: 'emulator', label: 'Emulator', required: true }
    ],
    ps2: [
      { key: 'game', label: 'Game', required: true },
      { key: 'performance', label: 'Performance', required: true, type: 'select', suggestions: ['Perfect','Great','Playable','Unplayable'] },
      { key: 'emulator', label: 'Emulator', required: true },
      { key: 'resolution', label: 'Resolution', required: true },
      { key: 'rom region', label: 'ROM Region', required: true }
    ],
    winlator: [
      { key: 'game', label: 'Game', required: true },
      { key: 'performance', label: 'Performance', required: true, type: 'select', suggestions: ['Perfect','Great','Playable','Unplayable'] },
      { key: 'winlator version', label: 'Winlator Version', required: true },
      { key: 'driver', label: 'Driver', required: true },
      { key: 'dx wrapper', label: 'DX Wrapper', required: true }
    ],
    gamehub: [
      { key: 'game', label: 'Game', required: true },
      { key: 'performance', label: 'Performance', required: true, type: 'select', suggestions: ['Perfect','Great','Playable','Unplayable'] },
      { key: 'game resolution', label: 'Game Resolution', required: true },
      { key: 'driver', label: 'Driver', required: true },
      { key: 'dxvk version', label: 'DXVK Version', required: true },
      { key: 'vkd3d version', label: 'VKD3D Version', required: true }
    ],
    ps3: [
      { key: 'game', label: 'Game', required: true },
      { key: 'performance', label: 'Performance', required: true, type: 'select', suggestions: ['Perfect','Great','Playable','Unplayable'] },
      { key: 'emulator', label: 'Emulator', required: true },
      { key: 'resolution', label: 'Resolution', required: true },
      { key: 'driver', label: 'Driver', required: true }
    ],
    psvita: [
      { key: 'game', label: 'Game', required: true },
      { key: 'performance', label: 'Performance', required: true, type: 'select', suggestions: ['Perfect','Great','Playable','Unplayable'] },
      { key: 'driver', label: 'Driver', required: true },
      { key: 'game title id', label: 'Game Title ID', required: true }
    ],
    wiiu: [
      { key: 'game', label: 'Game', required: true },
      { key: 'performance', label: 'Performance', required: true, type: 'select', suggestions: ['Perfect','Great','Playable','Unplayable'] },
      { key: 'driver', label: 'Driver', required: true },
      { key: 'pre-compiled shaders', label: 'Pre-compiled Shaders', required: true, type: 'select', suggestions: ['Yes','No'] }
    ]
  };

  let masterDataCache = {};
  let activeDataSet = [];
  let currentlyDisplayedGames = [];
  const STORAGE_KEY = `rr:lastSystem:${CURRENT_DEVICE}`;
  let currentSystemId = localStorage.getItem(STORAGE_KEY) && SYSTEM_CONFIG[localStorage.getItem(STORAGE_KEY)]
    ? localStorage.getItem(STORAGE_KEY) : 'switch';
  let currentPage = 1;
  let sortColumn = SYSTEM_CONFIG[currentSystemId].columns[0].key;
  let sortDirection = 'asc';
  let perfFilter = '';

  const tableBody = document.querySelector('#compatibility-table tbody');
  const tableHead = document.querySelector('#compatibility-table thead');
  const searchBox = document.getElementById('game-search-box');
  const prevBtn = document.getElementById('prev-btn');
  const nextBtn = document.getElementById('next-btn');
  const pageInfo = document.getElementById('page-info');
  const formWrap = document.getElementById('add-entry-form-container');
  const formSystemSelect = document.getElementById('form-system-select');
  const rowsPerPageSelect = document.getElementById('rows-per-page');

  async function fetchAndCacheData(systemId){
    if (masterDataCache[systemId]) return masterDataCache[systemId];
    const res = await fetch(`/api/compatibility/${systemId}`);
    if (!res.ok) { masterDataCache[systemId] = []; return []; }
    const payload = await res.json();
    const rows = Array.isArray(payload.rows) ? payload.rows : [];
    const normalized = rows.map(r => {
      const o = {};
      for (const k in r) o[k.trim().toLowerCase()] = typeof r[k] === 'string' ? r[k].trim() : r[k];
      return o;
    });
    masterDataCache[systemId] = normalized;
    return normalized;
  }

  async function loadSystemData(systemId){
    currentSystemId = systemId;
    sortColumn = SYSTEM_CONFIG[currentSystemId].columns[0].key;
    sortDirection = 'asc';
    tableHead.innerHTML = '';
    tableBody.innerHTML = `<tr><td class="p-4 text-center">Loading reports...</td></tr>`;
    const allData = await fetchAndCacheData(systemId);
    const wantChip = currentVariant ? norm(currentVariant.id || currentVariant.label) : '';
    let rowsByChipset = wantChip ? allData.filter(r => norm(r.chipset || '') === wantChip) : [];
    const filtered = rowsByChipset.filter(row => normSystemId(row.system) === normSystemId(currentSystemId));
    activeDataSet = filtered;
    renderTableStructure();
    if (!activeDataSet.length) {
      tableBody.innerHTML = `<tr><td colspan="${SYSTEM_CONFIG[currentSystemId].columns.length}" class="p-6 text-center">No reports yet.</td></tr>`;
      updatePaginationControls();
      return;
    }
    applySearchAndSort();
  }

  function renderTableStructure(){
    const config = SYSTEM_CONFIG[currentSystemId];
    const headerCells = config.columns.map(col => `
      <th class="p-3" data-sort="${col.key}" style="${col.minWidth ? `min-width:${col.minWidth}` : ''}">
        ${col.label} <span class="sort-indicator"></span>
      </th>`).join('');
    tableHead.innerHTML = `<tr>${headerCells}</tr>`;
  }

  function displayCurrentPage(){
    updateSortIndicators();
    const startIndex = (currentPage - 1) * rowsPerPage;
    const pageItems = currentlyDisplayedGames.slice(startIndex, startIndex + rowsPerPage);
    const config = SYSTEM_CONFIG[currentSystemId];
    const perfClass = { 'Perfect':'perf-perfect','Great':'perf-great','Playable':'perf-playable','Unplayable':'perf-unplayable' };
    let html = '';
    for (const row of pageItems) {
      html += '<tr>';
      for (const col of config.columns) {
        let raw = row[col.key] ?? '';
        let display = (col.key === 'date added' || col.key === 'date') ? normalizeDateDisplay(raw) : raw;
        
        // --- NOTE FILTERING FIX START ---
        if (col.key === 'notes') {
            const val = (display || '').trim();
            // This hides "-", "'-", or empty strings
            if (val === '-' || val === "'-" || val === '') display = '';
        }
        // --- NOTE FILTERING FIX END ---

        const cls = col.isStatus ? `p-3 font-bold ${perfClass[raw] || ''}` : 'p-3';
        html += `<td class="${cls}">${esc(display)}</td>`;
      }
      html += '</tr>';
    }
    tableBody.innerHTML = html || '<tr><td colspan="100" class="p-4 text-center">No results.</td></tr>';
    updatePaginationControls();
  }

  function updatePaginationControls(){
    const totalPages = Math.ceil(currentlyDisplayedGames.length / rowsPerPage) || 1;
    pageInfo.textContent = `Page ${currentPage} of ${totalPages}`;
    prevBtn.disabled = currentPage === 1;
    nextBtn.disabled = currentPage === totalPages;
  }

  function applySearchAndSort(){
    const searchTerm = (searchBox.value || '').toLowerCase();
    const firstKey = SYSTEM_CONFIG[currentSystemId].columns[0].key;
    let filtered = activeDataSet;
    if (perfFilter) filtered = filtered.filter(row => (row.performance || '') === perfFilter);
    if (searchTerm) filtered = filtered.filter(row => (row[firstKey] || '').toString().toLowerCase().includes(searchTerm));
    filtered.sort((a,b)=>{
      const A = getSortValue(a, sortColumn);
      const B = getSortValue(b, sortColumn);
      if (A < B) return sortDirection === 'asc' ? -1 : 1;
      if (A > B) return sortDirection === 'asc' ?  1 : -1;
      return 0;
    });
    currentlyDisplayedGames = filtered;
    currentPage = 1;
    displayCurrentPage();
  }

  function updateSortIndicators(){
    tableHead.querySelectorAll('th').forEach(th=>{
      const ind = th.querySelector('.sort-indicator');
      if (ind) ind.textContent = (th.dataset.sort === sortColumn) ? (sortDirection === 'asc' ? ' â²' : ' â¼') : '';
    });
  }

  prevBtn?.addEventListener('click', () => { if (currentPage > 1) { currentPage--; displayCurrentPage(); } });
  nextBtn?.addEventListener('click', () => { if (currentPage < Math.ceil(currentlyDisplayedGames.length / rowsPerPage)) { currentPage++; displayCurrentPage(); } });
  
  // --- ROW SELECTION FIX START ---
  rowsPerPageSelect?.addEventListener('change', (e) => {
    rowsPerPage = parseInt(e.target.value, 10);
    currentPage = 1;
    displayCurrentPage();
  });
  // --- ROW SELECTION FIX END ---

  const SYSTEM_ACTIVE = { switch:['bg-red-600','text-white'], ps2:['bg-green-700','text-white'], ps3:['bg-black','text-white'], winlator:['bg-sky-500','text-white'], wiiu:['bg-blue-600','text-white'], gamehub:['bg-blue-900','text-white'], psvita:['bg-teal-500','text-white'] };
  function setActiveSystemBtn(systemId){
    const wrap = document.getElementById('system-buttons');
    wrap.querySelectorAll('button[data-system]').forEach(btn => {
      btn.classList.remove('bg-red-600','bg-green-700','bg-black','bg-sky-500','bg-blue-600','bg-blue-900','bg-teal-500','text-white','bg-yellow-400','text-black');
      btn.classList.add('bg-gray-600','text-white');
    });
    const active = wrap.querySelector(`[data-system="${systemId}"]`);
    if (active) {
      active.classList.remove('bg-gray-600');
      (SYSTEM_ACTIVE[systemId] || ['bg-yellow-400','text-black']).forEach(c => active.classList.add(c));
    }
  }

  document.getElementById('system-buttons')?.addEventListener('click', (e)=>{
    const btn = e.target.closest('button[data-system]'); if (!btn) return;
    const sid = btn.dataset.system;
    localStorage.setItem(STORAGE_KEY, sid);
    setActiveSystemBtn(sid);
    loadSystemData(sid);
  });

  searchBox.addEventListener('input', debounce(applySearchAndSort, 200));
  tableHead.addEventListener('click', (e)=>{
    const th = e.target.closest('th'); if (!th?.dataset.sort) return;
    sortDirection = (sortColumn === th.dataset.sort && sortDirection === 'asc') ? 'desc' : 'asc';
    sortColumn = th.dataset.sort;
    applySearchAndSort();
  });

  /* --------------------------- FIXED: Performance Filters --------------------------- */
  document.getElementById('perf-filters')?.addEventListener('click', (e) => {
    const btn = e.target.closest('button');
    if (!btn) return;
    
    // 1. Update filter state
    perfFilter = btn.dataset.perf;
    
    // 2. Update visuals
    const allBtns = document.getElementById('perf-filters').querySelectorAll('button');
    allBtns.forEach(b => {
        if (b.dataset.perf === perfFilter) {
            b.classList.add('filter-active');
        } else {
            b.classList.remove('filter-active');
        }
    });

    // 3. Re-run search
    applySearchAndSort();
  });

  /* --------------------------- FIXED: Add Entry Logic --------------------------- */
  function updateFormFields(sysId) {
    const container = document.getElementById('dynamic-fields');
    container.innerHTML = '';
    
    const config = FORM_CONFIG[sysId] || [];
    config.forEach(field => {
        const div = document.createElement('div');
        const req = field.required ? 'required' : '';
        const star = field.required ? '*' : '';
        
        let inputHtml = '';
        
        if (field.type === 'select') {
            const options = field.suggestions.map(opt => `<option value="${opt}">${opt}</option>`).join('');
            const cls = field.key === 'performance' ? 'form-input perf-perfect font-bold' : 'form-input';
            
            inputHtml = `
                <select name="${field.key}" class="${cls}" ${req}>
                    ${options}
                </select>
            `;
        } else {
            inputHtml = `
                <input type="text" name="${field.key}" class="form-input" ${req}>
            `;
        }
        
        div.innerHTML = `
            <label class="block mb-2 font-bold capitalize">${field.label} ${star}</label>
            ${inputHtml}
        `;
        container.appendChild(div);
    });

    // Re-bind color changes for performance selects
    colorizePerformanceSelects(container);
    // Ensure chipset field exists
    ensureChipsetField();
    
    // Update hidden system input
    document.getElementById('hidden-system').value = sysId;
  }

  // Open Form
  document.getElementById('add-entry-btn')?.addEventListener('click', () => {
    const formContainer = document.getElementById('add-entry-form-container');
    formContainer.classList.remove('hidden');
    // Initialize form with current system
    const currentSys = document.getElementById('form-system-select').value || currentSystemId;
    document.getElementById('form-system-select').value = currentSys;
    updateFormFields(currentSys);
    
    // Scroll to form
    formContainer.scrollIntoView({ behavior: 'smooth' });
  });

  // Close Form
  document.getElementById('cancel-btn')?.addEventListener('click', () => {
    document.getElementById('add-entry-form-container').classList.add('hidden');
  });

  // Change fields when system changes in form
  document.getElementById('form-system-select')?.addEventListener('change', (e) => {
    updateFormFields(e.target.value);
  });


  setActiveSystemBtn(currentSystemId);
  loadSystemData(currentSystemId);
});
</script>
</body>
</html>
