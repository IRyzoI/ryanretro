<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Compatibility | Ryan Retro</title>

  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://unpkg.com/aos@2.3.1/dist/aos.css" rel="stylesheet"/>
  <script defer src="https://unpkg.com/aos@2.3.1/dist/aos.js"></script>
  <script defer src="https://cdn.jsdelivr.net/npm/feather-icons/dist/feather.min.js"></script>
  <script defer src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>

  <link rel="preconnect" href="https://i.ytimg.com" crossorigin>
  <link rel="preconnect" href="https://www.googleapis.com" crossorigin>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link rel="preconnect" href="https://huggingface.co" crossorigin>
<link rel="dns-prefetch" href="//huggingface.co">
  <link rel="icon" href="data:,">


  <style>
    @import url('https://fonts.googleapis.com/css2?family=Press+Start+2P&family=Roboto:wght@400;700&display=swap');

    .retro-font { font-family: 'Press Start 2P', cursive; }
    .pixel-border { border: 4px solid #000; box-shadow: 8px 8px 0 rgba(0,0,0,0.2); }

    .perf-perfect, .status-perfect { color: #4ade80; }
    .perf-great, .status-great { color: #38bdf8; }
    .perf-playable, .status-playable { color: #fb923c; }
    .perf-unplayable, .status-unplayable { color: #f87171; }

    #compatibility-table thead th { position: sticky; top: 0; z-index: 10; }

    .form-input {
      background-color: #374151; border: 2px solid #1f2937; border-radius: .25rem;
      padding: .5rem .75rem; color: #d1d5db; width: 100%; transition: border-color .2s;
    }
    .form-input:focus { outline: none; border-color: #facc15; }

    .custom-scrollbar::-webkit-scrollbar { height: 8px; }
    .custom-scrollbar::-webkit-scrollbar-track { background: #1f2937; border-radius: 10px; }
    .custom-scrollbar::-webkit-scrollbar-thumb { background: #4b5563; border-radius: 10px; }
    .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: #6b7280; }

    select.form-input.perf-perfect   { background-color: rgba(74, 222, 128, .10); }
    select.form-input.perf-great     { background-color: rgba(56, 189, 248, .10); }
    select.form-input.perf-playable  { background-color: rgba(251, 146, 60, .10); }
    select.form-input.perf-unplayable{ background-color: rgba(248, 113, 113, .10); }

    .island { content-visibility: auto; contain-intrinsic-size: 800px; }
  </style>
</head>

<body class="bg-gray-900 text-white">
  <header class="bg-black py-6">
    <div class="container mx-auto px-4">
      <a href="/static/index.html" class="flex items-center">
        <img src="https://huggingface.co/spaces/IRyzoI/RyanRetro/resolve/main/images/ryan%20retro%20logo.png" alt="Ryan Retro Logo" class="w-12 h-12 rounded-full mr-4">
        <span class="retro-font text-yellow-400 text-xl">RYAN RETRO</span>
      </a>
    </div>
  </header>

  <main class="py-12">
    <div class="container mx-auto px-4">
      <div class="max-w-full mx-auto">
        <div class="flex items-center mb-8">
          <span class="bg-red-500 text-black text-xs px-2 py-1 rounded retro-font mr-4">HANDHELD</span>
          <h1 id="device-heading" class="retro-font text-3xl md:text-4xl">Device</h1>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-3 gap-8 mb-12">
          <div class="md:col-span-2" data-aos="fade-right">
            <div class="bg-gray-800 rounded-lg overflow-hidden pixel-border h-full flex items-center justify-center p-4">
              <img id="hero-img" src="" alt="Device" class="w-full h-auto object-contain" decoding="async" fetchpriority="high">
            </div>
          </div>

          <div id="sidebar-panel"
               class="md:col-span-1 bg-gray-800 p-8 rounded-lg pixel-border flex flex-col" data-aos="fade-left">
            <div id="cta-buttons" class="flex flex-col gap-4 h-full">
              <a id="affiliate-link" href="#" target="_blank"
                 class="group flex-grow bg-green-600 hover:bg-green-700 text-white px-4 rounded pixel-btn retro-font text-sm md:text-base
                        flex items-center justify-center transition-transform hover:scale-105 hover:-translate-y-1">
                <i data-feather="shopping-cart" class="mr-2 w-5 h-5 transition-transform group-hover:scale-110"></i>
                <span class="btn-label">PURCHASE</span>
              </a>

              <a id="videos-link" href="#" target="_blank"
                 class="group flex-grow bg-red-600 hover:bg-red-700 text-white px-4 rounded pixel-btn retro-font text-sm md:text-base flex items-center justify-center transition-transform hover:scale-105 hover:-translate-y-1">
                <i data-feather="youtube" class="mr-2 w-5 h-5 transition-transform group-hover:scale-110"></i> VIDEOS
              </a>
              <a href="#compatibility"
                 class="group flex-grow bg-blue-600 hover:bg-blue-700 text-white px-4 rounded pixel-btn retro-font text-sm md:text-base flex items-center justify-center transition-transform hover:scale-105 hover:-translate-y-1">
                <i data-feather="list" class="mr-2 w-5 h-5 transition-transform group-hover:scale-110"></i> PLAY GAMES
              </a>
              <a href="#"
                 class="group flex-grow bg-yellow-500 hover:bg-yellow-600 text-black px-4 rounded pixel-btn retro-font text-sm md:text-base flex items-center justify-center transition-transform hover:scale-105 hover:-translate-y-1">
                <i data-feather="book-open" class="mr-2 w-5 h-5 transition-transform group-hover:scale-110"></i> GUIDES
              </a>
            </div>
          </div>
        </div>

        <!-- Videos -->
        <section id="videos-section" class="mb-12 island">
          <h2 class="retro-font text-2xl mb-6">Videos</h2>
          <div id="videos-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8">
            <p class="md:col-span-3">Loading videos...</p>
          </div>
        </section>

        <!-- Compatibility -->
        <div id="compatibility" class="bg-gray-800 p-8 rounded-lg pixel-border mb-12 island">
          <h2 class="retro-font text-2xl mb-6">Game Compatibility</h2>

          <!-- Chipset tabs (rendered dynamically only if device has >1 variants) -->
          <div id="variant-tabs" class="mb-4 hidden">
            <div class="inline-flex flex-wrap gap-2"></div>
          </div>

          <div id="system-buttons" class="mb-4 flex flex-wrap gap-2">
            <button data-system="switch"   class="system-btn bg-yellow-400 text-black px-4 py-2 rounded-md retro-font text-xs">Switch</button>
            <button data-system="ps2"      class="system-btn bg-gray-600 hover:bg-gray-500 text-white px-4 py-2 rounded-md retro-font text-xs">PS2</button>
            <button data-system="ps3"      class="system-btn bg-gray-600 hover:bg-gray-500 text-white px-4 py-2 rounded-md retro-font text-xs">PS3</button>
            <button data-system="psvita"   class="system-btn bg-gray-600 hover:bg-gray-500 text-white px-4 py-2 rounded-md retro-font text-xs">PS Vita</button>
            <button data-system="winlator" class="system-btn bg-gray-600 hover:bg-gray-500 text-white px-4 py-2 rounded-md retro-font text-xs">Winlator</button>
            <button data-system="gamehub"  class="system-btn bg-gray-600 hover:bg-gray-500 text-white px-4 py-2 rounded-md retro-font text-xs">GameHub</button>
            <button data-system="wiiu"     class="system-btn bg-gray-600 hover:bg-gray-500 text-white px-4 py-2 rounded-md retro-font text-xs">Wii U</button>
          </div>

          <div id="perf-filters" class="mb-3 flex flex-wrap gap-2 text-xs">
            <button data-perf=""           class="px-2 py-1 rounded bg-gray-700 hover:bg-gray-600">All</button>
            <button data-perf="Perfect"    class="px-2 py-1 rounded bg-gray-700 hover:bg-gray-600 perf-perfect font-bold">Perfect</button>
            <button data-perf="Great"      class="px-2 py-1 rounded bg-gray-700 hover:bg-gray-600 perf-great font-bold">Great</button>
            <button data-perf="Playable"   class="px-2 py-1 rounded bg-gray-700 hover:bg-gray-600 perf-playable font-bold">Playable</button>
            <button data-perf="Unplayable" class="px-2 py-1 rounded bg-gray-700 hover:bg-gray-600 perf-unplayable font-bold">Unplayable</button>
          </div>

          <div class="mb-6">
            <input type="text" id="game-search-box" class="form-input" placeholder="Search for a game...">
          </div>

          <div class="overflow-x-auto custom-scrollbar">
            <table id="compatibility-table" class="min-w-full text-sm text-left text-gray-300">
              <thead class="bg-gray-700 text-gray-100 retro-font text-xs uppercase tracking-wider cursor-pointer"></thead>
              <tbody class="divide-y divide-gray-700 align-baseline"></tbody>
            </table>
          </div>
        </div>

        <div id="pagination-controls" class="mt-6 flex items-center justify-center gap-4">
          <button id="prev-btn" class="bg-gray-600 hover:bg-gray-500 text-white px-4 py-2 rounded-md retro-font text-xs disabled:opacity-50" disabled>Previous</button>
          <span id="page-info" class="retro-font text-sm text-yellow-400">Page 1 of 1</span>
          <button id="next-btn" class="bg-gray-600 hover:bg-gray-500 text-white px-4 py-2 rounded-md retro-font text-xs disabled:opacity-50" disabled>Next</button>
        </div>

        <!-- Add Entry -->
        <div class="text-center mt-6">
          <button id="add-entry-btn" class="bg-yellow-400 hover:bg-yellow-500 text-black px-6 py-3 rounded retro-font">
            ADD YOUR ENTRY
          </button>
        </div>

        <div id="add-entry-form-container" class="bg-gray-800 p-8 rounded-lg pixel-border mb-12 hidden" data-aos="fade-up">
          <h2 class="retro-font text-2xl mb-6 text-yellow-400">Add New Compatibility Entry</h2>

          <form id="compatibility-form">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
              <div>
                <label for="form-system-select" class="block mb-2 font-bold">System *</label>
                <select id="form-system-select" class="form-input" required>
                  <option value="switch">Nintendo Switch</option>
                  <option value="ps2">PlayStation 2</option>
                  <option value="ps3">PlayStation 3</option>
                  <option value="psvita">PlayStation Vita</option>
                  <option value="winlator">Winlator</option>
                  <option value="gamehub">GameHub</option>
                  <option value="wiiu">Wii U</option>
                </select>
              </div>
            </div>

            <!-- Chipset field will be injected here (only if >1 chipset) -->

            <div id="dynamic-fields" class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6"></div>

            <div class="mb-6">
              <label for="notes" class="block mb-2 font-bold">Notes (optional)</label>
              <textarea id="notes" name="notes" rows="3" class="form-input" placeholder="Extra context, settings, caveats..."></textarea>
            </div>

            <input type="hidden" id="hidden-device" name="device" value="">
            <input type="hidden" id="hidden-system" name="system" value="switch">

            <div class="flex items-center justify-end gap-4">
              <button type="button" id="cancel-btn" class="bg-gray-600 hover:bg-gray-500 text-white px-6 py-3 rounded retro-font">CANCEL</button>
              <button type="submit" class="bg-green-500 hover:bg-green-600 text-black px-6 py-3 rounded retro-font">SUBMIT</button>
            </div>
          </form>
        </div>

      </div>
    </div>
  </main>

  <footer class="bg-black py-8">
    <div class="container mx-auto px-4 text-center text-gray-500 text-sm">
      <p>© 2025 Ryan Retro. All rights reserved.</p>
    </div>
  </footer>

<script>
/* --------------------------- Device config --------------------------- */
const DEVICE_CONFIG = {
  "Retroid Pocket 5": {
    label: "Retroid Pocket 5",
    heroImg: "https://huggingface.co/spaces/IRyzoI/RyanRetro/resolve/main/images/rp5.png",
    affiliateHref: "https://www.goretroid.com/products/retroid-pocket-5-handheld?sca_ref=7339476.fIz7oKv7oKv7uT",
    affiliateText: "PURCHASE",
    youtubeChannelId: "UCh9GxjM-FNuSWv7xqn3UKVw",
    youtubeQuery: "retroid pocket 5",
    videosLinkHref: "https://www.youtube.com/@RyanRetro/search?query=retroid%20pocket%205",
    aliases: ["Retroid Pocket5","RP5"],
    variants: [{ id: "sd865", label: "Snapdragon 865" }]
  },

  "Odin 2 Portal": {
    label: "Odin 2 Portal",
    heroImg: "https://www.retrodock.com/wp-content/uploads/2025/01/device_odin2-portal-1.png",
    affiliateHref: "https://www.ayntec.com/products/odin2-portal?sca_ref=8254425.fM33Fgl5td",
    affiliateText: "PURCHASE",
    youtubeChannelId: "UCh9GxjM-FNuSWv7xqn3UKVw",
    youtubeQuery: "odin 2 portal",
    videosLinkHref: "https://www.youtube.com/@RyanRetro/search?query=odin%202%20portal",
    aliases: ["Odin2 Portal","Odin 2"],
    variants: [{ id: "sd8g2", label: "Snapdragon 8 Gen 2" }]
  },

  "Odin 2": {
    label: "Odin 2",
    heroImg: "https://huggingface.co/spaces/IRyzoI/RyanRetro/resolve/main/images/odin2-portal.png",
    affiliateHref: "https://www.ayntec.com/collections/all",
    affiliateText: "PURCHASE",
    youtubeChannelId: "UCh9GxjM-FNuSWv7xqn3UKVw",
    youtubeQuery: "odin 2",
    videosLinkHref: "https://www.youtube.com/@RyanRetro/search?query=odin%202",
    aliases: ["AYN Odin 2"],
    variants: [{ id: "sd8g2", label: "Snapdragon 8 Gen 2" }]
  },

  "Odin 2 Mini": {
    label: "Odin 2 Mini",
    heroImg: "https://huggingface.co/spaces/IRyzoI/RyanRetro/resolve/main/images/odin2-portal.png",
    affiliateHref: "https://www.ayntec.com/collections/all",
    affiliateText: "PURCHASE",
    youtubeChannelId: "UCh9GxjM-FNuSWv7xqn3UKVw",
    youtubeQuery: "odin 2 mini",
    videosLinkHref: "https://www.youtube.com/@RyanRetro/search?query=odin%202%20mini",
    aliases: ["Odin2 Mini"],
    variants: [{ id: "sd8g2", label: "Snapdragon 8 Gen 2" }]
  },

  "AYN Thor": {
    label: "AYN Thor",
    heroImg: "https://huggingface.co/spaces/IRyzoI/RyanRetro/resolve/main/images/thor.png",
    affiliateHref: "https://www.ayntec.com/products/ayn-thor?sca_ref=8254425.fM33Fgl5td",
    affiliateText: "PURCHASE",
    youtubeChannelId: "UCh9GxjM-FNuSWv7xqn3UKVw",
    youtubeQuery: "ayn thor",
    videosLinkHref: "https://www.youtube.com/@RyanRetro/search?query=ayn%20thor",
    aliases: ["Thor","AYN THOR","AynThor"],
    variants: [
      {
        id: "sd865",
        label: "Snapdragon 865",
        pullsFrom: ["Retroid Pocket 5", "Retroid Pocket5", "RP5"]
      },
      {
        id: "sd8g2",
        label: "Snapdragon 8 Gen 2",
        pullsFrom: ["Odin 2 Portal", "Odin2 Portal", "Odin 2", "Odin 2 Mini", "AYN Thor"]
      }
    ],
    hasVideos: false,
    noVideosMessage: "Ryan hasn't made any videos on the AYN Thor yet. Get to work, Ryan!"
  },

  "Ayaneo Konkr Pocket Fit": {
    label: "Ayaneo Konkr Pocket Fit",
    heroImg: "https://huggingface.co/spaces/IRyzoI/RyanRetro/resolve/main/images/konkr-pocket-fit-3.jpg",
    affiliateHref: "https://www.indiegogo.com/projects/pocket-fit-premier-hi-performance-android-handheld/x/38203815#/",
    affiliateText: "PURCHASE",
    youtubeChannelId: "UCh9GxjM-FNuSWv7xqn3UKVw",
    youtubeQuery: "Ayaneo Konkr Pocket Fit",
    videosLinkHref: "https://www.youtube.com/@RyanRetro/search?query=Ayaneo%20Konkr%20Pocket%20Fit",
    aliases: ["Konkr Pocket Fit","Ayaneo Konkr","Konkr Fit"],
    hasVideos: false,
    noVideosMessage: "Ryan hasn't made any videos on the Konkr Pocket Fit yet. Get to work, Ryan!",
    variants: [
      {
        id: "g3g3",
        label: "Snapdragon G3 Gen 3",
        pullsFrom: ["Ayaneo Konkr Pocket Fit"]
      },
      {
        id: "sd8elite",
        label: "Snapdragon 8 Elite",
        pullsFrom: ["Odin 3", "AYN Odin 3", "Odin3", "Odin III", "Ayaneo Konkr Pocket Fit"]
      }
    ]
  },

  "Retroid Pocket Flip 2": {
    label: "Retroid Pocket Flip 2",
    heroImg: "https://huggingface.co/spaces/IRyzoI/RyanRetro/resolve/main/images/flip%20hero.png",
    affiliateHref: "https://www.goretroid.com/products/retroid-pocket-flip-2?sca_ref=7339476.fIz7oKv7uT",
    affiliateText: "PURCHASE",
    youtubeChannelId: "UCh9GxjM-FNuSWv7xqn3UKVw",
    youtubeQuery: "retroid pocket flip 2",
    videosLinkHref: "https://www.youtube.com/@RyanRetro/search?query=retroid%20pocket%20flip%202",
    // Aliases are now ONLY for videos. "Retroid Pocket 5" has been removed.
    aliases: ["RP Flip 2", "Flip 2"],
    // Variants and pullsFrom are ONLY for the compatibility table.
    variants: [
      { 
        id: "sd865", label: "Snapdragon 865",
        pullsFrom: ["Retroid Pocket Flip 2", "Retroid Pocket 5", "Retroid Pocket5", "RP5"]
      }
    ]
  },

  "Odin 3": {
    label: "Odin 3",
    heroImg: "https://huggingface.co/spaces/IRyzoI/RyanRetro/resolve/main/images/odin3hero.png",
    affiliateHref: "https://www.indiegogo.com/projects/odin-3-the-ultimate-6-120hz-oled-gaming-handheld/x/38203815#/",
    affiliateText: "PURCHASE",
    youtubeChannelId: "UCh9GxjM-FNuSWv7xqn3UKVw",
    youtubeQuery: "odin 3",
    videosLinkHref: "https://www.youtube.com/@RyanRetro/search?query=odin%203",
    aliases: ["AYN Odin 3","Odin3","Odin III"],
    hasVideos: false,
    noVideosMessage: "Ryan hasn't made any videos on the Odin 3 yet. Get to work, Ryan!",
    /* single chipset — tabs will not render */
    variants: [
      { id: "sd8elite", label: "Snapdragon 8 Elite", pullsFrom: ["Odin 3", "Ayaneo Konkr Pocket Fit"] }
    ]
  },

  "Retroid Pocket Classic": {
  label: "Retroid Pocket Classic",
  heroImg: "https://huggingface.co/spaces/IRyzoI/RyanRetro/resolve/main/images/classic%20colors.png",
  affiliateHref: "https://www.goretroid.com/products/retroid-pocket-classic?sca_ref=7339476.fIz7oKv7uT",   // put the real product link if you have it
  affiliateText: "PURCHASE",
  youtubeChannelId: "UCh9GxjM-FNuSWv7xqn3UKVw",
  youtubeQuery: "retroid pocket classic",
  videosLinkHref: "https://www.youtube.com/@RyanRetro/search?query=retroid%20pocket%20classic",
  aliases: ["Retroid Classic","RP Classic","RPClassic","Retroid Pocket Classic"],
  variants: [{ id: "g1g2", label: "Snapdragon G1 Gen 2" }]
},


};


/* ---------- URL/device resolution ---------- */
const urlParams = new URLSearchParams(location.search);
function resolveDeviceFromUrl() {
  const param = (urlParams.get("device") || "").trim().toLowerCase();
  if (!param) return "Retroid Pocket 5";
  for (const key of Object.keys(DEVICE_CONFIG)) {
    const dev = DEVICE_CONFIG[key];
    const names = [key, dev.label, ...(dev.aliases || [])].map(s => s.trim().toLowerCase());
    if (names.includes(param)) return key;
  }
  return "Retroid Pocket 5";
}
const CURRENT_DEVICE = resolveDeviceFromUrl();
const DEVICE = DEVICE_CONFIG[CURRENT_DEVICE];

/* active chipset variant (if any) */
let currentVariant = (DEVICE.variants && DEVICE.variants[0]) || null;

/* ---------- Helpers ---------- */
const norm = s => (s || '').trim().toLowerCase();

// escape to keep user-submitted CSV text safe in the table
const esc = s => (s == null ? '' : String(s)
  .replace(/&/g,'&amp;')
  .replace(/</g,'&lt;')
  .replace(/>/g,'&gt;'));

function ymdKey(s){
  // Accept YYYY-MM-DD, YYYY/MM/DD, YYYY.M.D, etc.
  const m = (s || '').trim().match(/^(\d{4})[-\/.](\d{1,2})[-\/.](\d{1,2})$/);
  if (!m) return -Infinity;             // empty/invalid dates sink to the bottom
  const y = +m[1], mo = +m[2], d = +m[3];
  return y * 10000 + mo * 100 + d;      // sortable numeric key
}

function normalizeDateDisplay(s){
  const m = (s || '').trim().match(/^(\d{4})[-\/.](\d{1,2})[-\/.](\d{1,2})$/);
  if (!m) return s || '';
  const y = m[1], mo = String(+m[2]).padStart(2,'0'), d = String(+m[3]).padStart(2,'0');
  return `${y}/${mo}/${d}`; // display with slashes
}




const normSystemId = s => (s || '').toString().trim().toLowerCase().replace(/[\s_-]+/g, '');
const ALLOWED_PERF = ['Perfect','Great','Playable','Unplayable'];
const PERFORMANCE_ORDER = { 'Perfect':0, 'Great':1, 'Playable':2, 'Unplayable':3 };
function getSortValue(row, colKey){
  const raw = (row[colKey] ?? '').toString();
  if (colKey === 'performance') {
    return (raw in PERFORMANCE_ORDER ? PERFORMANCE_ORDER[raw] : 999);
  }
  if (colKey === 'date added' || colKey === 'date') {
    return ymdKey(raw);                 // <-- real date sort
  }
  return raw.toLowerCase();
}

const PERF_CLASS = { 'Perfect':'perf-perfect', 'Great':'perf-great', 'Playable':'perf-playable', 'Unplayable':'perf-unplayable' };
function colorizePerformanceSelects(container=document){
  const selects = container.querySelectorAll('select[name="performance"]');
  selects.forEach(sel=>{
    const apply=()=>{
      sel.classList.remove(...Object.values(PERF_CLASS),'font-bold');
      const cls = PERF_CLASS[sel.value] || '';
      if (cls) sel.classList.add(cls,'font-bold');
    };
    sel.addEventListener('change', apply);
    apply();
  });
}
function debounce(fn, delay=200){ let t; return (...a)=>{ clearTimeout(t); t=setTimeout(()=>fn(...a), delay); }; }

/* Build the Chipset picker above dynamic fields if (and only if) variants > 1 */
function ensureChipsetField() {
  const form = document.getElementById('compatibility-form');
  if (!form) return;

  const old = form.querySelector('#chipset-field-wrap');
  if (old) old.remove();

  if (!DEVICE.variants || DEVICE.variants.length <= 1) return;  // <-- single-chipset devices: no field

  const wrap = document.createElement('div');
  wrap.id = 'chipset-field-wrap';
  wrap.className = 'grid grid-cols-1 md:grid-cols-2 gap-6 mb-6';

  const inner = document.createElement('div');
  inner.innerHTML = `
    <label for="form-chipset-select" class="block mb-2 font-bold">Chipset *</label>
    <select id="form-chipset-select" name="chipset" class="form-input" required>
      ${DEVICE.variants.map(v => `<option value="${v.id || v.label}">${v.label}</option>`).join('')}
    </select>
  `;
  wrap.appendChild(inner);

  const dyn = document.getElementById('dynamic-fields');
  dyn?.parentNode?.insertBefore(wrap, dyn);

  // Preselect the current tab's chipset if tabs are visible
  const sel = document.getElementById('form-chipset-select');
  if (sel && currentVariant) sel.value = currentVariant.id || currentVariant.label;
}

document.addEventListener('DOMContentLoaded', function () {
  AOS?.init({
    once: true,
    duration: 300,
    easing: 'ease-out',
    disable: () => window.matchMedia('(prefers-reduced-motion: reduce)').matches
  });

  // ----- Chipset tabs (render only if device has >1 variants) -----
  (function initVariantTabs(){
    const wrap = document.getElementById('variant-tabs');
    if (!DEVICE.variants || DEVICE.variants.length <= 1 || !wrap) return; // <-- Odin 3 won't show tabs

    wrap.classList.remove('hidden');

    const row = wrap.querySelector('div');
    row.innerHTML = '';

    DEVICE.variants.forEach((v, i) => {
      const btn = document.createElement('button');
      btn.type = 'button';
      btn.className = [
        'px-3','py-1.5','rounded-md','retro-font','text-xs',
        i === 0 ? 'bg-yellow-400 text-black' : 'bg-gray-700 hover:bg-gray-600 text-white'
      ].join(' ');
      btn.textContent = v.label;
      btn.dataset.variantId = v.id || v.label;
      row.appendChild(btn);
    });

    row.addEventListener('click', (e) => {
      const btn = e.target.closest('button[data-variant-id]');
      if (!btn) return;
      const id = btn.dataset.variantId;
      const next = DEVICE.variants.find(v => (v.id || v.label) === id);
      if (!next || (currentVariant && (next.id || next.label) === (currentVariant.id || currentVariant.label))) return;

      // swap active styles
      [...row.children].forEach(b => b.classList.remove('bg-yellow-400','text-black'));
      [...row.children].forEach(b => b.classList.add('bg-gray-700','text-white'));
      btn.classList.remove('bg-gray-700','text-white');
      btn.classList.add('bg-yellow-400','text-black');

      currentVariant = next;

      // Refresh list for the newly selected chipset
      loadSystemData(currentSystemId);

      // If form is open, sync chipset dropdown
      const chipSel = document.getElementById('form-chipset-select');
      if (chipSel) chipSel.value = currentVariant.id || currentVariant.label;
    });
  })();

  feather.replace();

  // Headline/hero/CTAs (no chipset text added to the header)
  document.title = `${DEVICE.label} Compatibility | Ryan Retro`;
  document.getElementById('device-heading').textContent = DEVICE.label;

  const hero = document.getElementById('hero-img');
  hero.src = DEVICE.heroImg; hero.alt = DEVICE.label;
  const buyBtn = document.getElementById('affiliate-link');
  buyBtn.href = DEVICE.affiliateHref;
  buyBtn.querySelector('.btn-label').textContent = DEVICE.affiliateText;
  const videosLink = document.getElementById('videos-link');
  videosLink.href = DEVICE.videosLinkHref;
  document.getElementById('hidden-device').value = DEVICE.label;

/* --------------------------- Videos --------------------------- */
async function fetchYouTubeVideos() {
  const videosContainer = document.getElementById('videos-container');
  if (!videosContainer) return;


  if (DEVICE.hasVideos === false) {
    videosContainer.className = 'grid grid-cols-1';
    videosContainer.innerHTML = `<p class="text-gray-300">${DEVICE.noVideosMessage}</p>`;
    return;
  }

  const channelId  = DEVICE.youtubeChannelId;
  const query      = (DEVICE.youtubeQuery || '').toLowerCase();
  const maxResults = 18;
  const aliases    = (DEVICE.aliases || []).join(',');

  try {
    const res = await fetch(
  `/api/youtube/latest?channel_id=${encodeURIComponent(channelId)}&q=${encodeURIComponent(query)}&aliases=${encodeURIComponent(aliases)}&limit=${maxResults}`
); // <-- closing ); was missing
if (!res.ok) throw new Error(`HTTP ${res.status}`);
    const items = await res.json();

    if (!Array.isArray(items) || items.length === 0) {
      videosContainer.className = 'grid grid-cols-1';
      videosContainer.innerHTML = `
        <div class="text-gray-300 space-y-3">
          <p>No videos found.</p>
          <p class="text-sm opacity-75">
            You can still browse on YouTube:
            <a class="underline text-yellow-400" target="_blank" rel="noopener" href="${DEVICE.videosLinkHref}">Open device videos</a>
          </p>
        </div>`;
      return;
    }

    // Render
    videosContainer.className = 'flex overflow-x-auto space-x-8 py-4 custom-scrollbar';
    videosContainer.innerHTML = '';
    items.forEach(item => {
      const id = item.videoId;
      const title = item.title || '';
      const card = document.createElement('div');
      card.setAttribute('data-aos','fade-up');   // add this
      card.className = 'flex-shrink-0 w-80 md:w-96 bg-gray-800 rounded-lg overflow-hidden pixel-border relative cursor-pointer';
      card.dataset.videoId = id;
      card.innerHTML = `
        <div class="aspect-video relative group video-thumbnail-container">
          <img src="https://i.ytimg.com/vi/${id}/mqdefault.jpg" alt="${title}" loading="lazy" class="w-full h-full object-cover">
          <div class="absolute inset-0 flex items-center justify-center group-hover:bg-black/40 transition-all">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-16 h-16 text-white opacity-0 group-hover:opacity-100 transition-opacity">
              <path fill-rule="evenodd" d="M2.25 12c0-5.385 4.365-9.75 9.75-9.75s9.75 4.365 9.75 9.75-4.365 9.75-9.75 9.75S2.25 17.385 2.25 12zm14.024-.983a1.125 1.125 0 010 1.966l-5.603 3.113A1.125 1.125 0 019 15.113V8.887c0-.857.921-1.4 1.671-.983l5.603 3.113z" clip-rule="evenodd" />
            </svg>
          </div>
        </div>
        <div class="p-4">
          <h3 class="font-bold text-sm leading-tight text-gray-200 truncate" title="${title}">${title}</h3>
        </div>`;
      videosContainer.appendChild(card);
    });

    // CORRECT
if (window.requestIdleCallback) {
  requestIdleCallback(() => AOS && AOS.refresh());
} else {
  setTimeout(() => AOS && AOS.refresh(), 0);
}

    videosContainer.addEventListener('click', (e) => {
      const card = e.target.closest('[data-video-id]'); if (!card) return;
      const container = card.querySelector('.video-thumbnail-container');
      const id = card.dataset.videoId;
      container.innerHTML = `
        <div class="aspect-video">
          <iframe src="https://www.youtube.com/embed/${id}?autoplay=1" title="YouTube video player" frameborder="0"
            allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share"
            allowfullscreen class="w-full h-full"></iframe>
        </div>`;
    });
  } catch (e) {
    console.error('Failed to load videos:', e);
    videosContainer.className = 'grid grid-cols-1';
    videosContainer.innerHTML = `
      <div class="text-gray-300 space-y-3">
        <p>Error loading videos.</p>
        <p class="text-sm opacity-75">
          You can still browse on YouTube:
          <a class="underline text-yellow-400" target="_blank" rel="noopener" href="${DEVICE.videosLinkHref}">Open device videos</a>
        </p>
      </div>`;
  }
}

// Lazy-load when the section scrolls into view (or run immediately as fallback)
const videosSection = document.getElementById('videos-section');
if (videosSection) {
  if ('IntersectionObserver' in window) {
    const io = new IntersectionObserver((entries) => {
      if (entries.some(e => e.isIntersecting)) {
        fetchYouTubeVideos();
        io.disconnect();
      }
    }, { rootMargin: '200px' });
    io.observe(videosSection);
  } else {
    fetchYouTubeVideos();
  }
}


  /* --------------------------- Compatibility table --------------------------- */
  const rowsPerPage = 10;
  const DATA_BASE = '/data/';

  const SYSTEM_CONFIG = {
    switch:{ path: `${DATA_BASE}switch.csv`, columns:[
      {key:'game',label:'Game'},{key:'performance',label:'Performance',isStatus:true},
      {key:'driver',label:'Driver'},{key:'emulator',label:'Emulator'},
      {key:'notes',label:'Notes',minWidth:'300px'},{key:'date added',label:'Date'}
    ]},
    ps2:{ path: `${DATA_BASE}ps2.csv`, columns:[
      {key:'game',label:'Game'},{key:'performance',label:'Performance',isStatus:true},
      {key:'emulator',label:'Emulator'},{key:'resolution',label:'Resolution'},
      {key:'rom region',label:'ROM Region'},{key:'notes',label:'Notes',minWidth:'300px'},
      {key:'date added',label:'Date'}
    ]},
    winlator:{ path: `${DATA_BASE}winlator.csv`, columns:[
      {key:'game',label:'Game'},{key:'performance',label:'Performance',isStatus:true},
      {key:'winlator version',label:'Winlator Version'},{key:'driver',label:'Driver'},
      {key:'dx wrapper',label:'DX Wrapper'},{key:'notes',label:'Notes',minWidth:'300px'},
      {key:'date added',label:'Date'}
    ]},
    gamehub:{ path: `${DATA_BASE}gamehub.csv`, columns:[
      {key:'game',label:'Game'},{key:'performance',label:'Performance',isStatus:true},
      {key:'game resolution',label:'Game Resolution'},{key:'driver',label:'Driver'},
      {key:'dxvk version',label:'DXVK Version'},{key:'vkd3d version',label:'VKD3D Version'},
      {key:'notes',label:'Notes',minWidth:'300px'},{key:'date added',label:'Date'}
    ]},
    ps3:{ path: `${DATA_BASE}ps3.csv`, columns:[
      {key:'game',label:'Game'},{key:'performance',label:'Performance',isStatus:true},
      {key:'emulator',label:'Emulator'},{key:'resolution',label:'Resolution'},
      {key:'driver',label:'Driver'},{key:'notes',label:'Notes',minWidth:'300px'},
      {key:'date added',label:'Date'}
    ]},
    psvita:{ path: `${DATA_BASE}psvita.csv`, columns:[
      {key:'game',label:'Game'},{key:'performance',label:'Performance',isStatus:true},
      {key:'driver',label:'Driver'},{key:'game title id',label:'Game Title ID'},
      {key:'notes',label:'Notes',minWidth:'300px'},{key:'date added',label:'Date'}
    ]},
    wiiu:{ path: `${DATA_BASE}wiiu.csv`, columns:[
      {key:'game',label:'Game'},{key:'performance',label:'Performance',isStatus:true},
      {key:'driver',label:'Driver'},{key:'pre-compiled shaders',label:'Pre-compiled Shaders'},
      {key:'notes',label:'Notes',minWidth:'300px'},{key:'date added',label:'Date'}
    ]}
  };

  const FORM_CONFIG = {
    switch: [
      { key: 'game',        label: 'Game',        required: true },
      { key: 'performance', label: 'Performance', required: true, type: 'select', suggestions: ['Perfect','Great','Playable','Unplayable'] },
      { key: 'driver',      label: 'Driver',      required: true },
      { key: 'emulator',    label: 'Emulator',    required: true }
    ],
    ps2: [
      { key: 'game',        label: 'Game',        required: true },
      { key: 'performance', label: 'Performance', required: true, type: 'select', suggestions: ['Perfect','Great','Playable','Unplayable'] },
      { key: 'emulator',    label: 'Emulator',    required: true },
      { key: 'resolution',  label: 'Resolution',  required: true },
      { key: 'rom region',  label: 'ROM Region',  required: true }
    ],
    winlator: [
      { key: 'game',             label: 'Game',             required: true },
      { key: 'performance',      label: 'Performance',      required: true, type: 'select', suggestions: ['Perfect','Great','Playable','Unplayable'] },
      { key: 'winlator version', label: 'Winlator Version', required: true },
      { key: 'driver',           label: 'Driver',           required: true },
      { key: 'dx wrapper',       label: 'DX Wrapper',       required: true }
    ],
    gamehub: [
      { key: 'game',             label: 'Game',             required: true },
      { key: 'performance',      label: 'Performance',      required: true, type: 'select', suggestions: ['Perfect','Great','Playable','Unplayable'] },
      { key: 'game resolution',  label: 'Game Resolution',  required: true },
      { key: 'driver',           label: 'Driver',           required: true },
      { key: 'dxvk version',     label: 'DXVK Version',     required: true },
      { key: 'vkd3d version',    label: 'VKD3D Version',    required: true }
    ],
    ps3: [
      { key: 'game',        label: 'Game',        required: true },
      { key: 'performance', label: 'Performance', required: true, type: 'select', suggestions: ['Perfect','Great','Playable','Unplayable'] },
      { key: 'emulator',    label: 'Emulator',    required: true },
      { key: 'resolution',  label: 'Resolution',  required: true },
      { key: 'driver',      label: 'Driver',      required: true }
    ],
    psvita: [
      { key: 'game',          label: 'Game',          required: true },
      { key: 'performance',   label: 'Performance',   required: true, type: 'select', suggestions: ['Perfect','Great','Playable','Unplayable'] },
      { key: 'driver',        label: 'Driver',        required: true },
      { key: 'game title id', label: 'Game Title ID', required: true }
    ],
    wiiu: [
      { key: 'game',                 label: 'Game',                 required: true },
      { key: 'performance',          label: 'Performance',          required: true, type: 'select', suggestions: ['Perfect','Great','Playable','Unplayable'] },
      { key: 'driver',               label: 'Driver',               required: true },
      { key: 'pre-compiled shaders', label: 'Pre-compiled Shaders', required: true, type: 'select', suggestions: ['Yes','No'] }
    ]
  };

  let masterDataCache = {};
  let activeDataSet = [];
  let currentlyDisplayedGames = [];
  const STORAGE_KEY = `rr:lastSystem:${CURRENT_DEVICE}`;
  let currentSystemId = localStorage.getItem(STORAGE_KEY) && SYSTEM_CONFIG[localStorage.getItem(STORAGE_KEY)]
    ? localStorage.getItem(STORAGE_KEY) : 'switch';
  let currentPage = 1;
  let sortColumn = SYSTEM_CONFIG[currentSystemId].columns[0].key;
  let sortDirection = 'asc';
  let perfFilter = '';

  const tableBody = document.querySelector('#compatibility-table tbody');
  const tableHead = document.querySelector('#compatibility-table thead');
  const searchBox = document.getElementById('game-search-box');
  const prevBtn = document.getElementById('prev-btn');
  const nextBtn = document.getElementById('next-btn');
  const pageInfo = document.getElementById('page-info');
  const formWrap = document.getElementById('add-entry-form-container');
  const formSystemSelect = document.getElementById('form-system-select');

  const uniqueCache = new Map();
  function getUniqueValues(systemId, key){
    if (key === 'performance') return ALLOWED_PERF.slice();
    const cacheKey = `${systemId}|${key}`;
    if (uniqueCache.has(cacheKey)) return uniqueCache.get(cacheKey);
    const rows = masterDataCache[systemId] || [];
    const set = new Set();
    for (const r of rows) {
      const v = (r?.[key] ?? '').toString().trim();
      if (v) set.add(v);
      if (set.size > 500) break;
    }
    const arr = Array.from(set).sort((a,b)=>a.localeCompare(b)).slice(0,500);
    uniqueCache.set(cacheKey, arr);
    return arr;
  }
  function makeDatalist(id, values){
    const dl = document.createElement('datalist');
    dl.id = id;
    dl.innerHTML = values.map(v=>`<option value="${v}"></option>`).join('');
    return dl;
  }
  function buildAddEntryForm(systemId){
    const container = document.getElementById('dynamic-fields');
    const hiddenSystem = document.getElementById('hidden-system');
    if (!container) return;
    container.innerHTML = '';
    hiddenSystem.value = systemId;

    const fields = FORM_CONFIG[systemId] || [];
    const fragment = document.createDocumentFragment();
    fields.forEach(f=>{
      const wrapper = document.createElement('div');
      const inputId = `field-${systemId}-${f.key.replace(/\s+/g,'-')}`;
      const datalistId = `list-${systemId}-${f.key.replace(/\s+/g,'-')}`;
      const csvValues = getUniqueValues(systemId, f.key);
      const defaults = Array.isArray(f.suggestions) ? f.suggestions : [];
      const mergedForTextInputs = [...defaults, ...csvValues.filter(v => !defaults.includes(v))];
      if (f.type === 'select') {
        const options = defaults.length ? defaults : csvValues;
        wrapper.innerHTML = `
          <label for="${inputId}" class="block mb-2 font-bold">${f.label}${f.required ? ' *' : ''}</label>
          <select id="${inputId}" name="${f.key}" class="form-input" ${f.required ? 'required' : ''}>
            ${options.map(opt=>`<option value="${opt}">${opt}</option>`).join('')}
          </select>`;
        fragment.appendChild(wrapper);
      } else {
        wrapper.innerHTML = `
          <label for="${inputId}" class="block mb-2 font-bold">${f.label}${f.required ? ' *' : ''}</label>
          <input id="${inputId}" name="${f.key}" class="form-input" list="${datalistId}" placeholder="${f.label}" ${f.required ? 'required' : ''}>`;
        const datalist = makeDatalist(datalistId, mergedForTextInputs);
        fragment.appendChild(wrapper);
        fragment.appendChild(datalist);
      }
    });
    container.appendChild(fragment);
    colorizePerformanceSelects(container);
  }

  async function fetchAndCacheData(systemId){
  if (masterDataCache[systemId]) return masterDataCache[systemId];
  const config = SYSTEM_CONFIG[systemId];
  if (!config) { masterDataCache[systemId] = []; return []; }

  return new Promise((resolve) => {
    let settled = false;
    const done = (arr) => { if (!settled) { settled = true; masterDataCache[systemId] = arr; resolve(arr); } };

    Papa.parse(`${config.path}?v=${Date.now()}`, {
      download: true,
      header: true,
      skipEmptyLines: 'greedy',
      dynamicTyping: false,
      // IMPORTANT: parse on main thread. Worker can silently hang on some hosts.
      worker: false,
      // the defaults for delimiter/quote/escape already handle your CSV correctly
      complete: (results) => {
        const rows = Array.isArray(results.data) ? results.data : [];
        const normalized = rows.map(r => {
          const o = {};
          for (const k in r) o[k.trim().toLowerCase()] = typeof r[k] === 'string' ? r[k].trim() : r[k];
          return o;
        });
        done(normalized);
      },
      error: (err) => {
        console.warn(`Papa.parse error for ${config.path}:`, err);
        done([]);
      }
    });

    // belt & suspenders: if something odd happens, don’t hang forever
    setTimeout(() => done(masterDataCache[systemId] || []), 10000);
  });
}


  async function ensureSystemDataCached(systemId){ if (!masterDataCache[systemId]) await fetchAndCacheData(systemId); }
  async function refreshFormForSystem(systemId){ await ensureSystemDataCached(systemId); buildAddEntryForm(systemId); document.getElementById('hidden-system').value = systemId; }
  async function refreshFormForCurrentSystem(){ await refreshFormForSystem(currentSystemId); }

  async function loadSystemData(systemId){
    currentSystemId = systemId;
    sortColumn = SYSTEM_CONFIG[currentSystemId].columns[0].key;
    sortDirection = 'asc';
    tableHead.innerHTML = '';
    tableBody.innerHTML = `<tr><td class="p-4 text-center">Loading reports...</td></tr>`;

    const allData = await fetchAndCacheData(systemId);

   // --- Build helpers for variant/chipset matching ---
const wantChip = currentVariant ? norm(currentVariant.id || currentVariant.label) : '';
const rows = allData; // we already fetched above

// Pool strictly by chipset. If we don't know the chipset, show nothing (accurate for new devices).
let rowsByChipset = wantChip
  ? rows.filter(r => norm(r.chipset || '') === wantChip)
  : [];

// Limit to the current system
const filtered = rowsByChipset.filter(
  row => normSystemId(row.system) === normSystemId(currentSystemId)
);


activeDataSet = filtered;

    renderTableStructure();

    if (!activeDataSet.length) {
      const colSpan = SYSTEM_CONFIG[currentSystemId].columns.length;
      tableBody.innerHTML = `
        <tr>
          <td colspan="${colSpan}" class="p-6 text-center">
            <div class="space-y-3">
              <div>No community reports yet for <span class="font-bold">${DEVICE.label}</span> on <span class="font-bold">${currentSystemId.toUpperCase()}</span>.</div>
              <button class="bg-yellow-400 hover:bg-yellow-500 text-black px-4 py-2 rounded retro-font text-xs"
                onclick="document.getElementById('add-entry-btn')?.click(); document.getElementById('add-entry-form-container')?.scrollIntoView({behavior:'smooth', block:'start'});">
                BE THE FIRST TO ADD ONE
              </button>
            </div>
          </td>
        </tr>`;
      updatePaginationControls();
      await refreshFormForSystem(currentSystemId);
      return;
    }

    applySearchAndSort();
    refreshFormForCurrentSystem();
  }

  function renderTableStructure(){
    const config = SYSTEM_CONFIG[currentSystemId];
    const headerCells = config.columns.map(col => `
      <th class="p-3" data-sort="${col.key}" style="${col.minWidth ? `min-width:${col.minWidth}` : ''}">
        ${col.label} <span class="sort-indicator"></span>
      </th>`).join('');
    tableHead.innerHTML = `<tr>${headerCells}</tr>`;
  }

  function updateSortIndicators(){
    tableHead.querySelectorAll('th').forEach(th=>{
      const ind = th.querySelector('.sort-indicator');
      if (!ind) return;
      ind.textContent = (th.dataset.sort === sortColumn)
        ? (sortDirection === 'asc' ? ' ▲' : ' ▼')
        : '';
    });
  }

  prevBtn?.addEventListener('click', () => {
  if (currentPage > 1) {
    currentPage--;
    displayCurrentPage();
  }
});

nextBtn?.addEventListener('click', () => {
  const totalPages = Math.ceil(currentlyDisplayedGames.length / rowsPerPage) || 1;
  if (currentPage < totalPages) {
    currentPage++;
    displayCurrentPage();
  }
});


  function displayCurrentPage(){
  updateSortIndicators();
  const startIndex = (currentPage - 1) * rowsPerPage;
  const endIndex = startIndex + rowsPerPage;
  const pageItems = currentlyDisplayedGames.slice(startIndex, endIndex);
  const config = SYSTEM_CONFIG[currentSystemId];
  const perfClass = {
    'Perfect':'perf-perfect','Great':'perf-great',
    'Playable':'perf-playable','Unplayable':'perf-unplayable'
  };

  if (!pageItems.length) {
    const message = (searchBox.value || '').trim()
      ? "No games found matching your search."
      : "No reports available.";
    tableBody.innerHTML =
      `<tr><td colspan="${config.columns.length}" class="p-4 text-center">${message}</td></tr>`;
    updatePaginationControls();
    return;
  }

  let html = '';
  for (const row of pageItems) {
    html += '<tr>';
    for (const col of config.columns) {
      const raw = row[col.key] ?? '';
      const display = (col.key === 'date added' || col.key === 'date')
        ? normalizeDateDisplay(raw)
        : raw;
      const cls = col.isStatus ? `p-3 font-bold ${perfClass[raw] || ''}` : 'p-3';
      html += `<td class="${cls}">${esc(display)}</td>`;
    }
    html += '</tr>';
  }
  tableBody.innerHTML = html;
  updatePaginationControls();
}


  function updatePaginationControls(){
    const totalPages = Math.ceil(currentlyDisplayedGames.length / rowsPerPage) || 1;
    pageInfo.textContent = `Page ${currentPage} of ${totalPages}`;
    prevBtn.disabled = currentPage === 1;
    nextBtn.disabled = currentPage === totalPages;
  }
  function updateURLState(){
    const params = new URLSearchParams(location.search);
    params.set('device', CURRENT_DEVICE);
    params.set('system', currentSystemId);
    const q = (searchBox.value || '').trim();
    const pf = (perfFilter || '').trim();
    if (q) params.set('q', q); else params.delete('q');
    if (pf) params.set('perf', pf); else params.delete('perf');
    history.replaceState(null, '', `${location.pathname}?${params.toString()}`);
  }
  function applySearchAndSort(){
    const searchTerm = (searchBox.value || '').toLowerCase();
    const firstKey = SYSTEM_CONFIG[currentSystemId].columns[0].key;
    let filtered = activeDataSet;

    if (perfFilter) filtered = filtered.filter(row => (row.performance || '') === perfFilter);
    if (searchTerm) filtered = filtered.filter(row => (row[firstKey] || '').toString().toLowerCase().includes(searchTerm));

    filtered.sort((a,b)=>{
      const A = getSortValue(a, sortColumn);
      const B = getSortValue(b, sortColumn);
      if (A < B) return sortDirection === 'asc' ? -1 : 1;
      if (A > B) return sortDirection === 'asc' ?  1 : -1;
      return 0;
    });

    currentlyDisplayedGames = filtered;
    currentPage = 1;
    displayCurrentPage();
    updateURLState();
  }

  function highlightSystemButton(systemId){
    document.querySelectorAll('#system-buttons button').forEach(b=>{
      b.classList.remove('bg-yellow-400','text-black');
      b.classList.add('bg-gray-600','text-white');
    });
    const activeBtn = document.querySelector(`#system-buttons [data-system="${systemId}"]`);
    if (activeBtn) {
      activeBtn.classList.remove('bg-gray-600','text-white');
      activeBtn.classList.add('bg-yellow-400','text-black');
    }
  }
  document.getElementById('system-buttons')?.addEventListener('click', (e)=>{
    const btn = e.target.closest('button[data-system]'); if (!btn) return;
    const systemId = btn.dataset.system; if (systemId === currentSystemId) return;
    localStorage.setItem(STORAGE_KEY, systemId);
    highlightSystemButton(systemId);
    loadSystemData(systemId);
  });

  const perfFilters = document.getElementById('perf-filters');
  perfFilters?.addEventListener('click', (e)=>{
    const btn = e.target.closest('button[data-perf]'); if (!btn) return;
    perfFilter = btn.dataset.perf || '';
    perfFilters.querySelectorAll('button').forEach(b=>b.classList.remove('ring-2','ring-yellow-400'));
    btn.classList.add('ring-2','ring-yellow-400');
    applySearchAndSort();
  });

  searchBox.addEventListener('input', debounce(applySearchAndSort, 200));
  tableHead.addEventListener('click', (e)=>{
    const th = e.target.closest('th'); if (!th || !th.dataset.sort) return;
    const newCol = th.dataset.sort;
    sortDirection = (sortColumn === newCol && sortDirection === 'asc') ? 'desc' : 'asc';
    sortColumn = newCol;
    applySearchAndSort();
  });

  const addBtn = document.getElementById('add-entry-btn');
  const cancelBtn = document.getElementById('cancel-btn');
  const formEl = document.getElementById('compatibility-form');

  addBtn?.addEventListener('click', async ()=>{
    formWrap.classList.toggle('hidden');
    if (!formWrap.classList.contains('hidden')) {
      document.getElementById('hidden-device').value = DEVICE.label;
      formSystemSelect.value = currentSystemId;
      ensureChipsetField();                 // inject Chipset picker only if >1 chipset
      await refreshFormForSystem(formSystemSelect.value); // build system fields

      // If there's a single chipset, we still store it silently on submit
      const sel = document.getElementById('form-chipset-select');
      if (sel && currentVariant) sel.value = currentVariant.id || currentVariant.label;
    }
  });
  cancelBtn?.addEventListener('click', ()=>formWrap.classList.add('hidden'));
  formSystemSelect?.addEventListener('change', async ()=>{
    await refreshFormForSystem(formSystemSelect.value);
    ensureChipsetField();
  });

  formEl?.addEventListener('submit', async (e)=>{
  e.preventDefault();

  const fd = new FormData(formEl);

  // Always store canonical device label (from the page you’re on)
  fd.set('device', DEVICE.label);

  // Store chipset
  const hasVariants = Array.isArray(DEVICE.variants) && DEVICE.variants.length > 0;
  if (hasVariants) {
    if (DEVICE.variants.length > 1) {
      const formChipset = (fd.get('chipset') || '').toString().trim();
      if (!formChipset) { alert('Please select a chipset.'); return; }
      fd.set('chipset', formChipset);
    } else {
      const only = DEVICE.variants[0];
      fd.set('chipset', only.id || only.label);
    }
  }

  // Normalize system & performance
  fd.set('system', formSystemSelect.value);
  const perfMap = { perfect:'Perfect', great:'Great', playable:'Playable', unplayable:'Unplayable' };
  const rawPerf = (fd.get('performance') || '').toString().trim();
  const normalizedPerf = perfMap[rawPerf.toLowerCase()] || rawPerf;
  if (!['Perfect','Great','Playable','Unplayable'].includes(normalizedPerf)) {
    alert('Please choose a valid Performance value.'); return;
  }
  fd.set('performance', normalizedPerf);

  // Provide default notes if blank
  if (!fd.get('notes')) fd.set('notes','-');

  // Convert to JSON
  const payload = {};
  fd.forEach((v,k)=>{ payload[k]=v; });

 // Build plain object safely
const guard = s => typeof s === 'string' && /^[=+\-@]/.test(s) ? "'" + s : s;
const obj = {}; fd.forEach((v,k)=>{ obj[k]=guard(v); });

// Send to backend
try {
  const res = await fetch('/api/compat/submit', {
    method: 'POST',
    headers: { 'Content-Type':'application/json' },
    body: JSON.stringify(obj)
  });
  if (!res.ok) throw new Error(`HTTP ${res.status}`);
  await res.json(); // optional: read the normalized row

  alert('Thanks! Your report was added.');
  formEl.reset();
  document.getElementById('hidden-device').value = DEVICE.label;
  document.getElementById('hidden-system').value = formSystemSelect.value;

  // Refresh the table so the new row appears immediately
  await loadSystemData(currentSystemId);
} catch (err) {
  console.error(err);
  alert('Sorry, failed to submit. Please try again.');
}

});


  (function hydrateFromURL(){
    const params = new URLSearchParams(location.search);
    const sys = params.get('system');
    const q = params.get('q') || '';
    const pf = params.get('perf') || '';
    if (sys && SYSTEM_CONFIG[sys]) currentSystemId = sys;
    if (q) searchBox.value = q;
    if (pf) {
      perfFilter = pf;
      const btn = document.querySelector(`#perf-filters [data-perf="${pf}"]`);
      btn?.classList.add('ring-2','ring-yellow-400');
    }
  })();

  highlightSystemButton(currentSystemId);
  loadSystemData(currentSystemId);
});

</script>

</body>
</html>
