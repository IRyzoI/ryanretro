<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ryan Retro | Device Hub</title>

    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
    <link href="https://unpkg.com/aos@2.3.1/dist/aos.css" rel="stylesheet">
    <script src="https://unpkg.com/aos@2.3.1/dist/aos.js"></script>

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@500;700;800&family=JetBrains+Mono:wght@400;700&display=swap" rel="stylesheet">

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        brand: {
                            bg: '#2D1B4E',       // Deep Soft Purple
                            card: '#432C7A',     // Lighter Grape
                            hover: '#5B3EA8',    // Bright Purple
                            accent: '#FFFFFF',   // Pure White
                            muted: '#D4BBFF',    // Soft Lavender Text
                            red: '#FF0000'       // YouTube Red
                        }
                    },
                    fontFamily: {
                        sans: ['"Plus Jakarta Sans"', 'sans-serif'],
                        mono: ['"JetBrains Mono"', 'monospace'],
                    }
                }
            }
        }
    </script>

    <style>
        /* Custom Scrollbar */
        .custom-scrollbar::-webkit-scrollbar { height: 8px; width: 8px; display: block; }
        .custom-scrollbar::-webkit-scrollbar-track { background: rgba(0, 0, 0, 0.2); border-radius: 10px; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: rgba(255, 255, 255, 0.15); border-radius: 10px; transition: background 0.3s; }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: rgba(255, 255, 255, 0.3); }

        /* Animations */
        @keyframes float { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-10px); } }
        .animate-float { animation: float 6s ease-in-out infinite; }

        @keyframes popIn { 0% { opacity: 0; transform: scale(0.95); } 100% { opacity: 1; transform: scale(1); } }
        .animate-pop-in { animation: popIn 0.3s cubic-bezier(0.16, 1, 0.3, 1); }

        /* Toast */
        #toast {
            visibility: hidden; min-width: 250px; background-color: #5B3EA8; color: white;
            text-align: center; border-radius: 12px; padding: 16px; position: fixed; z-index: 1000;
            left: 50%; bottom: 30px; transform: translateX(-50%);
            font-weight: bold; box-shadow: 0 10px 30px rgba(0,0,0,0.5);
            border: 1px solid rgba(255,255,255,0.1);
        }
        #toast.show { visibility: visible; animation: fadein 0.5s, fadeout 0.5s 2.5s; }
        @keyframes fadein { from {bottom: 0; opacity: 0;} to {bottom: 30px; opacity: 1;} }
        @keyframes fadeout { from {bottom: 30px; opacity: 1;} to {bottom: 0; opacity: 0;} }

        /* Table Styles */
        .sort-indicator { display: inline-block; width: 1.2em; text-align: center; }

        /* Performance Badge Colors (Table & Form) */
        .perf-perfect { color: #4ade80; background: rgba(74, 222, 128, 0.1); border: 1px solid rgba(74, 222, 128, 0.2); }
        .perf-great { color: #38bdf8; background: rgba(56, 189, 248, 0.1); border: 1px solid rgba(56, 189, 248, 0.2); }
        .perf-playable { color: #facc15; background: rgba(250, 204, 21, 0.1); border: 1px solid rgba(250, 204, 21, 0.2); }
        .perf-unplayable { color: #f87171; background: rgba(248, 113, 113, 0.1); border: 1px solid rgba(248, 113, 113, 0.2); }

        /* Form Elements */
        .brand-input {
            background: rgba(0,0,0,0.2);
            border: 1px solid rgba(255,255,255,0.1);
            color: white;
            transition: all 0.2s;
        }
        .brand-input:focus {
            outline: none;
            border-color: #D4BBFF;
            background: rgba(0,0,0,0.4);
        }
    </style>
</head>
<body class="bg-brand-bg text-brand-accent font-sans antialiased min-h-screen flex flex-col selection:bg-white selection:text-brand-bg">

    <div id="toast">Code Copied!</div>

    <header class="sticky top-0 z-50 bg-brand-bg/95 backdrop-blur-sm border-b border-brand-card">
        <div class="container mx-auto px-4 lg:px-6 h-20 flex justify-between items-center">

            <a href="/" class="flex items-center gap-3 group shrink-0">
                <div class="w-10 h-10 rounded-full overflow-hidden border-2 border-white/20 group-hover:border-white transition-colors">
                    <img src="https://raw.githubusercontent.com/IRyzoI/ryanretro/refs/heads/main/images/ryanretrologo.jpg" class="w-full h-full object-cover">
                </div>
                <span class="font-bold text-lg tracking-tight hidden sm:block">Ryan Retro</span>
            </a>

            <nav class="hidden lg:flex items-center gap-6 bg-brand-card/30 px-6 py-2 rounded-full border border-white/5">
                <a href="/benchmarks" class="text-sm font-bold text-brand-muted hover:text-white transition-colors">Benchmarks</a>
                <a href="/patrons" class="text-sm font-bold text-brand-muted hover:text-white transition-colors">Patrons</a>
                <a href="/reviews" class="text-sm font-bold text-brand-muted hover:text-white transition-colors">Reviews</a>
                <a href="/store" class="text-sm font-bold text-brand-muted hover:text-white transition-colors">Shop</a>
            </nav>

            <div class="flex items-center gap-4">
                <div class="hidden md:flex items-center gap-2 pr-4 border-r border-brand-card/50">
                    <a href="https://www.youtube.com/@RyanRetro" target="_blank" class="text-brand-muted hover:text-white transition-colors p-1"><i data-lucide="youtube" class="w-4 h-4"></i></a>
                    <a href="https://x.com/RyanRetroYT" target="_blank" class="text-brand-muted hover:text-white transition-colors p-1"><i data-lucide="twitter" class="w-4 h-4"></i></a>
                    <a href="https://www.instagram.com/ryanretroyoutube/" target="_blank" class="text-brand-muted hover:text-white transition-colors p-1"><i data-lucide="instagram" class="w-4 h-4"></i></a>
                    <a href="https://www.tiktok.com/@ryanretroyoutube" target="_blank" class="text-brand-muted hover:text-white transition-colors p-1">
                        <svg viewBox="0 0 24 24" class="w-4 h-4 fill-current"><path d="M19.59 6.69a4.83 4.83 0 0 1-3.77-4.25V2h-3.45v13.67a2.89 2.89 0 0 1-5.2 1.74 2.89 2.89 0 0 1 2.31-4.64 2.93 2.93 0 0 1 .88.13V9.4a6.84 6.84 0 0 0-1-.05A6.33 6.33 0 0 0 5 20.1a6.34 6.34 0 0 0 10.86-4.43v-7a8.16 8.16 0 0 0 4.77 1.52v-3.4a4.85 4.85 0 0 1-1-.1z"/></svg>
                    </a>
                    <a href="https://discord.gg/RAenS43UV9" target="_blank" class="text-brand-muted hover:text-white transition-colors p-1"><i data-lucide="message-circle" class="w-4 h-4"></i></a>
                    <a href="https://www.facebook.com/RyanRetroYT" target="_blank" class="text-brand-muted hover:text-white transition-colors p-1"><i data-lucide="facebook" class="w-4 h-4"></i></a>
                    <a href="https://www.threads.com/@ryanretroyoutube" target="_blank" class="text-brand-muted hover:text-white transition-colors p-1"><i data-lucide="at-sign" class="w-4 h-4"></i></a>
                </div>

                 <button id="mobile-menu-btn" class="lg:hidden text-white p-2">
                    <i data-lucide="menu" class="w-6 h-6"></i>
                </button>
            </div>
        </div>

        <div id="mobile-menu" class="hidden lg:hidden bg-brand-card border-t border-brand-hover absolute w-full left-0 top-full p-4 flex flex-col gap-4 shadow-xl z-50">
            <div class="grid grid-cols-2 gap-2">
                <a href="/benchmarks" class="p-3 bg-brand-bg rounded-md text-center text-sm font-bold text-white hover:bg-white/5">Benchmarks</a>
                <a href="/patrons" class="p-3 bg-brand-bg rounded-md text-center text-sm font-bold text-white hover:bg-white/5">Patrons</a>
                <a href="/reviews" class="p-3 bg-brand-bg rounded-md text-center text-sm font-bold text-white hover:bg-white/5">Reviews</a>
                <a href="/store" class="p-3 bg-brand-bg rounded-md text-center text-sm font-bold text-white hover:bg-white/5">Shop</a>
            </div>

            <div class="flex justify-center flex-wrap gap-4 pt-4 border-t border-white/10">
                <a href="https://www.youtube.com/@RyanRetro" class="text-brand-muted"><i data-lucide="youtube" class="w-5 h-5"></i></a>
                <a href="https://x.com/RyanRetroYT" class="text-brand-muted"><i data-lucide="twitter" class="w-5 h-5"></i></a>
                <a href="https://www.instagram.com/ryanretroyoutube/" class="text-brand-muted"><i data-lucide="instagram" class="w-5 h-5"></i></a>
                <a href="https://www.tiktok.com/@ryanretroyoutube" class="text-brand-muted"><svg viewBox="0 0 24 24" class="w-5 h-5 fill-current"><path d="M19.59 6.69a4.83 4.83 0 0 1-3.77-4.25V2h-3.45v13.67a2.89 2.89 0 0 1-5.2 1.74 2.89 2.89 0 0 1 2.31-4.64 2.93 2.93 0 0 1 .88.13V9.4a6.84 6.84 0 0 0-1-.05A6.33 6.33 0 0 0 5 20.1a6.34 6.34 0 0 0 10.86-4.43v-7a8.16 8.16 0 0 0 4.77 1.52v-3.4a4.85 4.85 0 0 1-1-.1z"/></svg></a>
                <a href="https://discord.gg/RAenS43UV9" class="text-brand-muted"><i data-lucide="message-circle" class="w-5 h-5"></i></a>
                <a href="https://www.facebook.com/RyanRetroYT" class="text-brand-muted"><i data-lucide="facebook" class="w-5 h-5"></i></a>
                <a href="https://www.threads.com/@ryanretroyoutube" class="text-brand-muted"><i data-lucide="at-sign" class="w-5 h-5"></i></a>
            </div>
        </div>
    </header>

    <main class="flex-grow container mx-auto px-4 lg:px-6 py-8">

        <section id="hub" class="mb-12" data-aos="fade-up">
            <div class="grid grid-cols-1 lg:grid-cols-12 gap-6 items-stretch">

                <div class="lg:col-span-4 h-full flex flex-col">
                    <div class="bg-brand-card rounded-2xl p-6 flex flex-col h-full relative overflow-hidden border border-white/5 shadow-xl">
                        <div class="flex justify-between items-start mb-4 relative z-10">
                            <h1 id="device-name" class="font-extrabold text-3xl text-white uppercase leading-none tracking-tight">DEVICE<br>NAME</h1>
                        </div>

                        <div class="flex-grow flex items-center justify-center py-6 relative z-10 min-h-[200px]">
                            <img id="device-img" src="" class="w-64 object-contain animate-float drop-shadow-2xl" alt="Device">
                        </div>

                        <a id="affiliate-btn" href="#" target="_blank" class="w-full py-4 bg-white text-brand-bg font-bold rounded-xl flex items-center justify-center gap-2 hover:bg-brand-muted transition-colors relative z-10 mt-auto">
                            <span>Buy Now</span> <i data-lucide="arrow-right" class="w-4 h-4"></i>
                        </a>
                        <p class="text-[10px] font-bold text-brand-muted text-center mt-3 uppercase tracking-wider relative z-10">Affiliate Link • Supports The Channel</p>
                    </div>
                </div>

                <div class="lg:col-span-8 h-full flex flex-col">
                    <div class="bg-brand-card rounded-2xl p-1 overflow-hidden border border-white/5 shadow-xl h-full flex flex-col">
                        <div class="flex justify-between items-center p-4">
                            <h2 class="font-bold text-white text-lg flex items-center gap-2">
                                <i data-lucide="play-circle" class="text-brand-muted w-5 h-5"></i> Video Review
                            </h2>
                            <a id="channel-link" href="#" target="_blank" class="text-xs font-bold text-brand-muted hover:text-white transition-colors">
                                View Channel &rarr;
                            </a>
                        </div>
                        <div id="main-video-embed" class="bg-black rounded-xl overflow-hidden relative flex-grow min-h-[300px] lg:min-h-0">
                            <div class="absolute inset-0 flex items-center justify-center text-white/20 font-bold animate-pulse">LOADING VIDEO...</div>
                        </div>
                        <div class="p-4">
                            <h2 id="video-title" class="text-xl font-bold text-white line-clamp-1">Loading Video Title...</h2>
                            <p class="text-sm font-medium text-brand-muted" id="video-date">...</p>
                        </div>
                    </div>
                </div>

            </div>
        </section>

        <section id="database" data-aos="fade-up">
            <div class="bg-brand-card rounded-2xl border border-white/5 p-6 lg:p-10 shadow-xl overflow-hidden relative">

                <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-8 gap-4">
                    <div>
                        <h2 class="text-3xl font-extrabold text-white">Compatibility</h2>
                        <p class="text-brand-muted text-sm mt-1">Community tested performance reports</p>
                    </div>
                    <div id="variant-tabs" class="hidden">
                         <div class="inline-flex flex-wrap gap-2 bg-brand-bg p-1 rounded-lg"></div>
                    </div>
                </div>

                <div id="system-buttons" class="flex flex-wrap gap-2 mb-6 pb-4 border-b border-white/5">
                    <button data-system="switch" class="system-btn">Switch</button>
                    <button data-system="ps2" class="system-btn">PS2</button>
                    <button data-system="ps3" class="system-btn">PS3</button>
                    <button data-system="psvita" class="system-btn">PS Vita</button>
                    <button data-system="winlator" class="system-btn">Winlator</button>
                    <button data-system="gamehub" class="system-btn">GameHub</button>
                    <button data-system="wiiu" class="system-btn">Wii U</button>
                </div>

                <div class="bg-brand-bg/30 rounded-xl p-4 mb-6 border border-white/5">
                    <div class="flex flex-col md:flex-row gap-4 justify-between items-end md:items-center">
                        <div id="perf-filters" class="flex flex-wrap gap-2">
                            <button data-perf="" class="perf-btn">All</button>
                            <button data-perf="Perfect" class="perf-btn">Perfect</button>
                            <button data-perf="Great" class="perf-btn">Great</button>
                            <button data-perf="Playable" class="perf-btn">Playable</button>
                            <button data-perf="Unplayable" class="perf-btn">Unplayable</button>
                        </div>

                        <div class="flex gap-2 w-full md:w-auto">
                            <div class="relative flex-grow md:flex-grow-0 md:w-64">
                                <i data-lucide="search" class="absolute left-3 top-1/2 transform -translate-y-1/2 text-brand-muted w-4 h-4"></i>
                                <input type="text" id="game-search-box" class="w-full bg-brand-bg border border-brand-card rounded-lg pl-10 pr-4 py-2 text-sm text-white focus:outline-none focus:border-brand-muted transition-colors placeholder-brand-muted/50" placeholder="Search games...">
                            </div>
                            <select id="rows-per-page" class="bg-brand-bg border border-brand-card rounded-lg px-2 text-sm text-white focus:outline-none cursor-pointer">
                                <option value="10" selected>10</option>
                                <option value="20">20</option>
                                <option value="50">50</option>
                            </select>
                        </div>
                    </div>
                </div>

                <div class="overflow-x-auto custom-scrollbar rounded-xl border border-white/5 bg-brand-bg/20">
                    <table id="compatibility-table" class="min-w-full text-sm text-left">
                        <thead class="bg-brand-bg text-brand-muted font-bold text-xs uppercase tracking-wider cursor-pointer select-none">
                            </thead>
                        <tbody class="divide-y divide-white/5 align-baseline text-white/90">
                            </tbody>
                    </table>
                </div>

                <div id="pagination-controls" class="mt-6 flex items-center justify-center gap-4">
                    <button id="prev-btn" class="bg-brand-bg hover:bg-brand-hover text-white px-4 py-2 rounded-lg font-bold text-xs disabled:opacity-50 disabled:cursor-not-allowed transition-colors">Previous</button>
                    <span id="page-info" class="font-bold text-sm text-brand-muted">Page 1 of 1</span>
                    <button id="next-btn" class="bg-brand-bg hover:bg-brand-hover text-white px-4 py-2 rounded-lg font-bold text-xs disabled:opacity-50 disabled:cursor-not-allowed transition-colors">Next</button>
                </div>

                <div class="text-center mt-12 border-t border-white/5 pt-8">
                    <p class="text-brand-muted text-sm mb-4">Don't see a game? Help the community.</p>
                    <button id="add-entry-btn" class="bg-white text-brand-bg px-8 py-3 rounded-xl font-bold shadow-lg hover:scale-105 transition-transform">
                        ADD YOUR ENTRY
                    </button>
                </div>

                <div id="add-entry-form-container" class="hidden mt-8 bg-brand-bg p-6 rounded-xl border border-white/10 animate-pop-in">
                      <h3 class="font-bold text-xl text-white mb-6">Submit Report</h3>
                      <form id="compatibility-form" class="grid grid-cols-1 md:grid-cols-2 gap-4">

                        <div class="md:col-span-2">
                            <label for="form-game-title" class="block text-xs font-bold text-brand-muted mb-1">Game Title *</label>
                            <input type="text" id="form-game-title" name="game" class="brand-input w-full rounded-lg px-4 py-2" required placeholder="e.g. Super Mario Odyssey">
                        </div>

                        <div>
                             <label for="form-system-select" class="block text-xs font-bold text-brand-muted mb-1">System *</label>
                             <select id="form-system-select" name="system" class="brand-input w-full rounded-lg px-4 py-2" required>
                                 <option value="switch">Nintendo Switch</option>
                                 <option value="ps2">PlayStation 2</option>
                                 <option value="ps3">PlayStation 3</option>
                                 <option value="psvita">PS Vita</option>
                                 <option value="winlator">Winlator</option>
                                 <option value="gamehub">GameHub</option>
                                 <option value="wiiu">Wii U</option>
                             </select>
                        </div>

                        <div>
                            <label for="form-performance" class="block text-xs font-bold text-brand-muted mb-1">Performance *</label>
                            <select id="form-performance" name="performance" class="brand-input w-full rounded-lg px-4 py-2" required>
                                <option value="Perfect">Perfect</option>
                                <option value="Great">Great</option>
                                <option value="Playable">Playable</option>
                                <option value="Unplayable">Unplayable</option>
                            </select>
                        </div>

                        <div id="dynamic-fields" class="md:col-span-2 grid grid-cols-1 md:grid-cols-2 gap-4"></div>

                        <div class="md:col-span-2">
                            <label class="block text-xs font-bold text-brand-muted mb-1">Notes (Optional)</label>
                            <textarea name="notes" class="brand-input w-full rounded-lg px-4 py-2" rows="3" placeholder="Any special settings?"></textarea>
                        </div>

                        <div class="md:col-span-2 flex justify-end gap-3 mt-4 pt-4 border-t border-white/10">
                            <button type="button" id="cancel-btn" class="px-4 py-2 rounded-lg bg-brand-card hover:bg-brand-hover text-white font-bold text-sm transition-colors">Cancel</button>
                            <button type="submit" class="px-6 py-2 rounded-lg bg-white text-brand-bg font-bold text-sm shadow-lg hover:bg-brand-muted transition-colors flex items-center justify-center gap-2">Submit</button>
                        </div>
                        <input type="hidden" id="hidden-device" name="device">
                        <input type="hidden" id="hidden-system" name="system">
                      </form>
                </div>

            </div>
        </section>

    </main>

    <footer class="bg-brand-bg border-t border-brand-card py-12 text-center">
        <div class="container mx-auto px-6">
            <div class="flex justify-center flex-wrap gap-6 mb-6">
                <a href="https://www.youtube.com/@RyanRetro" target="_blank" class="text-brand-muted hover:text-white transition-colors hover:scale-110"><i data-lucide="youtube" class="w-6 h-6"></i></a>
                <a href="https://x.com/RyanRetroYT" target="_blank" class="text-brand-muted hover:text-white transition-colors hover:scale-110"><i data-lucide="twitter" class="w-6 h-6"></i></a>
                <a href="https://www.instagram.com/ryanretroyoutube/" target="_blank" class="text-brand-muted hover:text-white transition-colors hover:scale-110"><i data-lucide="instagram" class="w-6 h-6"></i></a>
                <a href="https://www.tiktok.com/@ryanretroyoutube" target="_blank" class="text-brand-muted hover:text-white transition-colors hover:scale-110"><svg viewBox="0 0 24 24" class="w-6 h-6 fill-current"><path d="M19.59 6.69a4.83 4.83 0 0 1-3.77-4.25V2h-3.45v13.67a2.89 2.89 0 0 1-5.2 1.74 2.89 2.89 0 0 1 2.31-4.64 2.93 2.93 0 0 1 .88.13V9.4a6.84 6.84 0 0 0-1-.05A6.33 6.33 0 0 0 5 20.1a6.34 6.34 0 0 0 10.86-4.43v-7a8.16 8.16 0 0 0 4.77 1.52v-3.4a4.85 4.85 0 0 1-1-.1z"/></svg></a>
                <a href="https://discord.gg/RAenS43UV9" target="_blank" class="text-brand-muted hover:text-white transition-colors hover:scale-110"><i data-lucide="message-circle" class="w-6 h-6"></i></a>
                <a href="https://www.facebook.com/RyanRetroYT" target="_blank" class="text-brand-muted hover:text-white transition-colors hover:scale-110"><i data-lucide="facebook" class="w-6 h-6"></i></a>
                <a href="https://www.threads.com/@ryanretroyoutube" target="_blank" class="text-brand-muted hover:text-white transition-colors hover:scale-110"><i data-lucide="at-sign" class="w-6 h-6"></i></a>
            </div>
            <p class="text-xs text-brand-muted font-bold uppercase tracking-widest">© 2026 Ryan Retro</p>
        </div>
    </footer>

    <div id="game-details-modal" class="fixed inset-0 z-50 hidden flex items-center justify-center p-4">
        <div class="absolute inset-0 bg-brand-bg/90 backdrop-blur-sm" id="game-modal-bg"></div>
        <div id="game-card-wrapper" class="relative bg-brand-card border-2 border-white/20 rounded-3xl w-full max-w-4xl shadow-2xl animate-pop-in flex flex-col max-h-[90vh] overflow-hidden">
            <div class="flex justify-between items-center p-4 border-b border-white/10 bg-black/20 shrink-0">
                <span class="font-bold text-brand-muted text-xs pl-2 tracking-widest uppercase">REPORT DETAILS</span>
                <div class="flex gap-2">
                    <button id="screenshot-game-modal" class="text-white/70 hover:text-white hover:bg-white/10 p-2 rounded-lg transition-colors flex items-center gap-2" title="Save Card">
                        <i data-lucide="camera" class="w-5 h-5"></i>
                        <span class="font-bold text-xs hidden sm:inline">SAVE CARD</span>
                    </button>
                    <button id="close-game-modal" class="text-white/70 hover:text-white hover:bg-red-500/20 p-2 rounded-lg transition-colors">
                        <i data-lucide="x" class="w-5 h-5"></i>
                    </button>
                </div>
            </div>
            <div id="game-modal-content" class="overflow-y-auto custom-scrollbar p-6 md:p-8 grow text-white"></div>
        </div>
    </div>

<script>
    // --- HELPER FUNCTIONS ---
    function showToast(message) {
        const toast = document.getElementById("toast");
        toast.innerText = message;
        toast.className = "show";
        setTimeout(function(){ toast.className = toast.className.replace("show", ""); }, 3000);
    }

    const norm = s => (s || '').trim().toLowerCase();

    // --- DATA CONFIGURATION ---
    const DEVICE_CONFIG = {
      "Retroid Pocket 5": {
        name: "Retroid Pocket 5",
        img: "https://raw.githubusercontent.com/IRyzoI/ryanretro/refs/heads/main/images/carousel/rp5.png",
        link: "https://www.goretroid.com/products/retroid-pocket-5-handheld?sca_ref=7339476.fIz7oKv7uT",
        linkText: "Buy Now",
        chipset: "Snapdragon 865", screen: "5.5\" 1080p OLED", battery: "5000 mAh", os: "Android 13", ram: "8GB", storage: "128GB",
        score: 9.5,
        reviewShort: "A beautiful OLED screen and surprisingly great performance make the Retroid Pocket 5 one of the best handhelds. Surprisingly premium for the price.",
        pros: ["Stunning OLED Screen", "Great Performance", "Premium Build Quality"],
        cons: ["D-pad up top is uncomfortable for some", "Comfort could be better"],
        ytId: "UCh9GxjM-FNuSWv7xqn3UKVw", ytQuery: "retroid pocket 5", ytUrl: "https://www.youtube.com/@RyanRetro/search?query=retroid%20pocket%205",
        aliases: ["Retroid Pocket5","RP5"],
        variants: [{id: "sd865", label: "Snapdragon 865"}]
      },
      "Retroid Pocket 6": {
        name: "Retroid Pocket 6",
        img: "https://huggingface.co/spaces/IRyzoI/RyanRetro/resolve/main/images/rp6.png",
        link: "https://www.goretroid.com/collections/retro-game-system/products/retroid-pocket-6-handheld?sca_ref=7339476.fIz7oKv7uT",
        chipset: "Snapdragon 8 Gen 2", screen: "5.5\" 1080p OLED", battery: "6000 mAh", os: "Android 14", ram: "8/12GB", storage: "128/256GB",
        score: 9.8,
        reviewShort: "A flagship killer. Switch emulation in your pocket has never been this good.",
        pros: ["Insane Power", "Active Cooling", "Analog Triggers"],
        cons: ["Price increase", "Heavier"],
        ytId: "UCh9GxjM-FNuSWv7xqn3UKVw", ytQuery: "retroid pocket 6", ytUrl: "https://www.youtube.com/@RyanRetro/search?query=retroid%20pocket%206",
        aliases: ["Retroid 6","RP6"],
        variants: [{id: "sd8g2", label: "Snapdragon 8 Gen 2"}]
      },
      "Retroid Pocket G2": {
        name: "Retroid Pocket G2",
        img: "https://raw.githubusercontent.com/IRyzoI/ryanretro/refs/heads/main/images/carousel/rpg2.png",
        link: "https://www.goretroid.com/products/retroid-pocket-g2-handheld?sca_ref=7339476.fIz7oKv7uT",
        chipset: "Snapdragon G2 Gen 2", screen: "6\" LCD", battery: "8000mAh", os: "Android", ram: "8GB", storage: "128GB",
        score: 8.5,
        reviewShort: "A big screen streaming beast, essentially a Retroid Pocket 5 XL.",
        pros: ["Huge Screen", "Comfortable", "Great Streaming"],
        cons: ["LCD not OLED", "Lower Performance than RP6"],
        ytId: "UCh9GxjM-FNuSWv7xqn3UKVw", ytQuery: "retroid pocket g2", ytUrl: "https://www.youtube.com/@RyanRetro/search?query=retroid%20pocket%20g2",
        aliases: ["Retroid G2", "RP G2"],
        variants: [{id: "g2g2", label: "Snapdragon G2 Gen 2"}]
      },
      "Retroid Pocket Classic": {
        name: "Retroid Pocket Classic",
        img: "https://raw.githubusercontent.com/IRyzoI/ryanretro/refs/heads/main/images/carousel/rpclassic.png",
        link: "https://www.goretroid.com/products/retroid-pocket-classic?sca_ref=7339476.fIz7oKv7uT",
        chipset: "Snapdragon G1", screen: "4:3 OLED", battery: "4000 mAh", os: "Android", ram: "6GB", storage: "128GB",
        score: 9.4,
        reviewShort: "The ultimate 4:3 device for retro purists.",
        pros: ["4:3 OLED", "Perfect for PS2/GC", "Classic aesthetics"],
        cons: ["Not for modern gaming", "Mono speaker"],
        ytId: "UCh9GxjM-FNuSWv7xqn3UKVw", ytQuery: "retroid pocket classic", ytUrl: "https://www.youtube.com/@RyanRetro/search?query=retroid%20pocket%20classic",
        aliases: ["Retroid Classic","RP Classic"],
        variants: [{id: "g1g2", label: "Snapdragon G1 Gen 2"}]
      },
      "Retroid Pocket Mini": {
        name: "Retroid Pocket Mini",
        img: "https://raw.githubusercontent.com/IRyzoI/ryanretro/refs/heads/main/images/carousel/rpmini.png",
        link: "https://www.goretroid.com/products/retroid-pocket-mini-v2-handheld?sca_ref=7339476.fIz7oKv7uT",
        chipset: "Snapdragon 865", screen: "3.7\" 960p OLED", battery: "4000 mAh", os: "Android 13", ram: "6GB", storage: "128GB",
        score: 9.6,
        reviewShort: "A 4:3 OLED masterpiece. The perfect pocket companion with way more power than it needs.",
        pros: ["Incredible OLED", "Very Powerful", "Pocketable"],
        cons: ["Small screen for streaming", "Pricey for size"],
        ytId: "UCh9GxjM-FNuSWv7xqn3UKVw", ytQuery: "retroid pocket mini", ytUrl: "https://www.youtube.com/@RyanRetro/search?query=retroid%20pocket%20mini",
        aliases: ["RP Mini"],
        variants: [{id: "sd865", label: "Snapdragon 865"}]
      },
      "Retroid Pocket Flip 2": {
        name: "Retroid Pocket Flip 2",
        img: "https://raw.githubusercontent.com/IRyzoI/ryanretro/refs/heads/main/images/carousel/flip2.png",
        link: "https://www.goretroid.com/products/retroid-pocket-flip-2?sca_ref=7339476.fIz7oKv7uT",
        chipset: "Snapdragon 865", screen: "4.7\" Touch", battery: "5000 mAh", os: "Android", ram: "8GB", storage: "128GB",
        score: 9.2,
        reviewShort: "Clamshell perfection returns with updated internals.",
        pros: ["Clamshell Design", "Protectable Screen", "Good Sliders"],
        cons: ["Hinge durability concern", "Smaller screen"],
        ytId: "UCh9GxjM-FNuSWv7xqn3UKVw", ytQuery: "retroid pocket flip 2", ytUrl: "https://www.youtube.com/@RyanRetro/search?query=retroid%20pocket%20flip%202",
        aliases: ["RP Flip 2", "Flip 2"],
        variants: [{id: "sd865", label: "Snapdragon 865"}]
      },
      "Odin 2 Portal": {
        name: "Odin 2 Portal",
        img: "https://raw.githubusercontent.com/IRyzoI/ryanretro/refs/heads/main/images/carousel/portal.png",
        link: "https://www.ayntec.com/products/odin2-portal?sca_ref=8254425.fM33Fgl5td",
        chipset: "SD 8 Gen 2", screen: "7\" 120Hz OLED", battery: "8000 mAh", os: "Android 13", ram: "12GB", storage: "512GB",
        score: 9.7,
        reviewShort: "The premium OLED handheld experience. Expensive, but flawless.",
        pros: ["Incredible 120Hz OLED", "Top Tier Performance", "Premium Build"],
        cons: ["Expensive", "Large Footprint"],
        ytId: "UCh9GxjM-FNuSWv7xqn3UKVw", ytQuery: "odin 2 portal", ytUrl: "https://www.youtube.com/@RyanRetro/search?query=odin%202%20portal",
        aliases: ["Odin2 Portal"],
        variants: [{id: "sd8g2", label: "Snapdragon 8 Gen 2"}]
      },
      "AYN Odin 3": {
        name: "AYN Odin 3",
        img: "https://raw.githubusercontent.com/IRyzoI/ryanretro/refs/heads/main/images/carousel/odin3.png",
        link: "https://www.ayntec.com/products/ayn-odin-3?sca_ref=8254425.fM33Fgl5td",
        chipset: "Snapdragon 8 Elite", screen: "6\" 1080p 120Hz AMOLED", battery: "8000 mAh", os: "Android 15", ram: "12-24GB", storage: "256GB+",
        score: 9.9,
        reviewShort: "The most powerful Android handheld ever made. Overkill in the best way possible.",
        pros: ["Snapdragon 8 Elite", "120Hz AMOLED", "Wi-Fi 7"],
        cons: ["Very Expensive", "Overkill for retro"],
        ytId: "UCh9GxjM-FNuSWv7xqn3UKVw", ytQuery: "ayn odin 3", ytUrl: "https://www.youtube.com/@RyanRetro/search?query=ayn%20odin%203",
        aliases: ["Odin3"],
        variants: [{id: "sd8elite", label: "Snapdragon 8 Elite"}]
      },
      "Ayaneo Konkr Pocket Fit": {
        name: "Ayaneo Konkr Pocket Fit",
        img: "https://raw.githubusercontent.com/IRyzoI/ryanretro/refs/heads/main/images/carousel/konkr.png",
        link: "https://ayaneo.com/goods/9409042546933",
        chipset: "Snapdragon G3x Gen 3", screen: "6\" 1080p 144Hz LCD", battery: "8000 mAh", os: "Android", ram: "8GB+", storage: "128GB+",
        score: 9.0,
        reviewShort: "A surprising LCD flagship killer from Ayaneo with a focus on ergonomics.",
        pros: ["144Hz Screen", "Snapdragon G3x Gen 3", "Ergonomic Grip"],
        cons: ["LCD not OLED", "Fan Noise"],
        ytId: "UCh9GxjM-FNuSWv7xqn3UKVw", ytQuery: "ayaneo konkr pocket fit", ytUrl: "https://www.youtube.com/@RyanRetro/search?query=ayaneo%20konkr%20pocket%20fit",
        aliases: ["Konkr Pocket Fit", "Konkr Fit"],
        variants: [{id: "g3xgen3", label: "Snapdragon G3x Gen 3"}]
      },
      "Anbernic RG34XX": {
        name: "Anbernic RG34XX",
        img: "https://raw.githubusercontent.com/IRyzoI/ryanretro/refs/heads/main/images/carousel/rg34xx.png",
        link: "https://s.click.aliexpress.com/e/_c3cp23I9",
        chipset: "Allwinner H700", screen: "3.4\" 720x480 IPS", battery: "3500 mAh", os: "Linux", ram: "1GB", storage: "TF Card",
        score: 9.0,
        reviewShort: "The Game Boy Advance form factor perfected. 3x pixel scaling on a 3:2 screen.",
        pros: ["Perfect GBA Scaling", "Horizontal Design", "Great Price"],
        cons: ["Low RAM", "No Android"],
        ytId: "UCh9GxjM-FNuSWv7xqn3UKVw", ytQuery: "anbernic rg34xx", ytUrl: "https://www.youtube.com/@RyanRetro/search?query=anbernic%20rg34xx",
        aliases: ["RG34XX"],
        variants: [{id: "h700", label: "Allwinner H700"}]
      },
      "MagicX Zero 40": {
        name: "MagicX Zero 40",
        img: "https://raw.githubusercontent.com/IRyzoI/ryanretro/refs/heads/main/images/carousel/magicxzero40.png",
        link: "https://s.click.aliexpress.com/e/_c4EN3p5H",
        chipset: "Allwinner A133P", screen: "4\" 480x800 IPS", battery: "4300 mAh", os: "Android", ram: "2GB", storage: "TF Card",
        score: 8.0,
        reviewShort: "Vertical screen perfection designed specifically for DS emulation.",
        pros: ["Vertical Screen", "Great for DS", "Good Battery"],
        cons: ["Low Resolution", "Weak Chipset"],
        ytId: "UCh9GxjM-FNuSWv7xqn3UKVw", ytQuery: "magicx zero 40", ytUrl: "https://www.youtube.com/@RyanRetro/search?query=magicx%20zero%2040",
        aliases: ["Zero 40"],
        variants: [{id: "a133p", label: "Allwinner A133P"}]
      },
      "MagicX XU20 V32": {
        name: "MagicX XU20 V32",
        img: "https://raw.githubusercontent.com/IRyzoI/ryanretro/refs/heads/main/images/carousel/xuretroxu20v32.png",
        link: "https://s.click.aliexpress.com/e/_c4qAZCof",
        chipset: "Allwinner A133P", screen: "3.2\" 1024x768 IPS", battery: "3200 mAh", os: "Android 10", ram: "2GB", storage: "TF Card",
        score: 7.5,
        reviewShort: "A tiny 4:3 Android handheld. Great resolution for such a small device.",
        pros: ["High Res Screen", "Pocketable", "Cheap Android"],
        cons: ["Old Android 10", "Small Battery"],
        ytId: "UCh9GxjM-FNuSWv7xqn3UKVw", ytQuery: "magicx xu20 v32", ytUrl: "https://www.youtube.com/@RyanRetro/search?query=magicx%20xu20%20v32",
        aliases: ["XU20 V32"],
        variants: [{id: "a133p", label: "Allwinner A133P"}]
      },
      "TrimUI Brick": {
        name: "TrimUI Brick",
        img: "https://raw.githubusercontent.com/IRyzoI/ryanretro/refs/heads/main/images/carousel/brick.png",
        link: "https://www.trimuistore.com/products/trimui-brick-retro-handheld-game-console?sca_ref=9846443.gwM5071BNJJv",
        chipset: "Allwinner A133P", screen: "3.2\" 1024x768 IPS", battery: "3000 mAh", os: "Linux", ram: "1GB", storage: "8GB eMMC",
        score: 8.5,
        reviewShort: "Premium feel, high res screen, and no sticks. A minimalist's dream.",
        pros: ["Premium Build", "High Res Screen", "Simple UI"],
        cons: ["No Joysticks", "Gets Warm"],
        ytId: "UCh9GxjM-FNuSWv7xqn3UKVw", ytQuery: "trimui brick", ytUrl: "https://www.youtube.com/@RyanRetro/search?query=trimui%20brick",
        aliases: ["Smart Brick"],
        variants: [{id: "a133p", label: "Allwinner A133P"}]
      },
      "Vortex F5": {
        name: "Vortex F5",
        img: "https://raw.githubusercontent.com/IRyzoI/ryanretro/refs/heads/main/images/carousel/f5.png",
        link: "https://s.click.aliexpress.com/e/_c42DAswx",
        chipset: "Rockchip RK3566", screen: "5.5\" 720p IPS", battery: "5000 mAh", os: "Linux", ram: "1GB", storage: "8GB",
        score: 7.5,
        reviewShort: "A solid budget Linux handheld with a generous 5.5 inch screen.",
        pros: ["Large Screen", "Comfortable", "Good Battery"],
        cons: ["Older Chipset", "Low RAM"],
        ytId: "UCh9GxjM-FNuSWv7xqn3UKVw", ytQuery: "vortex f5 handheld", ytUrl: "https://www.youtube.com/@RyanRetro/search?query=vortex%20f5",
        aliases: ["QRD Vortex F5"],
        variants: [{id: "rk3566", label: "Rockchip RK3566"}]
      },
      "Mangmi Air X": {
        name: "Mangmi Air X",
        img: "https://raw.githubusercontent.com/IRyzoI/ryanretro/refs/heads/main/images/carousel/mangmiairx.png",
        link: "https://mangmi.com/products/mangmi-air-x?sca_ref=9852375.YfyNu8ytC8akr",
        chipset: "Snapdragon 662", screen: "5.5\" 1080p IPS", battery: "5000 mAh", os: "Android 14", ram: "4GB", storage: "64GB",
        score: 8.0,
        reviewShort: "A budget Android entry with a decent 1080p screen and good ergonomics.",
        pros: ["1080p Screen", "Android 14", "Good Build"],
        cons: ["Weak Chipset", "No Video Out"],
        ytId: "UCh9GxjM-FNuSWv7xqn3UKVw", ytQuery: "mangmi air x", ytUrl: "https://www.youtube.com/@RyanRetro/search?query=mangmi%20air%20x",
        aliases: ["Mangmi X"],
        variants: [{id: "sd662", label: "Snapdragon 662"}]
      },
      "GKD Pixel 2": {
        name: "GKD Pixel 2",
        img: "https://raw.githubusercontent.com/IRyzoI/ryanretro/refs/heads/main/images/carousel/pixel2.png",
        link: "https://www.keepretro.com/",
        chipset: "Rockchip RK3326S", screen: "2.4\" 640x480 IPS", battery: "1800 mAh", os: "Linux", ram: "1GB", storage: "TF Card",
        score: 8.0,
        reviewShort: "The metal micro handheld returns with a much better high-res screen.",
        pros: ["Metal Shell", "640x480 Resolution", "Pocketable"],
        cons: ["Small Screen", "RK3326 Performance"],
        ytId: "UCh9GxjM-FNuSWv7xqn3UKVw", ytQuery: "gkd pixel 2", ytUrl: "https://www.youtube.com/@RyanRetro/search?query=gkd%20pixel%202",
        aliases: ["Pixel 2"],
        variants: [{id: "rk3326s", label: "Rockchip RK3326S"}]
      }
    };

    const SYSTEM_COLORS = {
        switch: ['bg-red-600', 'text-white'],
        ps2: ['bg-blue-600', 'text-white'],
        ps3: ['bg-black', 'text-white'],
        psvita: ['bg-teal-500', 'text-white'],
        winlator: ['bg-sky-500', 'text-white'],
        gamehub: ['bg-blue-900', 'text-white'],
        wiiu: ['bg-blue-600', 'text-white']
    };

    const PERF_COLORS = {
        '': ['bg-white', 'text-brand-bg'], // All
        'Perfect': ['bg-green-600', 'text-white'],
        'Great': ['bg-blue-600', 'text-white'],
        'Playable': ['bg-orange-500', 'text-white'],
        'Unplayable': ['bg-red-600', 'text-white']
    };

    // System Config
    const SYSTEM_CONFIG = {
        switch:{ columns:[
            {key:'game',label:'Game'},{key:'performance',label:'Performance',isStatus:true},
            {key:'driver',label:'Driver'},{key:'emulator',label:'Emulator'},
            {key:'notes',label:'Notes',minWidth:'300px'},{key:'date added',label:'Date'}
        ]},
        ps2:{ columns:[
            {key:'game',label:'Game'},{key:'performance',label:'Performance',isStatus:true},
            {key:'emulator',label:'Emulator'},{key:'resolution',label:'Resolution'},
            {key:'rom region',label:'ROM Region'},{key:'notes',label:'Notes',minWidth:'300px'},
            {key:'date added',label:'Date'}
        ]},
        winlator:{ columns:[
            {key:'game',label:'Game'},{key:'performance',label:'Performance',isStatus:true},
            {key:'winlator version',label:'Winlator Version'},{key:'driver',label:'Driver'},
            {key:'dx wrapper',label:'DX Wrapper'},{key:'notes',label:'Notes',minWidth:'300px'},
            {key:'date added',label:'Date'}
        ]},
        gamehub:{ columns:[
            {key:'game',label:'Game'},{key:'performance',label:'Performance',isStatus:true},
            {key:'game resolution',label:'Game Resolution'},{key:'driver',label:'Driver'},
            {key:'dxvk version',label:'DXVK Version'},{key:'vkd3d version',label:'VKD3D Version'},
            {key:'notes',label:'Notes',minWidth:'300px'},{key:'date added',label:'Date'}
        ]},
        ps3:{ columns:[
            {key:'game',label:'Game'},{key:'performance',label:'Performance',isStatus:true},
            {key:'emulator',label:'Emulator'},{key:'resolution',label:'Resolution'},
            {key:'driver',label:'Driver'},{key:'notes',label:'Notes',minWidth:'300px'},
            {key:'date added',label:'Date'}
        ]},
        psvita:{ columns:[
            {key:'game',label:'Game'},{key:'performance',label:'Performance',isStatus:true},
            {key:'driver',label:'Driver'},{key:'game title id',label:'Game Title ID'},
            {key:'notes',label:'Notes',minWidth:'300px'},{key:'date added',label:'Date'}
        ]},
        wiiu:{ columns:[
            {key:'game',label:'Game'},{key:'performance',label:'Performance',isStatus:true},
            {key:'driver',label:'Driver'},{key:'pre-compiled shaders',label:'Pre-compiled Shaders'},
            {key:'notes',label:'Notes',minWidth:'300px'},{key:'date added',label:'Date'}
        ]}
    };

    const FORM_CONFIG = {
        switch: [
            { key: 'game', label: 'Game', required: true },
            { key: 'performance', label: 'Performance', required: true, type: 'select', suggestions: ['Perfect','Great','Playable','Unplayable'] },
            { key: 'driver', label: 'Driver', required: true },
            { key: 'emulator', label: 'Emulator', required: true }
        ],
        ps2: [
            { key: 'game', label: 'Game', required: true },
            { key: 'performance', label: 'Performance', required: true, type: 'select', suggestions: ['Perfect','Great','Playable','Unplayable'] },
            { key: 'emulator', label: 'Emulator', required: true },
            { key: 'resolution', label: 'Resolution', required: true },
            { key: 'rom region', label: 'ROM Region', required: true }
        ],
        winlator: [
            { key: 'game', label: 'Game', required: true },
            { key: 'performance', label: 'Performance', required: true, type: 'select', suggestions: ['Perfect','Great','Playable','Unplayable'] },
            { key: 'winlator version', label: 'Winlator Version', required: true },
            { key: 'driver', label: 'Driver', required: true },
            { key: 'dx wrapper', label: 'DX Wrapper', required: true }
        ],
        gamehub: [
            { key: 'game', label: 'Game', required: true },
            { key: 'performance', label: 'Performance', required: true, type: 'select', suggestions: ['Perfect','Great','Playable','Unplayable'] },
            { key: 'game resolution', label: 'Game Resolution', required: true },
            { key: 'driver', label: 'Driver', required: true },
            { key: 'dxvk version', label: 'DXVK Version', required: true },
            { key: 'vkd3d version', label: 'VKD3D Version', required: true }
        ],
        ps3: [
            { key: 'game', label: 'Game', required: true },
            { key: 'performance', label: 'Performance', required: true, type: 'select', suggestions: ['Perfect','Great','Playable','Unplayable'] },
            { key: 'emulator', label: 'Emulator', required: true },
            { key: 'resolution', label: 'Resolution', required: true },
            { key: 'driver', label: 'Driver', required: true }
        ],
        psvita: [
            { key: 'game', label: 'Game', required: true },
            { key: 'performance', label: 'Performance', required: true, type: 'select', suggestions: ['Perfect','Great','Playable','Unplayable'] },
            { key: 'driver', label: 'Driver', required: true },
            { key: 'game title id', label: 'Game Title ID', required: true }
        ],
        wiiu: [
            { key: 'game', label: 'Game', required: true },
            { key: 'performance', label: 'Performance', required: true, type: 'select', suggestions: ['Perfect','Great','Playable','Unplayable'] },
            { key: 'driver', label: 'Driver', required: true },
            { key: 'pre-compiled shaders', label: 'Pre-compiled Shaders', required: true, type: 'select', suggestions: ['Yes','No'] }
        ]
    };

    // --- STATE MANAGEMENT ---

    // Resolve device from URL
    const urlParams = new URLSearchParams(location.search);
    const param = (urlParams.get("device") || "").trim().toLowerCase();

    // Fallback if URL param is empty
    let resolvedKey = "Retroid Pocket 5";

    // Find device key
    if (param) {
        for (const key of Object.keys(DEVICE_CONFIG)) {
            const dev = DEVICE_CONFIG[key];
            const names = [key, dev.name, ...(dev.aliases || [])].map(s => s.trim().toLowerCase());
            if (names.includes(param)) {
                resolvedKey = key;
                break;
            }
        }
    }

    let DEVICE = DEVICE_CONFIG[resolvedKey];
    let currentSystemId = 'switch';
    let currentVariant = (DEVICE.variants && DEVICE.variants[0]) || null;
    let activeDataSet = [];
    let currentlyDisplayedGames = [];
    let rowsPerPage = 10;
    let currentPage = 1;
    let sortColumn = SYSTEM_CONFIG['switch'].columns[0].key;
    let sortDirection = 'asc';
    let perfFilter = '';
    let masterDataCache = {};

    const tableBody = document.querySelector('#compatibility-table tbody');
    const tableHead = document.querySelector('#compatibility-table thead');
    const searchBox = document.getElementById('game-search-box');
    const prevBtn = document.getElementById('prev-btn');
    const nextBtn = document.getElementById('next-btn');
    const pageInfo = document.getElementById('page-info');

    // --- PAGE INIT ---
    document.addEventListener('DOMContentLoaded', () => {
        lucide.createIcons();
        AOS.init({ once: true, offset: 50 });

        // 1. Setup Device Stats & Info
        document.getElementById('device-name').textContent = DEVICE.name;
        document.getElementById('device-img').src = DEVICE.img;
        document.getElementById('hidden-device').value = DEVICE.name;

        // Affiliate
        const btn = document.getElementById('affiliate-btn');
        btn.href = DEVICE.link;
        // document.getElementById('channel-link').href = DEVICE.ytUrl;

        // 3. Setup Variant Tabs
        initVariantTabs();

        // 4. Init Compatibility Table
        loadSystemData('switch');
        updatePerfButtons();

        // 5. Fetch Video (Live from API)
        fetchLatestVideo();

        // Mobile Menu
        document.getElementById('mobile-menu-btn').addEventListener('click', () => {
            document.getElementById('mobile-menu').classList.toggle('hidden');
        });
    });

    // --- REAL DATA FETCHING ---
    async function fetchAndCacheData(systemId) {
        if (masterDataCache[systemId]) return masterDataCache[systemId];
        try {
            // Actual API Call to app.py
            const res = await fetch(`/api/compatibility/${systemId}`);
            if (!res.ok) throw new Error("API Error");
            const payload = await res.json();
            const rows = Array.isArray(payload.rows) ? payload.rows : [];
            const normalized = rows.map(r => {
                const o = {};
                for (const k in r) o[k.trim().toLowerCase()] = typeof r[k] === 'string' ? r[k].trim() : r[k];
                return o;
            });
            masterDataCache[systemId] = normalized;
            return normalized;
        } catch (e) {
            console.error("Failed to load data", e);
            // Mock Data if API fails for UI dev
            return [];
        }
    }

    async function fetchLatestVideo() {
        try {
            const channelId = DEVICE.ytId || "UCh9GxjM-FNuSWv7xqn3UKVw";
            const query = DEVICE.ytQuery || DEVICE.name;
            const res = await fetch(`/api/youtube/latest?channel_id=${channelId}&q=${encodeURIComponent(query)}&limit=1`);
            const data = await res.json();

            if (data && data.length > 0) {
                const vid = data[0];
                const embed = document.getElementById('main-video-embed');
                embed.innerHTML = `<iframe src="https://www.youtube.com/embed/${vid.videoId}" class="w-full h-full" frameborder="0" allow="accelerometer; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe>`;
                document.getElementById('video-title').textContent = vid.title;
                const d = new Date(vid.publishedAt);
                document.getElementById('video-date').textContent = d.toLocaleDateString();
            }
        } catch (e) {
            console.log("Video fetch failed", e);
        }
    }

    function initVariantTabs() {
        const wrap = document.getElementById('variant-tabs');
        if (!DEVICE.variants || DEVICE.variants.length <= 1 || !wrap) return;

        wrap.classList.remove('hidden');
        const row = wrap.querySelector('div');
        row.innerHTML = '';

        // Class Constants for Toggling
        const CLASS_ACTIVE = 'bg-white text-brand-bg';
        const CLASS_INACTIVE = 'bg-brand-card hover:bg-brand-hover text-brand-muted hover:text-white';

        DEVICE.variants.forEach((v, i) => {
            const btn = document.createElement('button');
            btn.type = 'button';
            btn.className = [
                'px-3','py-1.5','rounded-md','font-bold','text-xs', 'transition-colors',
                i === 0 ? CLASS_ACTIVE : CLASS_INACTIVE
            ].join(' ');
            btn.textContent = v.label;
            btn.dataset.variantId = v.id;
            row.appendChild(btn);
        });

        row.addEventListener('click', (e) => {
            const btn = e.target.closest('button[data-variant-id]');
            if (!btn) return;
            const id = btn.dataset.variantId;
            const next = DEVICE.variants.find(v => v.id === id);
            if (!next) return;

            // Reset all buttons to inactive class string
            [...row.children].forEach(b => {
                 b.className = `px-3 py-1.5 rounded-md font-bold text-xs transition-colors ${CLASS_INACTIVE}`;
            });
            // Set active button to active class string
            btn.className = `px-3 py-1.5 rounded-md font-bold text-xs transition-colors ${CLASS_ACTIVE}`;

            currentVariant = next;
            loadSystemData(currentSystemId);

            const chipSel = document.getElementById('form-chipset-select');
            if (chipSel) chipSel.value = currentVariant.id;
        });
    }

    async function loadSystemData(systemId) {
        currentSystemId = systemId;
        document.querySelectorAll('.system-btn').forEach(btn => {
            const colors = SYSTEM_COLORS[systemId] || ['bg-white', 'text-brand-bg'];

            // Reset base classes
            btn.className = 'system-btn px-4 py-2 rounded-lg font-bold text-sm bg-brand-bg text-brand-muted hover:text-white hover:bg-brand-hover transition-all';

            if(btn.dataset.system === systemId) {
                // Apply active classes
                btn.classList.remove('bg-brand-bg', 'text-brand-muted', 'hover:bg-brand-hover');
                btn.classList.add(...colors, 'scale-105', 'shadow-lg');
            }
        });

        tableBody.innerHTML = `<tr><td colspan="100" class="p-8 text-center text-brand-muted font-bold"><i data-lucide="loader" class="w-6 h-6 animate-spin mx-auto mb-2 text-white"></i>Loading community reports...</td></tr>`;
        lucide.createIcons();

        // Fetch Real Data
        const allData = await fetchAndCacheData(systemId);

        // Filter by chipset if applicable
        const wantChip = currentVariant ? norm(currentVariant.id) : '';
        let filtered = allData;

        // Only filter by chipset if the CSV actually has chipset data and we have a selected variant
        if (wantChip && allData.some(r => r.chipset)) {
            filtered = allData.filter(r => norm(r.chipset) === wantChip);
        }

        activeDataSet = filtered;
        renderTableStructure();
        applySearchAndSort();
    }

    function renderTableStructure() {
        const config = SYSTEM_CONFIG[currentSystemId] || SYSTEM_CONFIG['switch'];
        tableHead.innerHTML = `<tr>${config.columns.map(col => `<th class="p-4" data-sort="${col.key}">${col.label} <span class="sort-indicator text-[10px] ml-1 opacity-50"></span></th>`).join('')}</tr>`;
    }

    function displayCurrentPage() {
        const startIndex = (currentPage - 1) * rowsPerPage;
        const pageItems = currentlyDisplayedGames.slice(startIndex, startIndex + rowsPerPage);
        const config = SYSTEM_CONFIG[currentSystemId] || SYSTEM_CONFIG['switch'];
        let html = '';

        // Update Sort Indicators
        tableHead.querySelectorAll('th').forEach(th=>{
            const ind = th.querySelector('.sort-indicator');
            if (ind) ind.textContent = (th.dataset.sort === sortColumn) ? (sortDirection === 'asc' ? ' ▲' : ' ▼') : '';
        });

        if (pageItems.length === 0) { html = `<tr><td colspan="100" class="p-6 text-center text-brand-muted font-bold">No results found for this device/filter.</td></tr>`; }
        else {
            pageItems.forEach((row, i) => {
                html += `<tr class="group ${i % 2 === 0 ? 'bg-white/5' : 'bg-transparent'} hover:bg-white/10 transition-colors cursor-pointer" onclick="openGameModal(${startIndex + i})">`;
                config.columns.forEach(col => {
                    let val = row[col.key] || '-';
                    if (col.isStatus) {
                        let badgeStyle = "";
                        if(val === 'Perfect') badgeStyle = "perf-perfect";
                        else if(val === 'Great') badgeStyle = "perf-great";
                        else if(val === 'Playable') badgeStyle = "perf-playable";
                        else if(val === 'Unplayable') badgeStyle = "perf-unplayable";
                        html += `<td class="p-4 font-mono text-xs"><span class="${badgeStyle} px-3 py-1 rounded-full text-[10px] font-bold uppercase tracking-wider inline-block border">${val}</span></td>`;
                    } else { html += `<td class="p-4 font-medium text-sm text-brand-muted group-hover:text-white">${val}</td>`; }
                });
                html += '</tr>';
            });
        }
        tableBody.innerHTML = html;
        const totalPages = Math.ceil(currentlyDisplayedGames.length / rowsPerPage) || 1;
        pageInfo.textContent = `Page ${currentPage} of ${totalPages}`;
        prevBtn.disabled = currentPage === 1;
        nextBtn.disabled = currentPage === totalPages;
        lucide.createIcons();
    }

    const PERFORMANCE_ORDER = { 'Perfect':0, 'Great':1, 'Playable':2, 'Unplayable':3 };
    function getSortValue(row, colKey){
        const raw = (row[colKey] ?? '').toString();
        if (colKey === 'performance') return (raw in PERFORMANCE_ORDER ? PERFORMANCE_ORDER[raw] : 999);
        return raw.toLowerCase();
    }

    function applySearchAndSort() {
        const term = (searchBox.value || '').toLowerCase();
        let filtered = activeDataSet;
        if (perfFilter) filtered = filtered.filter(r => r.performance === perfFilter);
        if (term) filtered = filtered.filter(r => (r.game || '').toLowerCase().includes(term));

        filtered.sort((a,b) => {
            const valA = getSortValue(a, sortColumn);
            const valB = getSortValue(b, sortColumn);
            if(valA < valB) return sortDirection === 'asc' ? -1 : 1;
            if(valA > valB) return sortDirection === 'asc' ? 1 : -1;
            return 0;
        });

        currentlyDisplayedGames = filtered;
        currentPage = 1;
        displayCurrentPage();
    }

    function updatePerfButtons() {
        document.querySelectorAll('.perf-btn').forEach(btn => {
            const type = btn.dataset.perf;
            const colors = PERF_COLORS[type] || ['bg-white', 'text-brand-bg'];

            // Reset base classes
            btn.className = 'perf-btn px-4 py-2 rounded-lg font-bold text-sm bg-brand-bg text-brand-muted hover:text-white hover:bg-brand-hover transition-all';

            if(type === perfFilter) {
                // Apply active classes
                btn.classList.remove('bg-brand-bg', 'text-brand-muted', 'hover:bg-brand-hover');
                btn.classList.add(...colors, 'scale-105', 'shadow-lg');
            }
        });
    }

    // --- GAME DETAILS MODAL LOGIC ---
    function openGameModal(index) {
        const game = currentlyDisplayedGames[index];
        if(!game) return;
        const modal = document.getElementById('game-details-modal');
        const content = document.getElementById('game-modal-content');

        let statusBadge = '';
if(game.performance === 'Perfect') statusBadge = 'perf-perfect';
else if(game.performance === 'Great') statusBadge = 'perf-great';
else if(game.performance === 'Playable') statusBadge = 'perf-playable';
else if(game.performance === 'Unplayable') statusBadge = 'perf-unplayable';

        const config = SYSTEM_CONFIG[currentSystemId];
        const specialFields = ['game', 'performance', 'notes', 'date added', 'date', 'boxArt', 'chipset'];
        const gridFields = config.columns.filter(c => !specialFields.includes(c.key));

        // Simple initial box art logic
        const secondarySearch = `https://tse2.mm.bing.net/th?q=${encodeURIComponent((game.game||'') + ' ' + currentSystemId + ' box art')}&w=400&h=600&c=7&rs=1&p=0`;
        const initials = (game.game||'?').split(' ').map(n=>n[0]).join('').substring(0,2).toUpperCase();
        const fallbackArt = `https://placehold.co/300x450/211136/FFF?text=${initials}`;

        content.innerHTML = `
            <div class="flex flex-col md:flex-row gap-8">
                <div class="w-full md:w-1/3 flex flex-col gap-4">
                    <div class="relative rounded-lg overflow-hidden shadow-2xl border border-white/10 group bg-black">
                        <img src="${secondarySearch}" crossorigin="anonymous" alt="${game.game}" class="w-full h-auto object-cover opacity-90 group-hover:opacity-100 transition-opacity"
                             onError="this.src='${fallbackArt}';">
                    </div>
                </div>
                <div class="w-full md:w-2/3">
                    <div class="mb-6">
                        <h2 class="font-extrabold text-3xl text-white mb-2 leading-tight">${game.game}</h2>
                        <span class="${statusBadge} px-4 py-1.5 rounded-full text-xs font-bold uppercase tracking-wider inline-flex items-center justify-center border">${game.performance}</span>
                    </div>
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 mb-6">
                        ${gridFields.map(col => `<div class="bg-brand-bg/50 px-4 py-3 rounded-xl border border-white/5 flex flex-col justify-center"><p class="text-[10px] text-brand-muted font-bold uppercase mb-1 leading-none opacity-80">${col.label}</p><p class="font-mono text-white text-sm break-words leading-tight">${game[col.key] || '-'}</p></div>`).join('')}
                        ${game.chipset ? `<div class="bg-brand-bg/50 px-4 py-3 rounded-xl border border-white/5 flex flex-col justify-center"><p class="text-[10px] text-brand-muted font-bold uppercase mb-1 leading-none opacity-80">Chipset</p><p class="font-mono text-white text-sm break-words leading-tight">${game.chipset}</p></div>` : ''}
                    </div>
                    ${game.notes ? `<div class="bg-brand-bg/50 p-5 rounded-xl border border-white/10 mb-6"><p class="text-xs text-brand-muted font-bold uppercase mb-2 flex items-center gap-2 opacity-80"><i data-lucide="file-text" class="w-4 h-4"></i> Notes</p><p class="font-sans text-white leading-relaxed text-sm">${game.notes}</p></div>` : ''}
                    <div class="border-t border-white/5 pt-4"><p class="text-[10px] text-brand-muted font-mono">Reported on: ${game['date added'] || 'Unknown'}</p></div>
                </div>
            </div>`;
        modal.classList.remove('hidden');
        lucide.createIcons();
    }

    // --- SCREENSHOT LOGIC ---
    document.getElementById('screenshot-game-modal').addEventListener('click', function() {
        const btn = this;
        const originalIcon = btn.innerHTML;
        btn.innerHTML = `<i data-lucide="loader" class="w-5 h-5 animate-spin"></i> <span class="font-bold text-xs hidden sm:inline">SAVING...</span>`;
        lucide.createIcons();

        const captureContainer = document.createElement('div');
        Object.assign(captureContainer.style, { position: 'fixed', top: '-9999px', left: '-9999px', width: '1000px', backgroundColor: '#2D1B4E', padding: '40px', borderRadius: '20px', zIndex: '-1' });

        captureContainer.innerHTML = `
            <div class="relative bg-[#432C7A] border-2 border-white/20 rounded-3xl p-8 w-full shadow-2xl flex flex-col font-sans">
                <div class="flex gap-8 p-1">
                    <div class="flex flex-col gap-4" style="width: 33%;">${document.querySelector('#game-modal-content .w-full.md\\:w-1\\/3').innerHTML}</div>
                    <div style="width: 67%;">${document.querySelector('#game-modal-content .w-full.md\\:w-2\\/3').innerHTML}</div>
                </div>
                <div class="mt-8 mx-2 pb-2 pt-4 border-t border-white/20 flex justify-between items-center"><div class="flex items-center gap-2"><span class="font-bold text-white text-lg tracking-tight">RYAN RETRO</span></div><span class="font-mono text-white/50 text-xs">ryanretro.com</span></div>
            </div>`;
        document.body.appendChild(captureContainer);

        html2canvas(captureContainer, { backgroundColor: '#2D1B4E', scale: 2, useCORS: true, allowTaint: true, logging: false, width: 1000, windowWidth: 1000 }).then(canvas => {
            document.body.removeChild(captureContainer);
            const link = document.createElement('a');
            link.download = 'RyanRetro-Report.png';
            link.href = canvas.toDataURL('image/png');
            link.click();
            btn.innerHTML = originalIcon;
            lucide.createIcons();
        }).catch(err => { console.error(err); document.body.removeChild(captureContainer); btn.innerHTML = originalIcon; lucide.createIcons(); alert("Capture failed."); });
    });

    // --- EVENT LISTENERS ---
    document.getElementById('close-game-modal').addEventListener('click', () => document.getElementById('game-details-modal').classList.add('hidden'));
    document.getElementById('game-modal-bg').addEventListener('click', () => document.getElementById('game-details-modal').classList.add('hidden'));

    document.getElementById('system-buttons').addEventListener('click', (e) => { if(e.target.dataset.system) loadSystemData(e.target.dataset.system); });
    searchBox.addEventListener('input', () => applySearchAndSort());

    document.getElementById('perf-filters').addEventListener('click', (e) => {
        const btn = e.target.closest('button');
        if(!btn) return;
        perfFilter = btn.dataset.perf;
        updatePerfButtons();
        applySearchAndSort();
    });

    tableHead.addEventListener('click', (e) => {
        const th = e.target.closest('th');
        if(!th) return;
        sortDirection = (sortColumn === th.dataset.sort && sortDirection === 'asc') ? 'desc' : 'asc';
        sortColumn = th.dataset.sort;
        applySearchAndSort();
    });

    prevBtn.addEventListener('click', () => { if(currentPage > 1) { currentPage--; displayCurrentPage(); } });
    nextBtn.addEventListener('click', () => { if(currentPage < Math.ceil(currentlyDisplayedGames.length / rowsPerPage)) { currentPage++; displayCurrentPage(); } });
    document.getElementById('rows-per-page').addEventListener('change', (e) => { rowsPerPage = parseInt(e.target.value); currentPage = 1; displayCurrentPage(); });

    document.getElementById('add-entry-btn').addEventListener('click', () => {
        document.getElementById('add-entry-form-container').classList.remove('hidden');
        document.getElementById('add-entry-form-container').scrollIntoView({behavior:'smooth'});
        // Pre-fill fields
        const currentSys = document.getElementById('form-system-select').value || currentSystemId;
        document.getElementById('form-system-select').value = currentSys;
        updateFormFields(currentSys);
    });
    document.getElementById('cancel-btn').addEventListener('click', () => { document.getElementById('add-entry-form-container').classList.add('hidden'); });

    // --- FORM LOGIC ---
    const formSystemSelect = document.getElementById('form-system-select');
    const dynamicFieldsContainer = document.getElementById('dynamic-fields');

    // 1. PERFORMANCE DROPDOWN COLORING (Moved outside so it only initializes once)
    const perfSelect = document.getElementById('form-performance');
    if (perfSelect) {
        const updateColor = () => {
            perfSelect.className = 'brand-input w-full rounded-lg px-4 py-2 font-bold transition-colors'; // reset base classes
            if (perfSelect.value === 'Perfect') perfSelect.classList.add('text-green-400', 'bg-green-400/10', 'border-green-400/20');
            else if (perfSelect.value === 'Great') perfSelect.classList.add('text-blue-400', 'bg-blue-400/10', 'border-blue-400/20');
            else if (perfSelect.value === 'Playable') perfSelect.classList.add('text-orange-400', 'bg-orange-400/10', 'border-orange-400/20');
            else if (perfSelect.value === 'Unplayable') perfSelect.classList.add('text-red-400', 'bg-red-400/10', 'border-red-400/20');
            else perfSelect.classList.add('text-white');
        };
        perfSelect.addEventListener('change', updateColor);
        updateColor(); // Trigger once on load
    }

    // 2. DYNAMIC FIELDS UPDATE
    function updateFormFields(sysId) {
        dynamicFieldsContainer.innerHTML = '';

        // Generate standard fields based on FORM_CONFIG
        const config = FORM_CONFIG[sysId] || [];
        const fields = config.filter(f => f.key !== 'system' && f.key !== 'game' && f.key !== 'performance');

        // Add fields
        fields.forEach(field => {
            const div = document.createElement('div');
            const req = field.required ? 'required' : '';
            const star = field.required ? '*' : '';
            let inputHtml = '';

            if (field.type === 'select') {
                const options = field.suggestions.map(opt => `<option value="${opt}">${opt}</option>`).join('');
                inputHtml = `<select name="${field.key}" class="brand-input w-full rounded-lg px-4 py-2" ${req}>${options}</select>`;
            } else {
                inputHtml = `<input type="text" name="${field.key}" class="brand-input w-full rounded-lg px-4 py-2" ${req}>`;
            }
            div.innerHTML = `<label class="block text-xs font-bold text-brand-muted mb-1 capitalize">${field.label} ${star}</label>${inputHtml}`;
            dynamicFieldsContainer.appendChild(div);
        });

        // Ensure Chipset Field if device has variants
        if (DEVICE.variants && DEVICE.variants.length > 1) {
            const div = document.createElement('div');
            const options = DEVICE.variants.map(v => `<option value="${v.id}">${v.label}</option>`).join('');
            div.innerHTML = `<label class="block text-xs font-bold text-brand-muted mb-1">Chipset *</label>
                             <select id="form-chipset-select" name="chipset" class="brand-input w-full rounded-lg px-4 py-2" required>${options}</select>`;
            dynamicFieldsContainer.appendChild(div);

            if(currentVariant) {
                document.getElementById('form-chipset-select').value = currentVariant.id;
            }
        }

        document.getElementById('hidden-system').value = sysId;
        document.getElementById('hidden-device').value = DEVICE.name;
    }

    formSystemSelect.addEventListener('change', (e) => updateFormFields(e.target.value));
    updateFormFields('switch');

    // --- SUBMIT LOGIC ---
    const compatForm = document.getElementById('compatibility-form');

    if (compatForm) {
        compatForm.addEventListener('submit', async (e) => {
            e.preventDefault();

            const submitBtn = compatForm.querySelector('button[type="submit"]');
            const originalText = submitBtn.innerHTML;
            submitBtn.disabled = true;
            submitBtn.innerHTML = '<i data-lucide="loader" class="w-4 h-4 animate-spin"></i> Sending...';
            lucide.createIcons();

            const formData = new FormData(compatForm);
            const data = Object.fromEntries(formData.entries());

            data.device = document.getElementById('hidden-device').value || DEVICE.name;

            // Fallback chipset
            if (!data.chipset && currentVariant) {
               data.chipset = currentVariant.id;
            }

            try {
                const res = await fetch('/api/compat/submit', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });

                if (!res.ok) throw new Error("Submission failed");

                showToast("Report added! Refreshing...");

                const sysId = data.system;
                if (masterDataCache[sysId]) delete masterDataCache[sysId];

                document.getElementById('add-entry-form-container').classList.add('hidden');
                compatForm.reset();
                loadSystemData(sysId);

            } catch (err) {
                console.error(err);
                showToast("Error submitting report. Please try again.");
            } finally {
                submitBtn.disabled = false;
                submitBtn.innerHTML = originalText;
                lucide.createIcons();
            }
        });
    }
</script>
</body>
</html>
