{% extends "layout.html" %}

{% block title %}Shop{% endblock %}

{% block head_styles %}
<style>
    @import url('https://fonts.googleapis.com/css2?family=Press+Start+2P&family=Roboto:wght@400;700&display=swap');
    
    /* --- VARIABLES --- */
    :root {
      /* DEFAULT LIGHT MODE */
      --gb-grey: #e0e0e0;
      --gb-dark-grey: #c4c4c4;
      --gb-shadow: #9e9e9e;
      --gb-highlight: #ffffff;
      --gb-accent: #6b7280;
      
      --bg-body: #f0f0f0;
      --text-main: #111827;
      --border-color: #000000;
    }

    /* DARK MODE VARIABLES */
    body.dark-mode {
      --gb-grey: #4b5563;        
      --gb-dark-grey: #111827;   
      --gb-shadow: #000000;      
      --gb-highlight: rgba(255,255,255,0.15); 
      --gb-accent: #9ca3af;
      
      --bg-body: #111827;        
      --text-main: #d1d5db;      
      --border-color: #000000;    
    }

    .retro-font { font-family: 'Press Start 2P', cursive; }
    
    /* BACKGROUND */
    .bg-overlay {
        position: fixed; top: 0; left: 0; right: 0; bottom: 0;
        background: radial-gradient(circle at center, rgba(0,0,0,0) 0%, rgba(0,0,0,0.1) 100%);
        pointer-events: none; z-index: -1;
    }
    
    .pixel-btn { transition: all 0.1s ease; }
    .pixel-btn:active { transform: translate(2px, 2px); box-shadow: 2px 2px 0 rgba(0,0,0,0.2); }
    
    /* ANIMATIONS */
    @keyframes popIn {
        0% { opacity: 0; transform: translateY(10px) scale(0.98); }
        100% { opacity: 1; transform: translateY(0) scale(1); }
    }
    .cart-animate {
        /* Changed to default opacity 1 to prevent invisible items if JS fails */
        opacity: 0; 
        animation: popIn 0.3s cubic-bezier(0.25, 0.46, 0.45, 0.94) forwards;
    }
    
    /* --- GAMEBOY CARTRIDGE STYLES --- */
    .gb-cartridge {
        background-color: var(--gb-grey);
        border-radius: 5px 5px 15px 5px; 
        padding: 12px;
        position: relative;
        box-shadow: 
            inset 3px 3px 5px var(--gb-highlight), 
            inset -3px -3px 5px rgba(0,0,0,0.2),    
            8px 8px 15px rgba(0,0,0,0.3);              
        display: flex; flex-direction: column; height: 100%;
        border-right: 6px solid var(--gb-dark-grey); 
        border-bottom: 6px solid var(--gb-dark-grey); 
        transition: transform 0.2s, background-color 0.3s;
    }

    body.dark-mode .gb-cartridge {
        box-shadow: 
            inset 2px 2px 3px var(--gb-highlight), 
            inset -2px -2px 3px rgba(0,0,0,0.6),    
            0px 15px 25px rgba(0,0,0,0.6); 
    }
    
    .gb-cartridge:hover { transform: translateY(-5px); }

    .gb-header-depression {
        background-color: var(--gb-grey);
        border-radius: 12px 12px 0 0;
        height: 28px; margin-bottom: 12px;
        box-shadow: inset 2px 2px 5px rgba(0,0,0,0.15), inset -1px -1px 2px var(--gb-highlight);
        display: flex; align-items: center; justify-content: center;
        border: 1px solid rgba(0,0,0,0.05); transition: background-color 0.3s;
    }

    body.dark-mode .gb-header-depression {
        box-shadow: inset 3px 3px 6px rgba(0,0,0,0.6), inset -1px -1px 2px rgba(255,255,255,0.1);
        border: none;
    }

    .gb-header-text {
        font-family: sans-serif; font-weight: 900; font-style: italic;
        color: var(--gb-grey); 
        text-shadow: 1px 1px 0 var(--gb-highlight), -1px -1px 0 rgba(0,0,0,0.1);
        font-size: 10px; letter-spacing: 1px;
    }
    
    body.dark-mode .gb-header-text,
    body.dark-mode .big-pak-text {
        color: #e5e7eb !important;
        text-shadow: 2px 2px 0 rgba(0,0,0,0.9), -1px -1px 0 rgba(255,255,255,0.2) !important;
    }

    .gb-sticker {
        background: #222; border-radius: 8px; overflow: hidden; position: relative;
        box-shadow: 1px 1px 3px rgba(0,0,0,0.2); border: 1px solid #999;
        aspect-ratio: 1 / 0.85; flex-shrink: 0; margin-bottom: 10px;
    }
    .gb-sticker img { width: 100%; height: 100%; object-fit: cover; }
    
    .gb-content { flex-grow: 1; display: flex; flex-direction: column; }
    
    /* INSERT BUTTON */
    .gb-insert-btn {
        display: flex; flex-direction: column; align-items: center; justify-content: center;
        margin-top: auto; padding-top: 8px; padding-bottom: 4px; opacity: 0.5;
        transition: all 0.2s; cursor: pointer; border-top: 1px solid transparent;
    }
    .gb-insert-btn:hover {
        opacity: 1; background: rgba(255,255,255,0.3); border-top: 1px solid rgba(255,255,255,0.8); border-radius: 4px;
    }
    body.dark-mode .gb-insert-btn:hover {
        background: rgba(255,255,255,0.1); border-top: 1px solid rgba(255,255,255,0.2);
    }
    
    /* BIG RYAN PAK (MODAL) */
    #bigRyanPak {
        background-color: var(--gb-grey);
        border-radius: 20px 20px 60px 20px; 
        box-shadow: inset 4px 4px 10px var(--gb-highlight), inset -6px -6px 15px rgba(0,0,0,0.2), 0 50px 100px rgba(0,0,0,0.5);
        border-right: 12px solid var(--gb-dark-grey);
        border-bottom: 12px solid var(--gb-dark-grey);
        position: relative; transition: transform 0.4s, background-color 0.3s;
    }
    body.dark-mode #bigRyanPak {
        box-shadow: inset 4px 4px 10px var(--gb-highlight), inset -6px -6px 15px rgba(0,0,0,0.5), 0 50px 100px rgba(0,0,0,0.9);
    }
    .pak-active { transform: translateY(0) !important; }
    
    .big-pak-depression {
        background-color: var(--gb-grey); border-radius: 20px 20px 0 0;
        height: 50px; margin-bottom: 20px;
        box-shadow: inset 3px 3px 8px rgba(0,0,0,0.15), inset -2px -2px 4px var(--gb-highlight);
        display: flex; align-items: center; justify-content: center;
        border: 1px solid rgba(0,0,0,0.05);
    }
    body.dark-mode .big-pak-depression {
        box-shadow: inset 5px 5px 10px rgba(0,0,0,0.6), inset -2px -2px 4px rgba(255,255,255,0.1); border: none;
    }
    .big-pak-text {
        font-family: sans-serif; font-weight: 900; font-style: italic; color: var(--gb-grey);
        text-shadow: 2px 2px 0 var(--gb-highlight), -2px -2px 0 rgba(0,0,0,0.1);
        font-size: 24px; letter-spacing: 4px;
    }
    
    .big-pak-sticker-area {
        background: #111; border-radius: 12px; border: 2px solid #888;
        box-shadow: inset 0 0 20px rgba(0,0,0,0.8); display: flex; flex-direction: column;
        overflow: hidden; position: relative;
    }
    .pak-split-layout { display: flex; flex-direction: column; height: 100%; }
    @media (min-width: 768px) { .pak-split-layout { flex-direction: row; } }
    
    .pak-media-side { flex: 1; background: #000; display: flex; align-items: center; justify-content: center; position: relative; min-height: 250px; border-right: 2px solid #333; }
    .pak-info-side {
        flex: 1; background: #fdfdfd; padding: 24px; overflow-y: auto; display: flex; flex-direction: column; color: #000;
        box-shadow: inset 10px 0 20px rgba(0,0,0,0.05); transition: background-color 0.3s, color 0.3s;
    }
    body.dark-mode .pak-info-side { background-color: #1f2937; color: #d1d5db; }
    
    .retro-select { -webkit-appearance: none; -moz-appearance: none; appearance: none; }
    .no-scrollbar::-webkit-scrollbar { display: none; }
    .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
    
    .c-price { font-family: 'Press Start 2P', cursive; font-size: 0.65rem; color: inherit; margin-right: 1.5rem; width: 100px; text-align: right; flex-shrink: 0; font-weight: bold; }
    
    .link-group { display: flex; flex-direction: column; align-items: center; margin-bottom: 0.5rem; width: 100%; }
    .coupon-badge {
        font-family: 'Press Start 2P', cursive; font-size: 0.6rem; padding: 6px 8px 4px 8px;
        border-left: 1px solid #000; border-right: 1px solid #000; border-bottom: 1px solid #000;
        border-bottom-left-radius: 6px; border-bottom-right-radius: 6px; text-align: center; width: 90%;
        margin-top: -4px; position: relative; z-index: 0; cursor: pointer; display: flex;
        justify-content: center; align-items: center; gap: 6px; transition: transform 0.1s;
    }
    .coupon-badge:hover { transform: translateY(2px); }
    
    /* --- POWER SWITCH --- */
    .power-switch-container { display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 4px; margin-bottom: 8px; width: 100%; }
    .power-switch-track {
        width: 360px; max-width: 100%; height: 32px; background-color: #d1d5db; border-radius: 4px;
        border: 2px solid #9ca3af; position: relative; box-shadow: inset 2px 2px 5px rgba(0,0,0,0.2);
        display: flex; cursor: pointer; overflow: hidden; transition: background-color 0.3s;
    }
    body.dark-mode .power-switch-track { background-color: #4b5563; border-color: #000000; }

    .power-switch-thumb {
        width: 33.33%; height: calc(100% + 2px); background-color: #374151; border-radius: 2px;
        position: absolute; top: -1px; left: 33.33%; transition: left 0.3s, background-color 0.3s;
        box-shadow: 2px 2px 5px rgba(0,0,0,0.3), inset 1px 1px 2px rgba(255,255,255,0.2);
        display: flex; align-items: center; justify-content: center; z-index: 2;
    }
    body.dark-mode .power-switch-thumb { background-color: #1f2937; box-shadow: 2px 2px 5px rgba(0,0,0,0.5), inset 1px 1px 2px rgba(255,255,255,0.05); }

    .thumb-ridges { display: flex; flex-direction: column; gap: 3px; }
    .thumb-ridge { width: 30px; height: 2px; background-color: #1f2937; box-shadow: 0 1px 0 rgba(255,255,255,0.1); }
    .power-label-container { position: absolute; width: 100%; height: 100%; display: flex; justify-content: space-between; pointer-events: none; }
    .power-label {
        font-family: 'Press Start 2P', cursive; font-size: 8px; color: #6b7280;
        transition: all 0.3s; width: 33.33%; z-index: 3; font-weight: bold;
        display: flex; align-items: center; justify-content: center; height: 100%; padding-bottom: 3px;
    }
    body.dark-mode .power-label { color: #9ca3af; }
    .power-label.active { color: #d1d5db; text-shadow: 0 1px 0 rgba(0,0,0,0.5); }
    body.dark-mode .power-label.active { color: #f3f4f6; }

    .switch-title { font-family: 'Press Start 2P', cursive; font-size: 10px; color: #374151; margin-bottom: 2px; display: flex; align-items: center; gap: 6px; }
    body.dark-mode .switch-title { color: #d1d5db; }
    .led-indicator { width: 8px; height: 8px; border-radius: 50%; background: #9ca3af; box-shadow: inset 1px 1px 2px rgba(0,0,0,0.2); transition: background 0.3s; }
    .led-indicator.on { background: #ef4444; box-shadow: 0 0 5px #ef4444, inset -1px -1px 2px rgba(0,0,0,0.2); }

    /* --- FILTER MENU STYLES (CRITICAL FIX) --- */
    .unified-filter-menu {
        display: none; /* Must be none by default */
        position: absolute; 
        top: 100%; left: 0; margin-top: 0.5rem; width: 300px;
        background-color: var(--gb-grey); border: 4px solid #999; z-index: 100;
        box-shadow: 12px 12px 0 rgba(0,0,0,0.2); max-height: 80vh; overflow-y: auto; color: var(--text-main);
    }
    body.dark-mode .unified-filter-menu { border-color: #4b5563; }
    .unified-filter-menu.open { display: block; }
    
    .filter-section-header {
        background: #c0c0c0; padding: 10px 16px; font-family: 'Press Start 2P', cursive; font-size: 9px;
        color: #000; border-bottom: 2px solid #999; letter-spacing: 1px;
        display: flex; justify-content: space-between; align-items: center;
    }
    body.dark-mode .filter-section-header { background: #4b5563; color: #fff; border-bottom-color: #1f2937; }

    .filter-option {
        display: flex; align-items: center; padding: 12px 16px; cursor: pointer; transition: all 0.1s;
        border-bottom: 1px solid #ccc; font-family: 'Press Start 2P', cursive; font-size: 8px; text-transform: uppercase; color: #333;
    }
    body.dark-mode .filter-option { border-bottom-color: #4b5563; color: #d1d5db; }
    .filter-option:hover { background-color: #fff; color: #000; }
    body.dark-mode .filter-option:hover { background-color: #1f2937; color: #fff; }
    .filter-option.active { color: #000; background-color: #fff; font-weight: bold; }
    body.dark-mode .filter-option.active { background-color: #111827; color: #fff; }

    /* Slider styling */
    .retro-slider { -webkit-appearance: none; width: 100%; height: 8px; background: #999; outline: none; border: 2px solid #555; margin: 10px 0; }
    .retro-slider::-webkit-slider-thumb { -webkit-appearance: none; appearance: none; width: 20px; height: 20px; background: #e0e0e0; cursor: pointer; border: 2px solid #000; box-shadow: 2px 2px 0 rgba(0,0,0,0.5); }
    .filter-checkbox, .filter-radio { appearance: none; width: 14px; height: 14px; border: 2px solid #555; background: white; margin-right: 12px; position: relative; cursor: pointer; flex-shrink: 0; }
    .filter-radio { border-radius: 50%; }
    .filter-checkbox:checked, .filter-radio:checked { background: #000; border-color: #000; }
    .filter-checkbox:checked::after { content: '‚úì'; position: absolute; top: -3px; left: 1px; color: #fff; font-weight: bold; font-size: 10px; }
    
    /* --- DARK MODE OVERRIDES --- */
    body.dark-mode #mainControlPanel { background-color: var(--gb-grey) !important; border-color: var(--gb-dark-grey) !important; }
    body.dark-mode .gb-content h3 { color: #fff !important; }
    body.dark-mode .gb-content p { color: #d1d5db !important; }
    body.dark-mode .gb-insert-btn span { color: #d1d5db !important; }
    body.dark-mode svg.fill-black { fill: #fff !important; }
    
    body.dark-mode .bg-yellow-50 { background-color: #362F08 !important; border-color: #facc15 !important; color: #fef08a !important; }
    body.dark-mode .bg-yellow-50 p, body.dark-mode .bg-yellow-50 h3 { color: #fef08a !important; }
    body.dark-mode .bg-yellow-400 { background-color: #facc15 !important; color: #000 !important; }

    body.dark-mode #flashDealsModal .bg-gray-200 { background-color: #374151 !important; border-color: #1f2937 !important; }
    body.dark-mode #flashDealsModal .bg-white { background-color: #1f2937 !important; border-color: #4b5563 !important; color: #fff !important; }
    
    body.dark-mode .bg-gray-100 { background-color: #1f2937 !important; color: #fff !important; }
    body.dark-mode .bg-gray-100:hover { background-color: #374151 !important; }
    body.dark-mode input, body.dark-mode select { background-color: #1f2937 !important; color: #fff !important; border-color: #4b5563 !important; }

    @media (max-width: 768px) {
      .unified-filter-menu { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 90vw; max-width: 320px; box-shadow: 0 0 100px rgba(0,0,0,0.9); border: 4px solid #000; max-height: 80vh; overflow-y: auto; }
      #bigRyanPak { height: 90vh; border-radius: 10px; border-right-width: 6px; border-bottom-width: 6px; }
      .pak-split-layout { flex-direction: column; }
      .pak-media-side { min-height: 200px; flex: 0 0 200px; }
      .power-switch-container { transform: scale(0.95); }
    }
    
    .pixel-border { border: 4px solid #000; box-shadow: 8px 8px 0 rgba(0,0,0,0.2); }
</style>
{% endblock %}

{% block content %}
<div class="bg-overlay"></div>

<div id="ryanBoyModal" class="fixed inset-0 z-[60] hidden flex items-center justify-center pointer-events-none p-4">
  <div class="absolute inset-0 bg-black/90 transition-opacity opacity-0 pointer-events-auto" id="rbBackdrop" onclick="closeRyanBoy()"></div>
  
  <div id="bigRyanPak" class="w-full max-w-5xl h-auto md:h-[650px] flex flex-col pointer-events-auto z-10 transform translate-y-[120%]">
      
      <div class="big-pak-depression">
          <span class="big-pak-text">RYAN BOY</span>
      </div>
      
      <div class="px-4 md:px-8 flex-1 overflow-hidden flex flex-col mb-4">
          <div class="big-pak-sticker-area flex-1">
              <div class="pak-split-layout" id="rbScreenContent">
                  </div>
          </div>
      </div>
      
      <div class="pb-2 flex flex-col items-center justify-center">
          <div class="opacity-30 drop-shadow-md cursor-pointer hover:opacity-50 transition-opacity" onclick="closeRyanBoy()" title="Close Cart">
              <svg width="60" height="60" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" class="fill-black">
                 <path d="M12 21L2 5H22L12 21Z" />
              </svg>
          </div>
      </div>
  </div>
</div>

<section id="mainContentSection" class="py-8 container mx-auto px-4">
  
  <div class="flex justify-end mb-4">
      <button id="openFlashDealsBtn" 
              class="px-3 py-2 bg-yellow-400 hover:bg-yellow-300 text-black rounded pixel-btn retro-font text-[10px] uppercase border-2 border-black flex items-center gap-2 shadow-[2px_2px_0_0_rgba(0,0,0,0.2)]">
          <i data-feather="zap" class="w-4 h-4"></i>
          <span>FLASH DEALS</span>
      </button>
  </div>

  <div class="bg-yellow-50 border-4 border-yellow-400 text-yellow-800 p-4 mb-8 rounded-lg shadow-lg flex flex-col md:flex-row items-center gap-4 text-center md:text-left cart-animate" style="animation-delay: 0.1s;">
      <div class="bg-yellow-400 text-white p-3 rounded-full border-2 border-black shadow-[2px_2px_0_0_rgba(0,0,0,0.1)] flex-shrink-0">
          <i data-feather="heart" class="w-6 h-6 fill-current"></i>
      </div>
      <div class="flex-1">
          <h3 class="retro-font text-xs font-bold mb-1 uppercase">Support The Channel</h3>
          <p class="font-sans text-xs md:text-sm leading-relaxed">
              These are affiliate links. Using them costs you nothing, but it helps me keep buying handhelds to review for you! Thank you for your support! ‚ù§Ô∏è
          </p>
      </div>
  </div>

  <div id="mainControlPanel" class="bg-gray-200 p-6 rounded-lg border-4 border-gray-400 shadow-xl flex flex-col gap-6 transition-colors duration-300">
    
    <div class="power-switch-container">
        <div class="switch-title">
            <div id="powerLed" class="led-indicator on"></div>
            <span>CATEGORY</span>
        </div>
        <div class="power-switch-track" id="powerSwitchTrack">
            <div class="power-label-container">
                <span class="power-label" data-pos="0">HANDHELD</span>
                <span class="power-label active" data-pos="1">ALL</span>
                <span class="power-label" data-pos="2">ACCESSORIES</span>
            </div>
            <div class="power-switch-thumb" id="powerSwitchThumb">
                <div class="thumb-ridges">
                    <div class="thumb-ridge"></div>
                    <div class="thumb-ridge"></div>
                    <div class="thumb-ridge"></div>
                    <div class="thumb-ridge"></div>
                </div>
            </div>
        </div>
    </div>

    <div class="w-full relative" id="searchBarContainer">
      <i data-feather="search" class="absolute left-4 top-1/2 -translate-y-1/2 text-gray-500 w-5 h-5"></i>
      <input type="text" id="searchInput" placeholder="SEARCH GEAR..." 
             class="w-full bg-white border-4 border-gray-400 text-gray-800 text-center px-4 py-4 rounded focus:outline-none focus:border-purple-500 retro-font text-sm uppercase shadow-[inset_2px_2px_5px_rgba(0,0,0,0.1)]">
    </div>
    
    <div class="grid grid-cols-2 md:grid md:grid-cols-3 gap-2 md:gap-4 w-full items-center" id="filterRow">
      <div class="relative w-full md:w-auto md:justify-self-start" id="filterWidget">
          <button id="filterBtn" class="bg-gray-100 hover:bg-white text-black px-4 py-3 rounded pixel-btn retro-font text-[10px] uppercase border-2 border-black flex items-center justify-center gap-2 w-full md:w-auto shadow-[4px_4px_0_0_rgba(0,0,0,0.2)]">
              <i data-feather="filter" class="w-4 h-4"></i>
              <span id="filterBtnText">FILTERS</span>
              <i data-feather="chevron-down" class="w-4 h-4"></i>
          </button>
          
          <div id="filterMenu" class="unified-filter-menu rounded no-scrollbar">
              <div class="filter-section-header">
                  <span>PLAYABLE UP TO</span>
                  <span id="tierLabel" class="text-black">ALL</span>
              </div>
              <div class="px-4 py-3 bg-gray-100 border-b border-gray-300">
                  <input type="range" id="tierRange" min="0" max="4" value="0" step="1" class="retro-slider">
                  <div class="flex justify-between text-[12px] text-gray-600 font-bold retro-font mt-2">
                      <span>ALL</span>
                      <span>PS1</span>
                      <span>GC</span>
                      <span>SW</span>
                      <span>PC</span>
                  </div>
              </div>
              <div class="filter-section-header">
                  <span>BUDGET</span>
                  <span id="budgetLabel" class="text-black">$500</span>
              </div>
              <div class="px-4 py-2 bg-gray-100 border-b border-gray-300">
                  <input type="range" id="budgetRange" min="0" max="500" value="500" step="10" class="retro-slider">
              </div>
              <div class="filter-section-header">AVAILABILITY</div>
              <label class="filter-option">
                  <input type="radio" name="status" class="filter-radio status-opt" value="all" checked>
                  <span>Show All</span>
              </label>
              <label class="filter-option">
                  <input type="radio" name="status" class="filter-radio status-opt" value="available">
                  <span>Available Now</span>
              </label>
              <div class="filter-section-header">CATEGORY</div>
              <label class="filter-option">
                  <input type="radio" name="category" class="filter-radio cat-opt" value="all" checked>
                  <span>All Gear</span>
              </label>
              <label class="filter-option">
                  <input type="radio" name="category" class="filter-radio cat-opt" value="Handhelds">
                  <span>Handhelds</span>
              </label>
              <label class="filter-option">
                  <input type="radio" name="category" class="filter-radio cat-opt" value="Accessories">
                  <span>Accessories</span>
              </label>
              <div class="filter-section-header">BRANDS</div>
              <div id="brandOptionsList"></div>
              <div class="filter-section-header">STORES</div>
              <label class="filter-option">
                  <input type="checkbox" class="filter-checkbox store-opt" value="official">
                  <span>Official Stores</span>
              </label>
              <label class="filter-option">
                  <input type="checkbox" class="filter-checkbox store-opt" value="aliexpress">
                  <span>AliExpress</span>
              </label>
              <label class="filter-option">
                  <input type="checkbox" class="filter-checkbox store-opt" value="amazon">
                  <span>Amazon</span>
              </label>
              <label class="filter-option">
                  <input type="checkbox" class="filter-checkbox store-opt" value="powkiddy">
                  <span>Powkiddy</span>
              </label>
          </div>
      </div>
      
      <div class="relative w-full md:w-auto md:justify-self-center">
        <select id="sortFilter" class="appearance-none bg-gray-100 text-black pl-4 pr-10 py-3 rounded pixel-btn retro-font text-[10px] uppercase border-2 border-black cursor-pointer focus:outline-none focus:border-purple-500 w-full md:w-auto shadow-[4px_4px_0_0_rgba(0,0,0,0.2)]">
          <option value="default">SORT: NEW</option>
          <option value="price-asc">PRICE: LOW ‚¨Ü</option>
          <option value="price-desc">PRICE: HIGH ‚¨á</option>
        </select>
        <i data-feather="chevron-down" class="absolute right-2 top-3.5 w-4 h-4 text-gray-500 pointer-events-none"></i>
      </div>
      
      <div class="relative w-full md:w-auto col-span-2 md:col-span-1 md:justify-self-end">
        <select id="currencyFilter" class="appearance-none bg-gray-100 text-purple-700 font-bold pl-4 pr-10 py-3 rounded pixel-btn retro-font text-[10px] uppercase border-2 border-black cursor-pointer focus:outline-none focus:border-purple-500 w-full md:w-auto shadow-[4px_4px_0_0_rgba(0,0,0,0.2)]">
          <option value="USD">USD $</option>
          <option value="EUR">EUR ‚Ç¨</option>
          <option value="GBP">GBP ¬£</option>
          <option value="KRW">KRW ‚Ç©</option>
          <option value="CAD">CAD $</option>
          <option value="AUD">AUD $</option>
        </select>
        <i data-feather="chevron-down" class="absolute right-2 top-3.5 w-4 h-4 text-gray-500 pointer-events-none"></i>
      </div>
    </div>
  </div>
</section>

<section class="container mx-auto px-4 min-h-[50vh]">
  <div id="productGrid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8 transition-all duration-300">
    </div>
</section>

<template id="productTemplate">
  <div class="gb-cartridge cart-animate">
    <div class="gb-header-depression">
        <span class="gb-header-text">RYAN BOY</span>
    </div>
    <div class="gb-sticker group card-img-wrapper">
      <img src="" alt="" class="product-img transition-transform duration-300 group-hover:scale-105">
    </div>
    <div class="gb-content card-content">
      <h3 class="retro-font text-xs text-black mb-1 leading-tight product-title truncate font-bold">Product Name</h3>
      <p class="text-gray-600 text-[10px] mb-4 flex-1 product-desc line-clamp-2 leading-relaxed">Description goes here.</p>
      
      <div class="space-y-1 product-links"></div>
      
      <button class="gb-insert-btn w-full group">
         <div class="flex flex-col items-center gap-1 opacity-60 group-hover:opacity-100 transition-opacity">
            <span class="retro-font text-[8px] font-bold text-black group-hover:text-purple-600">INSERT CART</span>
            <div class="mt-1">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" class="fill-black group-hover:fill-purple-600 transition-colors">
                    <path d="M12 21L2 5H22L12 21Z" />
                </svg>
            </div>
         </div>
      </button>
    </div>
  </div>
</template>

<div id="flashDealsModal" class="fixed inset-0 z-[80] hidden">
  <div id="flashDealsBackdrop" class="absolute inset-0 bg-black/80 backdrop-blur-sm"></div>
  <div class="absolute inset-0 flex items-center justify-center p-4">
    <div class="bg-gray-200 rounded-lg border-4 border-gray-400 w-full max-w-2xl overflow-hidden relative shadow-2xl flex flex-col max-h-[80vh]">
      <div class="p-4 border-b-4 border-gray-400 flex items-center justify-between bg-red-600 text-white">
        <h2 class="retro-font text-sm uppercase flex items-center gap-2"><i data-feather="zap" class="w-4 h-4"></i> CURRENT FLASH DEALS</h2>
        <button id="closeFlashDeals" class="pixel-btn bg-gray-800 hover:bg-gray-700 text-white px-3 py-2 rounded retro-font text-[10px] border-2 border-white">CLOSE</button>
      </div>
      <div class="p-6 overflow-y-auto no-scrollbar space-y-4" id="flashDealsList">
        </div>
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    // --- MAIN SHOP LOGIC ---
    
    // Tiers: 0=All, 1=PS1, 2=Gamecube, 3=Switch, 4=PC
    const officialProducts = [
    { 
      "id": "rp6", 
      "name": "Retroid Pocket 6", 
      "category": "Handhelds", 
      "releaseDate": "2025-01-15", 
      "badge": "Pre-order üî•", 
      "tier": 3, 
      "image": "https://raw.githubusercontent.com/IRyzoI/ryanretro/main/images/shop/rp6.png", 
      "description": "The new flagship. Snapdragon 8 Gen 2, 5.5\" 1080p 120Hz AMOLED. Available in Ryan Retro Purple!", 
      "links": [
        { "store": "Official", "url": "https://www.goretroid.com/collections/retro-game-system/products/retroid-pocket-6-handheld?sca_ref=7339476.fIz7oKv7uT", "price": 229.00, "currency": "$" }
      ] 
    },
    { 
      "id": "steam_deck", 
      "name": "Steam Deck", 
      "category": "Handhelds", 
      "releaseDate": "2023-11-16", 
      "tier": 4, 
      "image": "https://m.media-amazon.com/images/I/516sb3osGJL._SL1231_.jpg", 
      "description": "The standard for PC handheld gaming. Play your Steam library on the go.", 
      "links": [
        { "store": "Amazon", "url": "https://amzn.to/3XSu5Fe", "price": 559.00, "currency": "$" }
      ] 
    },
    { 
      "id": "rp5", 
      "name": "Retroid Pocket 5", 
      "category": "Handhelds", 
      "releaseDate": "2024-09-01", 
      "tier": 2, 
      "image": "https://raw.githubusercontent.com/IRyzoI/ryanretro/main/images/shop/rp5.png", 
      "description": "Snapdragon 865 power in a premium 5.5\" OLED shell.", 
      "links": [
        { "store": "Official", "url": "https://www.goretroid.com/products/retroid-pocket-5-handheld?sca_ref=7339476.fIz7oKv7uT", "price": 199.00, "currency": "$" }, 
        { "store": "AliExpress", "url": "https://s.click.aliexpress.com/e/_c4PGUhcl", "price": 204.00, "currency": "$" }
      ] 
    },
    { 
      "id": "mangmi_air_x", 
      "name": "Mangmi Air X", 
      "category": "Handhelds", 
      "releaseDate": "2026-01-10", 
      "badge": "New Release ‚ú®", 
      "tier": 3, 
      "image": "https://raw.githubusercontent.com/IRyzoI/ryanretro/main/images/shop/mangmi%20air%20x.png", 
      "description": "A new contender enters the ring. Ultra-lightweight design meets heavy-hitting performance.", 
      "links": [
        { "store": "Official", "url": "https://mangmi.com/products/mangmi-air-x?sca_ref=9852375.YfyNu8ytC8akr", "price": 89.99, "currency": "$" }
      ] 
    },
    { 
      "id": "rp_mini2", 
      "name": "Retroid Pocket Mini V2", 
      "category": "Handhelds", 
      "releaseDate": "2024-08-15", 
      "tier": 2, 
      "image": "https://raw.githubusercontent.com/IRyzoI/ryanretro/main/images/shop/rp%20mini.png", 
      "description": "A compact powerhouse featuring a 3.92\" OLED (1240x1080) and Snapdragon 865.", 
      "links": [
        { "store": "Official", "url": "https://www.goretroid.com/products/retroid-pocket-mini-v2-handheld?sca_ref=7339476.fIz7oKv7uT", "price": 179.00, "currency": "$" }, 
        { "store": "AliExpress", "url": "https://s.click.aliexpress.com/e/_c2viGFHB", "price": 204.00, "currency": "$" }, 
        { "store": "Amazon", "url": "https://amzn.to/4iXk4jH", "price": 229.00, "currency": "$" }
      ] 
    },
    { 
      "id": "ayaneo_pocket_air_mini", 
      "name": "Ayaneo Pocket Air Mini", 
      "category": "Handhelds", 
      "releaseDate": "2025-12-25", 
      "badge": "Premium üíé", 
      "tier": 3, 
      "image": "https://raw.githubusercontent.com/IRyzoI/ryanretro/main/images/shop/ayaneo%20pocket%20air%20mini.png", 
      "description": "Ayaneo's signature OLED quality shrunk down into a pocketable Android form factor.", 
      "links": [
        { "store": "AliExpress", "url": "https://s.click.aliexpress.com/e/_c34ldFrn", "price": 113.49, "currency": "$" }
      ] 
    },
    { 
      "id": "trimui_smart_pro_s", 
      "name": "TrimUI Smart Pro S", 
      "category": "Handhelds", 
      "releaseDate": "2025-12-15", 
      "badge": "Upgrade üöÄ", 
      "tier": 2, 
      "image": "https://raw.githubusercontent.com/IRyzoI/ryanretro/main/images/shop/trimui%20smart%20pro%20s.png", 
      "description": "The 'S' stands for Speed. The sequel to the budget king with improved internals for better PSP emulation.", 
      "links": [
        { "store": "AliExpress", "url": "https://s.click.aliexpress.com/e/_c3d4sfRf", "price": 91.85, "currency": "$" }
      ] 
    },
    { 
      "id": "trimui_smart_pro", 
      "name": "TrimUI Smart Pro", 
      "category": "Handhelds", 
      "releaseDate": "2023-11-01", 
      "tier": 1, 
      "image": "https://raw.githubusercontent.com/IRyzoI/ryanretro/main/images/shop/trimui%20smart%20pro.png", 
      "description": "The 16:9 budget favorite. Excellent screen and ergonomics for wide-screen retro gaming.", 
      "links": [
        { "store": "Amazon", "url": "https://amzn.to/4piaw4j", "price": 89.99, "currency": "$" }, 
        { "store": "AliExpress", "url": "https://s.click.aliexpress.com/e/_c3po77XX", "price": 57.77, "currency": "$" }
      ] 
    },
    { 
      "id": "rp_classic", 
      "name": "Retroid Pocket Classic", 
      "category": "Handhelds", 
      "releaseDate": "2024-11-20", 
      "tier": 2, 
      "image": "https://raw.githubusercontent.com/IRyzoI/ryanretro/main/images/shop/rp%20classic.png", 
      "description": "Vertical nostalgia meets modern power. Snapdragon G1 Gen 2 with a 4-inch OLED screen.", 
      "links": [
        { "store": "Official", "url": "https://www.goretroid.com/products/retroid-pocket-classic?sca_ref=7339476.fIz7oKv7uT", "price": 129.00, "currency": "$" }, 
        { "store": "AliExpress", "url": "https://s.click.aliexpress.com/e/_c3BX5yfb", "price": 171.62, "currency": "$" }
      ] 
    },
    { 
      "id": "rp_flip2", 
      "name": "Retroid Pocket Flip 2", 
      "category": "Handhelds", 
      "releaseDate": "2024-07-01", 
      "tier": 2, 
      "image": "https://raw.githubusercontent.com/IRyzoI/ryanretro/main/images/shop/rp%20flip%202.png", 
      "description": "The clamshell returns. Snapdragon 865 performance.", 
      "links": [
        { "store": "Official", "url": "https://www.goretroid.com/products/retroid-pocket-flip-2?sca_ref=7339476.fIz7oKv7uT", "price": 209.00, "currency": "$" }
      ] 
    },
    { 
      "id": "rpg2", 
      "name": "Retroid Pocket G2 Handheld", 
      "category": "Handhelds", 
      "releaseDate": "2024-12-01", 
      "tier": 3, 
      "image": "https://raw.githubusercontent.com/IRyzoI/ryanretro/main/images/shop/retroid%20pocket%20g2.png", 
      "description": "Premium mid-range Android handheld.", 
      "links": [
        { "store": "Official", "url": "https://www.goretroid.com/products/retroid-pocket-g2-handheld?sca_ref=7339476.fIz7oKv7uT", "price": 219.00, "currency": "$" }, 
        { "store": "AliExpress", "url": "https://s.click.aliexpress.com/e/_c3a6yCjb", "price": 224.00, "currency": "$" }
      ] 
    },
    { 
      "id": "rg34xx", 
      "name": "Anbernic RG34XX", 
      "category": "Handhelds", 
      "releaseDate": "2026-01-05", 
      "badge": "Hot Item üî•", 
      "tier": 1, 
      "image": "https://raw.githubusercontent.com/IRyzoI/ryanretro/main/images/shop/rg34xx.png", 
      "description": "The classic form factor refined. A perfect pocket companion for 8-bit and 16-bit classics.", 
      "links": [
        { "store": "Amazon", "url": "https://amzn.to/49kYAZJ", "price": 79.98, "currency": "$" }, 
        { "store": "AliExpress", "url": "https://s.click.aliexpress.com/e/_c3cp23I9", "price": 67.61, "currency": "$" }
      ] 
    },
    { 
      "id": "miyoo_mini_v4", 
      "name": "Miyoo Mini v4", 
      "category": "Handhelds", 
      "releaseDate": "2023-09-01", 
      "tier": 1, 
      "image": "https://raw.githubusercontent.com/IRyzoI/ryanretro/main/images/shop/miyoo%20mini.png", 
      "description": "Tiny horizontal legend.", 
      "links": [
        { "store": "AliExpress", "url": "https://s.click.aliexpress.com/e/_c3b0uLQt", "price": 51, "currency": "$" }
      ] 
    },
    { 
      "id": "miyoo_mini_plus", 
      "name": "Miyoo Mini Plus", 
      "category": "Handhelds", 
      "releaseDate": "2023-03-01", 
      "tier": 1, 
      "image": "https://raw.githubusercontent.com/IRyzoI/ryanretro/main/images/shop/miyoo%20mini%20plus.png", 
      "description": "The vertical standard.", 
      "links": [
        { "store": "AliExpress", "url": "https://s.click.aliexpress.com/e/_c4n4CCil", "price": 69.57, "currency": "$" }
      ] 
    },
    { 
      "id": "anker_power", 
      "name": "Anker 25000mAh Power Bank", 
      "category": "Accessories", 
      "tier": 0, 
      "image": "https://m.media-amazon.com/images/I/71K65j4IrHL._AC_SL1500_.jpg", 
      "description": "140W fast charging.", 
      "links": [
        { "store": "Amazon", "url": "https://amzn.to/3KJgFII", "price": 109.99, "currency": "$" }
      ] 
    },
    { 
      "id": "ugreen_power", 
      "name": "UGreen 25000mAh Power Bank", 
      "category": "Accessories", 
      "tier": 0, 
      "image": "https://m.media-amazon.com/images/I/61zJaUu71qL._AC_SL1500_.jpg", 
      "description": "Reliable 25k bank.", 
      "links": [
        { "store": "Amazon", "url": "https://amzn.to/44p6Iqm", "price": 89.99, "currency": "$" }
      ] 
    },
    { 
      "id": "ugreen_dock", 
      "name": "UGreen 9-in-1 Dock", 
      "category": "Accessories", 
      "tier": 0, 
      "image": "https://m.media-amazon.com/images/I/71riM53nk3L._AC_SL1500_.jpg", 
      "description": "4K@60Hz HDMI.", 
      "links": [
        { "store": "Amazon", "url": "https://amzn.to/4s2934T", "price": 39.99, "currency": "$" }
      ] 
    },
    { 
      "id": "rp_ds_addon", 
      "name": "Retroid Dual Screen Add-on", 
      "category": "Accessories", 
      "tier": 0, 
      "image": "https://www.goretroid.com/cdn/shop/files/1_22073d25-7a85-49cc-b893-fbc79dc3ae63_1024x1024@2x.jpg?v=1749457811", 
      "description": "AMOLED secondary screen.", 
      "links": [
        { "store": "Official", "url": "https://www.goretroid.com/products/retroid-dual-screen-add-on?sca_ref=7339476.fIz7oKv7uT", "price": 69.00, "currency": "$" }
      ] 
    },
    { 
      "id": "gamesir_g8p", 
      "name": "GameSir G8 Plus", 
      "category": "Accessories", 
      "tier": 0, 
      "image": "https://ae-pic-a1.aliexpress-media.com/kf/S3fe49083af5143dfaf0968cf77d823720.jpg_960x960q75.jpg_.avif", 
      "description": "Ultimate controller.", 
      "links": [
        { "store": "Amazon", "url": "https://amzn.to/4q4zTqZ", "price": 79.99, "currency": "$" }
      ] 
    },
    { 
      "id": "odin3", 
      "name": "AYN Odin 3", 
      "category": "Handhelds", 
      "badge": "Pre-order üî•", 
      "releaseDate": "2025-02-01", 
      "tier": 3, 
      "image": "https://raw.githubusercontent.com/IRyzoI/ryanretro/main/images/shop/odin%203.png", 
      "description": "Snapdragon 8 Elite flagship.", 
      "links": [
        { "store": "Official", "url": "https://www.ayntec.com/products/ayn-odin-3?sca_ref=8254425.fM33Fgl5td", "price": 329.00, "currency": "$" }
      ] 
    },
    { 
      "id": "odin2_portal", 
      "name": "AYN Odin2 Portal", 
      "category": "Handhelds", 
      "releaseDate": "2024-05-15", 
      "tier": 3, 
      "image": "https://raw.githubusercontent.com/IRyzoI/ryanretro/main/images/shop/odin%202%20portal.png", 
      "description": "7-inch OLED powerhouse.", 
      "links": [
        { "store": "Official", "url": "https://www.ayntec.com/products/odin2-portal?sca_ref=8254425.fM33Fgl5td", "price": 329.00, "currency": "$" }
      ] 
    },
    { 
      "id": "ayn_thor", 
      "name": "AYN Thor", 
      "category": "Handhelds", 
      "badge": "Pre-order üî•", 
      "releaseDate": "2025-03-01", 
      "tier": 3, 
      "image": "https://raw.githubusercontent.com/IRyzoI/ryanretro/main/images/shop/thor.png", 
      "description": "Dual-screen OLED clamshell.", 
      "links": [
        { "store": "Official", "url": "https://www.ayntec.com/products/ayn-thor?sca_ref=8254425.fM33Fgl5td", "price": 299.00, "currency": "$" }
      ] 
    },
    { 
      "id": "sd_card", 
      "name": "SanDisk Extreme 512GB", 
      "category": "Accessories", 
      "tier": 0, 
      "image": "https://m.media-amazon.com/images/I/61MRn7f3m2L.jpg", 
      "description": "Reliable library storage.", 
      "links": [
        { "store": "Amazon", "url": "https://amzn.to/44tg0ln", "price": 59.99, "currency": "$" }
      ] 
    },
    { 
      "id": "anbernic_rg477v", 
      "name": "Anbernic RG477V", 
      "category": "Handhelds", 
      "releaseDate": "2025-12-20", 
      "badge": "New Arrival ‚ú®", 
      "tier": 2, 
      "image": "https://raw.githubusercontent.com/IRyzoI/ryanretro/main/images/shop/rg477v.png", 
      "description": "Brand new vertical powerhouse! Get it while it's on discount.", 
      "links": [
        { "store": "AliExpress", "url": "https://s.click.aliexpress.com/e/_c3nmWU5X", "price": 199.00, "currency": "$" }
      ] 
    },
    {
      "id": "trimui_brick_hammer",
      "name": "TrimUI Brick Hammer",
      "category": "Handhelds",
      "releaseDate": "2024-11-15",
      "badge": "Best Value üéÅ",
      "tier": 1,
      "image": "https://raw.githubusercontent.com/IRyzoI/ryanretro/main/images/shop/brick%20hammer.png",
      "description": "The premium metal sensation. CNC aluminum shell with a stunning 3.2\" IPS screen.",
      "links": [
        { "store": "Official", "url": "https://www.trimuistore.com/products/trimui-brick-hammer-handheld-game-console?sca_ref=9846443.gwM5071BNJJv", "price": 80.75, "currency": "$", "coupon": "TRIMUIMC15" },
        { "store": "Amazon", "url": "https://amzn.to/3MBZ1qY", "price": 95.99, "currency": "$" },
        { "store": "PowKiddy", "url": "https://powkiddy.com/products/new-trimui-brick-hammer-handheld-console?ref=ryanretro", "price": 80.75, "currency": "$", "coupon": "RYAN" }
      ]
    },
    {
      "id": "trimui_brick",
      "name": "TrimUI Brick",
      "category": "Handhelds",
      "releaseDate": "2024-10-10",
      "badge": "Best Value üéÅ",
      "tier": 1,
      "image": "https://raw.githubusercontent.com/IRyzoI/ryanretro/main/images/shop/brick.png",
      "description": "Compact vertical perfection. 1024x768 resolution in a lightweight, colorful package.",
      "links": [
        { "store": "Official", "url": "https://www.trimuistore.com/products/trimui-brick-retro-handheld-game-console?sca_ref=9846443.gwM5071BNJJv", "price": 72.75, "currency": "$", "coupon": "TRIMUIMC15" },
        { "store": "Amazon", "url": "https://amzn.to/4j3t2Mw", "price": 73.00, "currency": "$" },
        { "store": "PowKiddy", "url": "https://powkiddy.com/products/trimui-brick-handheld-game-console?ref=ryanretro", "price": 61.75, "currency": "$", "coupon": "RYAN" }
      ]
    }
  ];

  // --- FLASH DEALS ---
  const flashDeals = [
    { title: "Samsung EVO 512GB MicroSD", price: "$34.99", discount: "40% OFF", link: "https://amzn.to/example", store: "Amazon" },
    { title: "Anbernic RG35XX Plus", price: "$55.00", discount: "FLASH SALE", link: "https://aliexpress.com/example", store: "AliExpress", coupon: "RG35XXDEAL" },
    { title: "Miyoo Mini Plus (Purple)", price: "$58.00", discount: "LIMITED STOCK", link: "https://aliexpress.com/example", store: "AliExpress" }
  ];

  let allProducts = JSON.parse(JSON.stringify(officialProducts));
  let currentView = 'grid', currentCurrency = 'USD', currentCategory = 'all', currentStatus = 'all', currentBrand = 'all', currentSort = 'default', currentSearch = '', currentBudget = 500, currentTier = 0;
  let storeFilters = new Set();
   
  // 1. URL ID DETECTION
  let urlParams = new URLSearchParams(window.location.search);
  let explicitId = urlParams.get('id');
  let pathSegment = window.location.pathname.replace(/^\/|\/$/g, ''); 
   
  if (pathSegment === 'store' || pathSegment === 'shop' || pathSegment.includes('.html') || pathSegment.includes('/')) {
      pathSegment = null;
  }
  let urlProductId = explicitId || pathSegment;
  const productExists = allProducts.some(p => p.id === urlProductId);
   
  if (urlProductId && !productExists && !explicitId) {
      console.log("Ignoring invalid path ID:", urlProductId);
      urlProductId = null;
  }

  const tierMap = { 0: "ALL", 1: "PS1", 2: "GAMECUBE", 3: "SWITCH", 4: "PC" };
  const exchangeRates = { USD: 1, EUR: 0.92, GBP: 0.78, KRW: 1375, CAD: 1.36, AUD: 1.52 };
  const currencySymbols = { USD: '$', EUR: '‚Ç¨', GBP: '¬£', KRW: '‚Ç©', CAD: '$', AUD: '$' };
   
  function convertFromUSD(usd, cur) { return cur === 'USD' ? usd : usd * (exchangeRates[cur] || 1); }
  function formatPrice(amt, cur) {
    const sym = currencySymbols[cur] || '$';
    return cur === 'KRW' ? `${sym}${Math.round(amt).toLocaleString()}` : `${sym}${Number(amt).toFixed(2)}`;
  }
  function getCheapestLink(p) {
    const valid = (p.links || []).filter(l => l.price > 0 && l.url !== '#');
    return valid.length ? [...valid].sort((a,b) => a.price - b.price)[0] : null;
  }
  function populateBrandOptions() {
    const list = document.getElementById('brandOptionsList');
    const brands = Array.from(new Set(allProducts.map(p => p.name.split(' ')[0].toUpperCase()))).sort();
    list.innerHTML = `<label class="filter-option"><input type="radio" name="brand" class="filter-radio brand-opt" value="all" checked><span>All Brands</span></label>`;
    brands.forEach(b => list.insertAdjacentHTML('beforeend', `<label class="filter-option"><input type="radio" name="brand" class="filter-radio brand-opt" value="${b}"><span>${b}</span></label>`));
    document.querySelectorAll('.brand-opt').forEach(opt => opt.addEventListener('change', (e) => { currentBrand = e.target.value; updateFilters(); }));
  }
   
  function matchesFilters(p) {
    if (urlProductId) {
        return p.id === urlProductId; 
    }
    if (currentCategory !== 'all' && p.category !== currentCategory) return false;
    const cheapest = getCheapestLink(p);
    if (cheapest && cheapest.price > currentBudget) return false;
    if (currentTier > 0) {
        if (p.category === 'Accessories') return false;
        if (p.category === 'Handhelds' && (p.tier || 0) < currentTier) return false;
    }
    if (currentBrand !== 'all' && !p.name.toUpperCase().startsWith(currentBrand)) return false;
    if (currentStatus === 'available' && (p.badge || '').toLowerCase().includes('pre-order')) return false;
    if (currentSearch && !p.name.toLowerCase().includes(currentSearch.toLowerCase())) return false;
    if (storeFilters.size > 0) {
        const hasStore = (p.links || []).some(l => {
            const s = l.store.toLowerCase();
            if (storeFilters.has('official') && (s.includes('official') || s.includes('goretroid') || s.includes('ayntec'))) return true;
            if (storeFilters.has('aliexpress') && s.includes('ali')) return true;
            if (storeFilters.has('amazon') && s.includes('amazon')) return true;
            if (storeFilters.has('powkiddy') && s.includes('powkiddy')) return true;
            return false;
        });
        if (!hasStore) return false;
    }
    return true;
  }

  function renderProducts() {
    const grid = document.getElementById('productGrid');
    
    // SINGLE VIEW SETUP
    if (urlProductId) {
        const p = allProducts.find(x => x.id === urlProductId);
        grid.className = 'max-w-5xl mx-auto'; 
        grid.innerHTML = '';
        if (p) {
            const card = renderGridCard(p, true);
            grid.appendChild(card);
        } else {
            grid.innerHTML = `
              <div class="col-span-full flex flex-col items-center justify-center py-20 text-center animate-pulse">
                <div class="gb-cartridge w-64 h-64 flex flex-col items-center justify-center mb-6 opacity-50">
                   <i data-feather="alert-octagon" class="w-16 h-16 text-gray-400 mb-2"></i>
                   <span class="retro-font text-[10px] text-gray-500">MISSING CART</span>
                </div>
                <h2 class="retro-font text-xl text-black mb-4">INSERT CARTRIDGE</h2>
                <p class="text-gray-600 text-xs mb-6 max-w-md retro-font leading-relaxed">THE GAME CART YOU ARE LOOKING FOR<br>IS NOT IN THE SLOT.</p>
                <a href="/" class="px-6 py-3 bg-gray-800 text-white rounded pixel-btn retro-font text-xs border-2 border-black hover:bg-gray-700 transition-colors">RETURN TO TITLE</a>
              </div>
            `;
        }
        feather.replace(); 
        return; 
    }

    // NORMAL RENDERING
    const products = allProducts.filter(matchesFilters).sort((a,b) => {
        if(currentSort === 'default') return new Date(b.releaseDate || '2000-01-01') - new Date(a.releaseDate || '2000-01-01');
        const ap = getCheapestLink(a)?.price || Infinity, bp = getCheapestLink(b)?.price || Infinity;
        return currentSort === 'price-asc' ? ap - bp : bp - ap;
    });
    
    grid.className = 'grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-x-4 gap-y-8';
    
    grid.innerHTML = products.length ? '' : `
      <div class="col-span-full flex flex-col items-center justify-center py-20 text-center opacity-70">
         <i data-feather="frown" class="w-12 h-12 text-gray-400 mb-4"></i>
         <div class="text-gray-500 retro-font text-xs">NO GAME CARTS FOUND.</div>
      </div>
    `;
    products.forEach(p => grid.appendChild(renderGridCard(p, false)));
    feather.replace(); 
  }

  function renderGridCard(p, isSingleView = false) {
    const node = document.getElementById('productTemplate').content.firstElementChild.cloneNode(true);
    node.dataset.pid = p.id;
    
    // --- LAYOUT ADJUSTMENT FOR SINGLE VIEW ---
    if (isSingleView) {
        node.classList.remove('flex-col', 'h-full');
        node.classList.add('flex', 'flex-col', 'md:flex-row', 'h-auto', 'md:min-h-[500px]');
        
        const imgContainer = node.querySelector('.group'); 
        imgContainer.classList.add('md:w-1/2', 'shrink-0', 'mr-8');
        
        const contentContainer = node.querySelector('.card-content');
        contentContainer.classList.add('md:w-1/2', 'flex', 'flex-col', 'justify-center', 'p-8');
        
        const title = node.querySelector('.product-title');
        title.classList.replace('text-xs', 'text-2xl');
        title.classList.add('md:text-3xl', 'mb-4');
        
        const desc = node.querySelector('.product-desc');
        desc.classList.replace('text-[10px]', 'text-base');
        desc.classList.add('md:text-lg', 'mb-8');
    } else {
        node.style.cursor = 'pointer';
        node.onclick = (e) => {
            if (e.target.closest('a') || e.target.closest('.coupon-badge') || e.target.closest('.card-img-wrapper')) return;
            openRyanBoy(node);
        };
    }

    node.querySelector('.product-img').src = p.image;
    
    const imgWrapper = node.querySelector('.card-img-wrapper');
    const cheapestLink = getCheapestLink(p);
    
    if (cheapestLink) {
        imgWrapper.style.cursor = 'pointer';
        imgWrapper.setAttribute('title', `Open cheapest deal ($${cheapestLink.price})`);
        imgWrapper.onclick = (e) => {
            e.stopPropagation(); 
            window.open(cheapestLink.url, '_blank');
        };
    }
    node.querySelector('.product-title').textContent = p.name;
    node.querySelector('.product-desc').textContent = p.description;
    
    const linksW = node.querySelector('.product-links');
    
    // SORT LINKS BY PRICE ASCENDING
    const sortedLinks = (p.links || []).sort((a,b) => a.price - b.price);
    
    sortedLinks.forEach(l => {
      let btnBg = 'bg-gray-800 text-white';
      let badgeBg = 'bg-gray-700 text-gray-300';
      const s = l.store.toLowerCase();
      if(s.includes('official') || s.includes('goretroid') || s.includes('ayntec')) {
         btnBg = 'bg-blue-600 text-white hover:bg-blue-500';
         badgeBg = 'bg-blue-800 text-blue-100';
      }
      else if(s.includes('ali')) {
         btnBg = 'bg-red-600 text-white hover:bg-red-500';
         badgeBg = 'bg-red-800 text-red-100';
      }
      else if(s.includes('amazon')) {
         btnBg = 'bg-yellow-500 text-black hover:bg-yellow-400';
         badgeBg = 'bg-yellow-700 text-yellow-100';
      }
      else if(s.includes('powkiddy')) {
         btnBg = 'bg-[#008c69] text-white hover:bg-[#00a87d]';
         badgeBg = 'bg-[#004d3a] text-green-100';
      }
      const couponHtml = l.coupon 
        ? `<div class="coupon-badge ${badgeBg} mt-1 w-fit mx-0" onclick="navigator.clipboard.writeText('${l.coupon}'); alert('Code copied: ${l.coupon}')">
             <span>CODE: ${l.coupon}</span> <i data-feather="clipboard" class="w-3 h-3"></i>
           </div>` 
        : '';

      const wrapperHtml = `
        <div class="link-group">
          <a href="${l.url}" target="_blank" class="${btnBg} px-4 py-3 rounded pixel-btn border-2 border-black flex justify-between items-center group transition-colors shadow-[4px_4px_0_0_rgba(0,0,0,0.2)]">
            <div class="flex flex-col">
                <span class="retro-font text-[10px] uppercase">${l.store}</span>
            </div>
            <span class="retro-font text-xs font-bold">${formatPrice(convertFromUSD(l.price, currentCurrency), currentCurrency)}</span>
          </a>
          ${couponHtml}
        </div>
      `;
      
      linksW.insertAdjacentHTML('beforeend', wrapperHtml);
    });
    return node;
  }
   
  function updateFilters() { const activeC = (currentStatus !== 'all' ? 1 : 0) + (currentCategory !== 'all' ? 1 : 0) + (currentBrand !== 'all' ? 1 : 0) + storeFilters.size + (currentBudget < 500 ? 1 : 0) + (currentTier > 0 ? 1 : 0); document.getElementById('filterBtnText').textContent = activeC > 0 ? `FILTERS (${activeC})` : 'FILTERS'; renderProducts(); }
   
  // --- FLASH DEALS LOGIC ---
  const flashDealsModal = document.getElementById('flashDealsModal');
  const flashDealsList = document.getElementById('flashDealsList');
   
  document.getElementById('openFlashDealsBtn').onclick = () => {
      renderFlashDeals();
      flashDealsModal.classList.remove('hidden');
  };
   
  document.getElementById('closeFlashDeals').onclick = () => {
      flashDealsModal.classList.add('hidden');
  };
   
  document.getElementById('flashDealsBackdrop').onclick = () => {
      flashDealsModal.classList.add('hidden');
  };

  function renderFlashDeals() {
      flashDealsList.innerHTML = '';
      if(flashDeals.length === 0) {
          flashDealsList.innerHTML = '<div class="text-center p-4 retro-font text-xs text-gray-500">NO FLASH DEALS RIGHT NOW. CHECK BACK SOON!</div>';
          return;
      }
      
      flashDeals.forEach(deal => {
          let btnBg = 'bg-gray-800 text-white';
          let badgeBg = 'bg-gray-700 text-gray-300';
          const s = deal.store.toLowerCase();
          
          if(s.includes('official') || s.includes('goretroid') || s.includes('ayntec')) {
             btnBg = 'bg-blue-600 text-white hover:bg-blue-500';
             badgeBg = 'bg-blue-800 text-blue-100';
          }
          else if(s.includes('ali')) {
             btnBg = 'bg-red-600 text-white hover:bg-red-500';
             badgeBg = 'bg-red-800 text-red-100';
          }
          else if(s.includes('amazon')) {
             btnBg = 'bg-yellow-500 text-black hover:bg-yellow-400';
             badgeBg = 'bg-yellow-700 text-yellow-100';
          }
          else if(s.includes('powkiddy')) {
             btnBg = 'bg-[#008c69] text-white hover:bg-[#00a87d]';
             badgeBg = 'bg-[#004d3a] text-green-100';
          }

          const couponHtml = deal.coupon 
            ? `<div class="bg-gray-100 border border-gray-400 px-2 py-1 rounded text-[10px] font-bold text-red-600 flex items-center gap-1 cursor-pointer hover:bg-gray-200" onclick="navigator.clipboard.writeText('${deal.coupon}'); alert('Code copied: ${deal.coupon}')">
                <span>CODE: ${deal.coupon}</span> <i data-feather="clipboard" class="w-3 h-3"></i>
               </div>` 
            : '';

          const itemHtml = `
            <div class="bg-white border-4 border-gray-300 p-4 rounded flex flex-col md:flex-row items-center justify-between gap-4 shadow-sm">
                <div class="flex-1 text-center md:text-left">
                    <h3 class="retro-font text-xs font-bold mb-1">${deal.title}</h3>
                    <div class="flex items-center justify-center md:justify-start gap-2">
                        <span class="bg-red-100 text-red-600 px-2 py-0.5 rounded text-[10px] font-bold uppercase border border-red-200">${deal.discount}</span>
                        ${couponHtml}
                    </div>
                </div>
                <div class="flex flex-col items-end gap-1 w-full md:w-auto">
                    <a href="${deal.link}" target="_blank" class="${btnBg} px-4 py-2 rounded pixel-btn border-2 border-black flex items-center justify-center gap-2 w-full md:w-auto shadow-[2px_2px_0_0_rgba(0,0,0,0.2)]">
                        <span class="retro-font text-[10px] uppercase">${deal.store}</span>
                        <span class="retro-font text-[10px] font-bold bg-black/20 px-2 py-0.5 rounded">${deal.price}</span>
                    </a>
                </div>
            </div>
          `;
          flashDealsList.insertAdjacentHTML('beforeend', itemHtml);
      });
      feather.replace();
  }

  // --- BIG RYAN PAK LOGIC ---
  const rbModal = document.getElementById('ryanBoyModal');
  const rbBackdrop = document.getElementById('rbBackdrop');
  const rbPak = document.getElementById('bigRyanPak');
  const rbScreen = document.getElementById('rbScreenContent');
   
  window.openRyanBoy = (el) => {
    // Find product ID from parent
    const card = el.closest('[data-pid]');
    if(!card) return; // Safety check
    const pid = card.dataset.pid;
    const product = allProducts.find(p => p.id === pid);
    
    if(!product) return;
    
    // Calculate the best link for the image click
    const cheapest = getCheapestLink(product);
    const currentProductLink = cheapest ? cheapest.url : '#';
    
    // Generate Links List HTML
    let linksHtml = '';
    const sortedLinks = (product.links || []).sort((a,b) => a.price - b.price);
    
    sortedLinks.forEach(l => {
        let btnBg = 'bg-gray-800 text-white';
        let badgeBg = 'bg-gray-700 text-gray-300';
        const s = l.store.toLowerCase();
        
        if(s.includes('official') || s.includes('goretroid') || s.includes('ayntec')) {
           btnBg = 'bg-blue-600 text-white hover:bg-blue-500';
           badgeBg = 'bg-blue-800 text-blue-100';
        }
        else if(s.includes('ali')) {
           btnBg = 'bg-red-600 text-white hover:bg-red-500';
           badgeBg = 'bg-red-800 text-red-100';
        }
        else if(s.includes('amazon')) {
           btnBg = 'bg-yellow-500 text-black hover:bg-yellow-400';
           badgeBg = 'bg-yellow-700 text-yellow-100';
        }
        else if(s.includes('powkiddy')) {
           btnBg = 'bg-[#008c69] text-white hover:bg-[#00a87d]';
           badgeBg = 'bg-[#004d3a] text-green-100';
        }

        const couponHtml = l.coupon 
          ? `<div class="coupon-badge ${badgeBg} mt-1 w-fit mx-0" onclick="navigator.clipboard.writeText('${l.coupon}'); alert('Code copied: ${l.coupon}')">
               <span>CODE: ${l.coupon}</span> <i data-feather="clipboard" class="w-3 h-3"></i>
             </div>` 
          : '';

        linksHtml += `
            <div class="mb-3">
                <a href="${l.url}" target="_blank" class="${btnBg} px-4 py-3 rounded pixel-btn border-2 border-black flex justify-between items-center group transition-colors shadow-[4px_4px_0_0_rgba(0,0,0,0.2)]">
                    <div class="flex flex-col">
                        <span class="retro-font text-[10px] uppercase">${l.store}</span>
                    </div>
                    <span class="retro-font text-xs font-bold">${formatPrice(convertFromUSD(l.price, currentCurrency), currentCurrency)}</span>
                </a>
                ${couponHtml}
            </div>
        `;
    });
    // BIG PAK LAYOUT
    rbScreen.innerHTML = `
        <div class="pak-media-side cursor-pointer group relative overflow-hidden" onclick="window.open('${currentProductLink}', '_blank')" title="Visit Store">
            <img src="${product.image}" class="w-full h-full object-cover shadow-2xl transition-transform duration-500 group-hover:scale-105">
            <div class="absolute inset-0 bg-black/0 group-hover:bg-white/10 transition-colors pointer-events-none"></div>
            <div class="absolute bottom-4 right-4 bg-yellow-400 text-black px-3 py-2 text-[10px] retro-font uppercase rounded shadow-lg border-2 border-black transform translate-y-20 group-hover:translate-y-0 transition-transform duration-300 z-10">
                GO TO STORE ‚Üó
            </div>
        </div>
        <div class="pak-info-side">
            <h2 class="text-3xl font-bold font-sans uppercase mb-1 leading-tight tracking-tight">${product.name}</h2>
            <div class="h-1 w-20 bg-black mb-4"></div>
            
            <p class="text-sm text-gray-700 leading-relaxed mb-6 font-medium">
                ${product.description}
            </p>
            
            <div class="mb-6">
                <h3 class="text-[10px] retro-font text-gray-400 mb-3 border-b pb-1">PURCHASE OPTIONS</h3>
                ${linksHtml}
            </div>
            
            <div class="mt-auto">
                <h3 class="text-[10px] retro-font text-gray-400 mb-3 border-b pb-1">RYAN RETRO CHANNEL</h3>
                <a href="https://www.youtube.com/@RyanRetro/search?query=${encodeURIComponent(product.name)}" target="_blank" class="block bg-red-600 hover:bg-red-700 text-white p-4 text-center rounded flex items-center justify-center gap-3 transition-colors shadow-lg group border-2 border-black pixel-btn shadow-[4px_4px_0_0_rgba(0,0,0,0.2)]">
                    <i data-feather="youtube" class="w-6 h-6 group-hover:scale-110 transition-transform"></i>
                    <span class="font-bold text-sm">WATCH VIDEOS</span>
                </a>
            </div>
        </div>
    `;
    feather.replace();
    // Show Modal
    rbModal.classList.remove('hidden');
    
    // Animate In
    setTimeout(() => {
        rbBackdrop.classList.remove('opacity-0');
        rbPak.classList.add('pak-active');
    }, 10);
  };
  window.closeRyanBoy = () => {
    rbPak.classList.remove('pak-active');
    rbBackdrop.classList.add('opacity-0');
    setTimeout(() => {
        rbModal.classList.add('hidden');
    }, 400);
  };
  // --- FILTERS & INIT ---
   
  // Power Switch Logic (Updated for Responsiveness)
  const powerTrack = document.getElementById('powerSwitchTrack');
  const powerThumb = document.getElementById('powerSwitchThumb');
  const powerLed = document.getElementById('powerLed');
  const powerLabels = document.querySelectorAll('.power-label');
   
  powerTrack.addEventListener('click', (e) => {
      const rect = powerTrack.getBoundingClientRect();
      const clickX = e.clientX - rect.left;
      const width = rect.width;
      
      let newPos = 1; // Default to center (ALL)
      
      // Use percentages for click areas (33.33% each)
      if (clickX < (width * 0.33)) newPos = 0; // Handheld
      else if (clickX > (width * 0.66)) newPos = 2; // Accessory
      else newPos = 1; // Center
      
      // Move Thumb using Percentage
      powerThumb.style.left = (newPos * 33.33) + '%'; 
      
      // Update Labels
      powerLabels.forEach(l => l.classList.remove('active'));
      document.querySelector(`.power-label[data-pos="${newPos}"]`).classList.add('active');
      
      // Update LED
      powerLed.classList.add('on');
      
      // Set Logic
      if (newPos === 0) currentCategory = 'Handhelds';
      else if (newPos === 1) currentCategory = 'all';
      else if (newPos === 2) currentCategory = 'Accessories';
      
      // Update Radio Buttons Sync
      const radio = document.querySelector(`.cat-opt[value="${currentCategory}"]`);
      if(radio) radio.checked = true;
      
      updateFilters();
  });
   
  if (urlProductId) {
      document.getElementById('mainControlPanel').style.display = 'none';
      const mainSection = document.getElementById('mainContentSection');
      mainSection.classList.remove('py-8');
      mainSection.classList.add('pt-4', 'pb-8');
  }
  document.getElementById('filterBtn').onclick = (e) => { e.stopPropagation(); document.getElementById('filterMenu').classList.toggle('open'); };
  document.onclick = (e) => { if(!document.getElementById('filterWidget').contains(e.target)) document.getElementById('filterMenu').classList.remove('open'); };
  document.getElementById('budgetRange').oninput = (e) => { currentBudget = parseInt(e.target.value); document.getElementById('budgetLabel').textContent = `$${currentBudget}`; updateFilters(); };
  document.getElementById('tierRange').oninput = (e) => { currentTier = parseInt(e.target.value); document.getElementById('tierLabel').textContent = tierMap[currentTier]; updateFilters(); };
  document.getElementById('sortFilter').onchange = (e) => { currentSort = e.target.value; renderProducts(); };
  document.querySelectorAll('.status-opt, .cat-opt').forEach(o => o.onchange = (e) => { 
      if(o.classList.contains('status-opt')) currentStatus = e.target.value; 
      if(o.classList.contains('cat-opt')) {
          currentCategory = e.target.value; 
          // Sync Power Switch
          let pos = 1;
          if(currentCategory === 'Handhelds') pos = 0;
          if(currentCategory === 'Accessories') pos = 2;
          
          // Use percentage for sync movement
          powerThumb.style.left = (pos * 33.33) + '%';
          
          powerLabels.forEach(l => l.classList.remove('active'));
          document.querySelector(`.power-label[data-pos="${pos}"]`).classList.add('active');
      }
      updateFilters(); 
  });
  document.querySelectorAll('.store-opt').forEach(o => o.onchange = (e) => { e.target.checked ? storeFilters.add(e.target.value) : storeFilters.delete(e.target.value); updateFilters(); });
  document.getElementById('searchInput').oninput = (e) => { currentSearch = e.target.value; renderProducts(); };
  document.getElementById('currencyFilter').onchange = (e) => { currentCurrency = e.target.value; renderProducts(); };

  document.addEventListener('DOMContentLoaded', () => { populateBrandOptions(); renderProducts(); feather.replace(); });
</script>
{% endblock %}
